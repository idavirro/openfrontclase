(()=>{var t,e,i={41234:()=>{},80552:(t,e,i)=>{"use strict";function s(t,e,i){return Math.min(Math.max(t,e),i)}function r(t,e){const i="number"==typeof e?e:e.tile();return(e,s)=>t.manhattanDist(e.tile(),i)-t.manhattanDist(s.tile(),i)}function n(t){let e=0;for(let i=0;i<t.length;i++)e=(e<<5)-e+t.charCodeAt(i),e&=e;return Math.abs(e)}function a(t,e){let i=1/0,s=1/0,r=-1/0,n=-1/0;return e.forEach((e=>{const a=t.cell(e);i=Math.min(i,a.x),s=Math.min(s,a.y),r=Math.max(r,a.x),n=Math.max(n,a.y)})),{min:new G(i,s),max:new G(r,n)}}function o(t,e,i){const s=[],r=t.x(e),n=t.y(e),a=r-i,o=r+i,h=n-i,l=n+i;for(let e=a;e<=o;e++)t.isValidCoord(e,h)&&s.push(t.ref(e,h)),t.isValidCoord(e,l)&&h!==l&&s.push(t.ref(e,l));for(let e=h+1;e<l;e++)t.isValidCoord(a,e)&&s.push(t.ref(a,e)),t.isValidCoord(o,e)&&a!==o&&s.push(t.ref(o,e));return s}function h(t){return new G(t.min.x+Math.floor((t.max.x-t.min.x)/2),t.min.y+Math.floor((t.max.y-t.min.y)/2))}function l(t,e){return t.min.x<=e.min.x&&t.min.y<=e.min.y&&t.max.x>=e.max.x&&t.max.y>=e.max.y}function c(t){return Array.from(t).join("").replace(/[^\p{L}\p{N}\s\p{Emoji}\p{Emoji_Component}[\]_]/gu,"")}function u(t){throw new Error("Unexpected value: "+t)}function d(t){return t===1/0?BigInt(Number.MAX_SAFE_INTEGER):t===-1/0?BigInt(Number.MIN_SAFE_INTEGER):BigInt(Math.floor(t))}function g(t,e){return t<e?t:e}i(99418);const p=[["ðŸ˜€","ðŸ˜Š","ðŸ¥°","ðŸ˜‡","ðŸ˜Ž"],["ðŸ˜ž","ðŸ¥º","ðŸ˜­","ðŸ˜±","ðŸ˜¡"],["ðŸ˜ˆ","ðŸ¤¡","ðŸ–•","ðŸ¥±","ðŸ¤¦â€â™‚ï¸"],["ðŸ‘‹","ðŸ‘","ðŸ¤Œ","ðŸ’ª","ðŸ«¡"],["ðŸ‘","ðŸ‘Ž","â“","ðŸ”","ðŸ€"],["ðŸ¤","ðŸ†˜","ðŸ•Šï¸","ðŸ³ï¸","â³"],["ðŸ”¥","ðŸ’¥","ðŸ’€","â˜¢ï¸","âš ï¸"],["â†–ï¸","â¬†ï¸","â†—ï¸","ðŸ‘‘","ðŸ¥‡"],["â¬…ï¸","ðŸŽ¯","âž¡ï¸","ðŸ¥ˆ","ðŸ¥‰"],["â†™ï¸","â¬‡ï¸","â†˜ï¸","â¤ï¸","ðŸ’”"],["ðŸ’°","âš“","â›µ","ðŸ¡","ðŸ›¡ï¸"]].flat();function m(t,e,i){return 1/(1+Math.exp(-e*(t-i)))}const f="AllPlayers";var y;!function(t){t.Easy="Easy",t.Medium="Medium",t.Hard="Hard",t.Impossible="Impossible"}(y||(y={}));const w="Duos",b="Trios",M="Quads",T="Humans Vs Nations",_="Blue",v="Teal",A="Purple",S="Yellow",k="Orange",E="Green",I="Bot",D="Humans",j="Nations";var C,x,P,R,N,O;!function(t){t.World="World",t.GiantWorldMap="Giant World Map",t.Europe="Europe",t.EuropeClassic="Europe Classic",t.Mena="Mena",t.NorthAmerica="North America",t.SouthAmerica="South America",t.Oceania="Oceania",t.BlackSea="Black Sea",t.Africa="Africa",t.Pangaea="Pangaea",t.Asia="Asia",t.Mars="Mars",t.Britannia="Britannia",t.GatewayToTheAtlantic="Gateway to the Atlantic",t.Australia="Australia",t.Iceland="Iceland",t.EastAsia="East Asia",t.BetweenTwoSeas="Between Two Seas",t.FaroeIslands="Faroe Islands",t.DeglaciatedAntarctica="Deglaciated Antarctica",t.FalklandIslands="Falkland Islands",t.Baikal="Baikal",t.Halkidiki="Halkidiki",t.StraitOfGibraltar="Strait of Gibraltar",t.Italia="Italia",t.Japan="Japan",t.Yenisei="Yenisei",t.Pluto="Pluto",t.Montreal="Montreal",t.Achiran="Achiran",t.BaikalNukeWars="Baikal (Nuke Wars)"}(C||(C={})),C.World,C.GiantWorldMap,C.NorthAmerica,C.SouthAmerica,C.Europe,C.EuropeClassic,C.Asia,C.Africa,C.Oceania,C.BlackSea,C.Britannia,C.GatewayToTheAtlantic,C.BetweenTwoSeas,C.Iceland,C.EastAsia,C.Mena,C.Australia,C.FaroeIslands,C.FalklandIslands,C.Baikal,C.Halkidiki,C.StraitOfGibraltar,C.Italia,C.Japan,C.Yenisei,C.Montreal,C.Pangaea,C.Pluto,C.Mars,C.DeglaciatedAntarctica,C.Achiran,C.BaikalNukeWars,function(t){t.Singleplayer="Singleplayer",t.Public="Public",t.Private="Private"}(x||(x={})),function(t){t.FFA="Free For All",t.Team="Team"}(P||(P={})),function(t){t.Compact="Compact",t.Normal="Normal"}(R||(R={})),function(t){t.TransportShip="Transport",t.Warship="Warship",t.Shell="Shell",t.SAMMissile="SAMMissile",t.Port="Port",t.AtomBomb="Atom Bomb",t.HydrogenBomb="Hydrogen Bomb",t.TradeShip="Trade Ship",t.MissileSilo="Missile Silo",t.DefensePost="Defense Post",t.SAMLauncher="SAM Launcher",t.City="City",t.MIRV="MIRV",t.MIRVWarhead="MIRV Warhead",t.Construction="Construction",t.Train="Train",t.Factory="Factory"}(N||(N={})),function(t){t.Engine="Engine",t.Carriage="Carriage"}(O||(O={}));const B=new Set([N.City,N.Construction,N.DefensePost,N.SAMLauncher,N.MissileSilo,N.Port,N.Factory]);var U,L,F,q,$,H,W;N.AtomBomb,N.HydrogenBomb,N.MIRVWarhead,N.MIRV,function(t){t[t.Hostile=0]="Hostile",t[t.Distrustful=1]="Distrustful",t[t.Neutral=2]="Neutral",t[t.Friendly=3]="Friendly"}(U||(U={}));class V{constructor(t,e,i){this.spawnCell=t,this.strength=e,this.playerInfo=i}}class G{constructor(t,e){this.x=t,this.y=e,this.strRepr=`Cell[${this.x},${this.y}]`}pos(){return{x:this.x,y:this.y}}toString(){return this.strRepr}}!function(t){t[t.Plains=0]="Plains",t[t.Highland=1]="Highland",t[t.Mountain=2]="Mountain",t[t.Lake=3]="Lake",t[t.Ocean=4]="Ocean"}(L||(L={})),function(t){t.Bot="BOT",t.Human="HUMAN",t.FakeHuman="FAKEHUMAN"}(F||(F={}));class z{constructor(t,e,i,s,r){this.name=t,this.playerType=e,this.clientID=i,this.id=s,this.nation=r,this.clan=function(t){if(!t.includes("[")||!t.includes("]"))return null;const e=t.match(/\[([a-zA-Z0-9]{2,5})\]/);return e?e[1].toUpperCase():null}(t)}}function K(t){return t&&"object"==typeof t&&"isUnit"in t&&"function"==typeof t.isUnit&&t.isUnit()}function Y(t,e){const i=e.largestClusterBoundingBox??a(t,e.borderTiles());let s=1;const r=i.max.x-i.min.x,n=i.max.y-i.min.y,o=Math.min(r,n);s=o<25?1:o<50?2:o<100?4:o<250?8:o<500?16:32;const h=function(t,e,i,s){const r={min:{x:Math.floor(i.min.x/s),y:Math.floor(i.min.y/s)},max:{x:Math.floor(i.max.x/s),y:Math.floor(i.max.y/s)}},n=r.max.x-r.min.x+1,a=r.max.y-r.min.y+1,o=Array(n).fill(null).map((()=>Array(a).fill(!1)));for(let i=r.min.x;i<=r.max.x;i++)for(let n=r.min.y;n<=r.max.y;n++){const a=new G(i*s,n*s);if(t.isOnMap(a)){const s=t.ref(a.x,a.y);o[i-r.min.x][n-r.min.y]=t.isLake(s)||t.owner(s)===e||t.hasFallout(s)}}return o}(t,e,i,s),l=function(t){const e=t[0].length,i=t.length,s=new Array(i).fill(0);let r={x:0,y:0,width:0,height:0};for(let n=0;n<e;n++){for(let e=0;e<i;e++)t[e][n]?s[e]++:s[e]=0;const e=X(s);e.width*e.height>r.width*r.height&&(r={x:e.x,y:n-e.height+1,width:e.width,height:e.height})}return r}(h);l.x=l.x*s,l.y=l.y*s,l.width=l.width*s,l.height=l.height*s;let c=new G(Math.floor(l.x+l.width/2+i.min.x),Math.floor(l.y+l.height/2+i.min.y));const u=function(t,e){const i=t.width/e.length*2,s=t.height/3;return Math.min(i,s)}(l,e.name());return c=new G(c.x,c.y-u/3),{x:Math.ceil(c.x),y:Math.ceil(c.y),size:u}}function X(t){const e=[];let i=0,s={x:0,y:0,width:0,height:0};for(let r=0;r<=t.length;r++){const n=r===t.length?0:t[r];for(;e.length>0&&n<t[e[e.length-1]];){const n=t[e.pop()],a=0===e.length?r:r-e[e.length-1]-1;n*a>i&&(i=n*a,s={x:0===e.length?0:e[e.length-1]+1,y:0,width:a,height:n})}e.push(r)}return s}(H=q||(q={}))[H.ATTACK_FAILED=0]="ATTACK_FAILED",H[H.ATTACK_CANCELLED=1]="ATTACK_CANCELLED",H[H.ATTACK_REQUEST=2]="ATTACK_REQUEST",H[H.CONQUERED_PLAYER=3]="CONQUERED_PLAYER",H[H.MIRV_INBOUND=4]="MIRV_INBOUND",H[H.NUKE_INBOUND=5]="NUKE_INBOUND",H[H.HYDROGEN_BOMB_INBOUND=6]="HYDROGEN_BOMB_INBOUND",H[H.NAVAL_INVASION_INBOUND=7]="NAVAL_INVASION_INBOUND",H[H.SAM_MISS=8]="SAM_MISS",H[H.SAM_HIT=9]="SAM_HIT",H[H.CAPTURED_ENEMY_UNIT=10]="CAPTURED_ENEMY_UNIT",H[H.UNIT_CAPTURED_BY_ENEMY=11]="UNIT_CAPTURED_BY_ENEMY",H[H.UNIT_DESTROYED=12]="UNIT_DESTROYED",H[H.ALLIANCE_ACCEPTED=13]="ALLIANCE_ACCEPTED",H[H.ALLIANCE_REJECTED=14]="ALLIANCE_REJECTED",H[H.ALLIANCE_REQUEST=15]="ALLIANCE_REQUEST",H[H.ALLIANCE_BROKEN=16]="ALLIANCE_BROKEN",H[H.ALLIANCE_EXPIRED=17]="ALLIANCE_EXPIRED",H[H.SENT_GOLD_TO_PLAYER=18]="SENT_GOLD_TO_PLAYER",H[H.RECEIVED_GOLD_FROM_PLAYER=19]="RECEIVED_GOLD_FROM_PLAYER",H[H.RECEIVED_GOLD_FROM_TRADE=20]="RECEIVED_GOLD_FROM_TRADE",H[H.SENT_TROOPS_TO_PLAYER=21]="SENT_TROOPS_TO_PLAYER",H[H.RECEIVED_TROOPS_FROM_PLAYER=22]="RECEIVED_TROOPS_FROM_PLAYER",H[H.CHAT=23]="CHAT",H[H.RENEW_ALLIANCE=24]="RENEW_ALLIANCE",function(t){t.ATTACK="ATTACK",t.NUKE="NUKE",t.ALLIANCE="ALLIANCE",t.TRADE="TRADE",t.CHAT="CHAT"}($||($={})),q.ATTACK_FAILED,$.ATTACK,q.ATTACK_CANCELLED,$.ATTACK,q.ATTACK_REQUEST,$.ATTACK,q.CONQUERED_PLAYER,$.ATTACK,q.MIRV_INBOUND,$.NUKE,q.NUKE_INBOUND,$.NUKE,q.HYDROGEN_BOMB_INBOUND,$.NUKE,q.NAVAL_INVASION_INBOUND,$.ATTACK,q.SAM_MISS,$.ATTACK,q.SAM_HIT,$.ATTACK,q.CAPTURED_ENEMY_UNIT,$.ATTACK,q.UNIT_CAPTURED_BY_ENEMY,$.ATTACK,q.UNIT_DESTROYED,$.ATTACK,q.ALLIANCE_ACCEPTED,$.ALLIANCE,q.ALLIANCE_REJECTED,$.ALLIANCE,q.ALLIANCE_REQUEST,$.ALLIANCE,q.ALLIANCE_BROKEN,$.ALLIANCE,q.ALLIANCE_EXPIRED,$.ALLIANCE,q.RENEW_ALLIANCE,$.ALLIANCE,q.SENT_GOLD_TO_PLAYER,$.TRADE,q.RECEIVED_GOLD_FROM_PLAYER,$.TRADE,q.RECEIVED_GOLD_FROM_TRADE,$.TRADE,q.SENT_TROOPS_TO_PLAYER,$.TRADE,q.RECEIVED_TROOPS_FROM_PLAYER,$.TRADE,q.CHAT,$.CHAT,function(t){t[t.Dev=0]="Dev",t[t.Preprod=1]="Preprod",t[t.Prod=2]="Prod"}(W||(W={}));var Q=i(88399),J=i(73371),Z=i(83640),tt=i(7391),et=i.n(tt);class it{constructor(t){this.rng=et()(String(t))}next(){return this.rng()}nextInt(t,e){return Math.floor(this.rng()*(e-t))+t}nextFloat(t,e){return this.rng()*(e-t)+t}nextID(){return Math.floor(this.rng()*it.POW36_8).toString(36).padStart(8,"0")}randElement(t){if(0===t.length)throw new Error("array must not be empty");return t[this.nextInt(0,t.length)]}randFromSet(t){const e=t.size;if(0===e)throw new Error("set must not be empty");const i=this.nextInt(0,e);let s=0;for(const e of t){if(s===i)return e;s++}throw new Error("Unexpected error selecting element from set")}chance(t){return 0===this.nextInt(0,t)}shuffleArray(t){const e=[...t];for(let t=e.length-1;t>0;t--){const i=this.nextInt(0,t+1);[e[t],e[i]]=[e[i],e[t]]}return e}}it.POW36_8=Math.pow(36,8);var st=i(20008),rt=i(9908),nt=i(94792);(0,Z.X$)([rt.A]),(0,Z.X$)([st.A]);const at=(0,Z.Mj)("rgb(235,51,51)"),ot=(0,Z.Mj)("rgb(41,98,255)"),ht=(0,Z.Mj)("rgb(43,212,189)"),lt=(0,Z.Mj)("rgb(146,52,234)"),ct=(0,Z.Mj)("rgb(231,176,8)"),ut=(0,Z.Mj)("rgb(249,116,21)"),dt=(0,Z.Mj)("rgb(65,190,82)"),gt=(0,Z.Mj)("rgb(209,205,199)"),pt=_t(at),mt=_t(ot),ft=_t(ht),yt=_t(lt),wt=_t(ct),bt=_t(ut),Mt=_t(dt),Tt=[gt];function _t(t){const e=t.toHsl();return Array.from({length:64},((t,i)=>{const s=i/63,r=e.s*(1-.3*s),n=Math.min(100,e.l+30*s);return(0,Z.Mj)({h:e.h,s:r,l:n})}))}const vt=[(0,Z.Mj)("rgb(230,100,100)"),(0,Z.Mj)("rgb(100,180,230)"),(0,Z.Mj)("rgb(230,180,80)"),(0,Z.Mj)("rgb(180,100,230)"),(0,Z.Mj)("rgb(80,200,120)"),(0,Z.Mj)("rgb(230,130,180)"),(0,Z.Mj)("rgb(100,160,80)"),(0,Z.Mj)("rgb(230,150,100)"),(0,Z.Mj)("rgb(80,130,190)"),(0,Z.Mj)("rgb(210,210,100)"),(0,Z.Mj)("rgb(190,100,130)"),(0,Z.Mj)("rgb(100,210,210)"),(0,Z.Mj)("rgb(210,140,80)"),(0,Z.Mj)("rgb(150,110,190)"),(0,Z.Mj)("rgb(180,210,120)"),(0,Z.Mj)("rgb(210,100,160)"),(0,Z.Mj)("rgb(100,140,110)"),(0,Z.Mj)("rgb(230,180,180)"),(0,Z.Mj)("rgb(120,120,190)"),(0,Z.Mj)("rgb(190,170,100)"),(0,Z.Mj)("rgb(100,180,160)"),(0,Z.Mj)("rgb(210,160,200)"),(0,Z.Mj)("rgb(170,190,100)"),(0,Z.Mj)("rgb(100,130,150)"),(0,Z.Mj)("rgb(230,140,140)"),(0,Z.Mj)("rgb(140,180,220)"),(0,Z.Mj)("rgb(200,160,110)"),(0,Z.Mj)("rgb(180,130,180)"),(0,Z.Mj)("rgb(130,200,130)"),(0,Z.Mj)("rgb(220,120,120)"),(0,Z.Mj)("rgb(120,160,200)"),(0,Z.Mj)("rgb(200,200,140)"),(0,Z.Mj)("rgb(160,120,160)"),(0,Z.Mj)("rgb(140,180,140)"),(0,Z.Mj)("rgb(200,130,110)"),(0,Z.Mj)("rgb(130,170,190)"),(0,Z.Mj)("rgb(190,180,160)"),(0,Z.Mj)("rgb(170,140,190)"),(0,Z.Mj)("rgb(160,190,160)"),(0,Z.Mj)("rgb(190,150,130)"),(0,Z.Mj)("rgb(140,150,180)"),(0,Z.Mj)("rgb(180,170,140)"),(0,Z.Mj)("rgb(150,130,150)"),(0,Z.Mj)("rgb(170,190,180)"),(0,Z.Mj)("rgb(190,140,150)"),(0,Z.Mj)("rgb(130,180,170)"),(0,Z.Mj)("rgb(180,160,180)"),(0,Z.Mj)("rgb(160,180,140)"),(0,Z.Mj)("rgb(170,150,170)"),(0,Z.Mj)("rgb(100,180,230)"),(0,Z.Mj)("rgb(230,180,80)"),(0,Z.Mj)("rgb(180,100,230)"),(0,Z.Mj)("rgb(80,200,120)"),(0,Z.Mj)("rgb(230,130,180)"),(0,Z.Mj)("rgb(100,160,80)"),(0,Z.Mj)("rgb(230,150,100)"),(0,Z.Mj)("rgb(80,130,190)"),(0,Z.Mj)("rgb(210,210,100)"),(0,Z.Mj)("rgb(190,100,130)"),(0,Z.Mj)("rgb(100,210,210)"),(0,Z.Mj)("rgb(210,140,80)"),(0,Z.Mj)("rgb(150,110,190)"),(0,Z.Mj)("rgb(180,210,120)"),(0,Z.Mj)("rgb(210,100,160)"),(0,Z.Mj)("rgb(100,140,110)"),(0,Z.Mj)("rgb(230,180,180)"),(0,Z.Mj)("rgb(120,120,190)"),(0,Z.Mj)("rgb(190,170,100)"),(0,Z.Mj)("rgb(100,180,160)"),(0,Z.Mj)("rgb(210,160,200)"),(0,Z.Mj)("rgb(170,190,100)"),(0,Z.Mj)("rgb(100,130,150)"),(0,Z.Mj)("rgb(230,140,140)"),(0,Z.Mj)("rgb(140,180,220)"),(0,Z.Mj)("rgb(200,160,110)"),(0,Z.Mj)("rgb(180,130,180)"),(0,Z.Mj)("rgb(130,200,130)"),(0,Z.Mj)("rgb(220,120,120)"),(0,Z.Mj)("rgb(120,160,200)"),(0,Z.Mj)("rgb(200,200,140)"),(0,Z.Mj)("rgb(160,120,160)"),(0,Z.Mj)("rgb(140,180,140)"),(0,Z.Mj)("rgb(200,130,110)"),(0,Z.Mj)("rgb(130,170,190)"),(0,Z.Mj)("rgb(190,180,160)"),(0,Z.Mj)("rgb(170,140,190)"),(0,Z.Mj)("rgb(160,190,160)"),(0,Z.Mj)("rgb(190,150,130)"),(0,Z.Mj)("rgb(140,150,180)"),(0,Z.Mj)("rgb(180,170,140)"),(0,Z.Mj)("rgb(150,130,150)"),(0,Z.Mj)("rgb(170,190,180)"),(0,Z.Mj)("rgb(190,140,150)"),(0,Z.Mj)("rgb(130,180,170)"),(0,Z.Mj)("rgb(180,160,180)"),(0,Z.Mj)("rgb(160,180,140)"),(0,Z.Mj)("rgb(170,150,170)")],At=[(0,Z.Mj)("rgb(16,185,129)"),(0,Z.Mj)("rgb(34,197,94)"),(0,Z.Mj)("rgb(45,212,191)"),(0,Z.Mj)("rgb(48,178,180)"),(0,Z.Mj)("rgb(52,211,153)"),(0,Z.Mj)("rgb(56,189,248)"),(0,Z.Mj)("rgb(59,130,246)"),(0,Z.Mj)("rgb(67,190,84)"),(0,Z.Mj)("rgb(74,222,128)"),(0,Z.Mj)("rgb(79,70,229)"),(0,Z.Mj)("rgb(82,183,136)"),(0,Z.Mj)("rgb(96,165,250)"),(0,Z.Mj)("rgb(99,202,253)"),(0,Z.Mj)("rgb(110,231,183)"),(0,Z.Mj)("rgb(124,58,237)"),(0,Z.Mj)("rgb(125,211,252)"),(0,Z.Mj)("rgb(132,204,22)"),(0,Z.Mj)("rgb(133,77,14)"),(0,Z.Mj)("rgb(134,239,172)"),(0,Z.Mj)("rgb(147,51,234)"),(0,Z.Mj)("rgb(147,197,253)"),(0,Z.Mj)("rgb(151,255,187)"),(0,Z.Mj)("rgb(163,230,53)"),(0,Z.Mj)("rgb(167,139,250)"),(0,Z.Mj)("rgb(168,85,247)"),(0,Z.Mj)("rgb(179,136,255)"),(0,Z.Mj)("rgb(186,255,201)"),(0,Z.Mj)("rgb(190,92,251)"),(0,Z.Mj)("rgb(192,132,252)"),(0,Z.Mj)("rgb(202,138,4)"),(0,Z.Mj)("rgb(202,225,255)"),(0,Z.Mj)("rgb(204,204,255)"),(0,Z.Mj)("rgb(217,70,239)"),(0,Z.Mj)("rgb(220,38,38)"),(0,Z.Mj)("rgb(220,220,255)"),(0,Z.Mj)("rgb(220,240,250)"),(0,Z.Mj)("rgb(230,250,210)"),(0,Z.Mj)("rgb(230,255,250)"),(0,Z.Mj)("rgb(233,213,255)"),(0,Z.Mj)("rgb(234,88,12)"),(0,Z.Mj)("rgb(234,179,8)"),(0,Z.Mj)("rgb(235,75,75)"),(0,Z.Mj)("rgb(236,72,153)"),(0,Z.Mj)("rgb(239,68,68)"),(0,Z.Mj)("rgb(240,171,252)"),(0,Z.Mj)("rgb(240,240,200)"),(0,Z.Mj)("rgb(244,114,182)"),(0,Z.Mj)("rgb(245,101,101)"),(0,Z.Mj)("rgb(245,158,11)"),(0,Z.Mj)("rgb(248,113,113)"),(0,Z.Mj)("rgb(249,115,22)"),(0,Z.Mj)("rgb(250,215,225)"),(0,Z.Mj)("rgb(250,250,210)"),(0,Z.Mj)("rgb(251,113,133)"),(0,Z.Mj)("rgb(251,146,60)"),(0,Z.Mj)("rgb(251,191,36)"),(0,Z.Mj)("rgb(251,235,245)"),(0,Z.Mj)("rgb(252,165,165)"),(0,Z.Mj)("rgb(252,211,77)"),(0,Z.Mj)("rgb(253,164,175)"),(0,Z.Mj)("rgb(255,204,229)"),(0,Z.Mj)("rgb(255,223,186)"),(0,Z.Mj)("rgb(255,240,200)")],St=[(0,Z.Mj)("rgb(190,120,120)"),(0,Z.Mj)("rgb(120,160,190)"),(0,Z.Mj)("rgb(190,160,100)"),(0,Z.Mj)("rgb(160,120,190)"),(0,Z.Mj)("rgb(100,170,130)"),(0,Z.Mj)("rgb(190,130,160)"),(0,Z.Mj)("rgb(120,150,100)"),(0,Z.Mj)("rgb(190,140,120)"),(0,Z.Mj)("rgb(100,120,160)"),(0,Z.Mj)("rgb(170,170,120)"),(0,Z.Mj)("rgb(160,120,130)"),(0,Z.Mj)("rgb(120,170,170)"),(0,Z.Mj)("rgb(170,140,100)"),(0,Z.Mj)("rgb(140,120,160)"),(0,Z.Mj)("rgb(150,170,130)"),(0,Z.Mj)("rgb(170,120,140)"),(0,Z.Mj)("rgb(120,140,120)"),(0,Z.Mj)("rgb(180,160,160)"),(0,Z.Mj)("rgb(130,130,160)"),(0,Z.Mj)("rgb(160,150,120)"),(0,Z.Mj)("rgb(120,160,150)"),(0,Z.Mj)("rgb(170,150,170)"),(0,Z.Mj)("rgb(150,160,120)"),(0,Z.Mj)("rgb(120,130,140)"),(0,Z.Mj)("rgb(180,140,140)"),(0,Z.Mj)("rgb(140,160,170)"),(0,Z.Mj)("rgb(170,150,130)"),(0,Z.Mj)("rgb(160,130,160)"),(0,Z.Mj)("rgb(130,170,130)"),(0,Z.Mj)("rgb(170,130,130)"),(0,Z.Mj)("rgb(130,150,170)"),(0,Z.Mj)("rgb(170,170,140)"),(0,Z.Mj)("rgb(150,130,150)"),(0,Z.Mj)("rgb(140,160,140)"),(0,Z.Mj)("rgb(170,130,120)"),(0,Z.Mj)("rgb(130,150,160)"),(0,Z.Mj)("rgb(160,160,150)"),(0,Z.Mj)("rgb(150,140,160)"),(0,Z.Mj)("rgb(150,170,150)"),(0,Z.Mj)("rgb(160,140,130)"),(0,Z.Mj)("rgb(140,150,160)"),(0,Z.Mj)("rgb(160,150,140)"),(0,Z.Mj)("rgb(140,130,140)"),(0,Z.Mj)("rgb(150,160,160)"),(0,Z.Mj)("rgb(160,140,150)"),(0,Z.Mj)("rgb(130,160,150)"),(0,Z.Mj)("rgb(160,150,160)"),(0,Z.Mj)("rgb(150,160,140)"),(0,Z.Mj)("rgb(150,140,150)")],kt=[(0,Z.Mj)("rgb(35,0,0)"),(0,Z.Mj)("rgb(45,0,0)"),(0,Z.Mj)("rgb(55,0,0)"),(0,Z.Mj)("rgb(65,0,0)"),(0,Z.Mj)("rgb(75,0,0)"),(0,Z.Mj)("rgb(85,0,0)"),(0,Z.Mj)("rgb(95,0,0)"),(0,Z.Mj)("rgb(105,0,0)"),(0,Z.Mj)("rgb(115,0,0)"),(0,Z.Mj)("rgb(125,0,0)"),(0,Z.Mj)("rgb(135,0,0)"),(0,Z.Mj)("rgb(145,0,0)"),(0,Z.Mj)("rgb(155,0,0)"),(0,Z.Mj)("rgb(165,0,0)"),(0,Z.Mj)("rgb(175,0,0)"),(0,Z.Mj)("rgb(185,0,0)"),(0,Z.Mj)("rgb(195,0,5)"),(0,Z.Mj)("rgb(205,0,10)"),(0,Z.Mj)("rgb(215,0,15)"),(0,Z.Mj)("rgb(225,0,20)"),(0,Z.Mj)("rgb(235,0,25)"),(0,Z.Mj)("rgb(245,0,30)"),(0,Z.Mj)("rgb(255,0,35)"),(0,Z.Mj)("rgb(255,10,45)"),(0,Z.Mj)("rgb(255,20,55)"),(0,Z.Mj)("rgb(255,30,65)"),(0,Z.Mj)("rgb(255,40,75)"),(0,Z.Mj)("rgb(255,50,85)"),(0,Z.Mj)("rgb(255,60,95)"),(0,Z.Mj)("rgb(255,70,105)"),(0,Z.Mj)("rgb(255,80,115)"),(0,Z.Mj)("rgb(255,90,125)"),(0,Z.Mj)("rgb(255,100,135)"),(0,Z.Mj)("rgb(255,110,145)"),(0,Z.Mj)("rgb(255,120,155)"),(0,Z.Mj)("rgb(255,130,165)"),(0,Z.Mj)("rgb(255,140,175)"),(0,Z.Mj)("rgb(255,150,185)"),(0,Z.Mj)("rgb(255,160,195)"),(0,Z.Mj)("rgb(255,170,205)"),(0,Z.Mj)("rgb(255,180,215)"),(0,Z.Mj)("rgb(255,190,225)"),(0,Z.Mj)("rgb(255,200,235)"),(0,Z.Mj)("rgb(0,45,0)"),(0,Z.Mj)("rgb(0,55,0)"),(0,Z.Mj)("rgb(0,65,0)"),(0,Z.Mj)("rgb(0,75,0)"),(0,Z.Mj)("rgb(0,85,0)"),(0,Z.Mj)("rgb(0,95,0)"),(0,Z.Mj)("rgb(0,105,0)"),(0,Z.Mj)("rgb(0,115,0)"),(0,Z.Mj)("rgb(0,125,0)"),(0,Z.Mj)("rgb(0,135,0)"),(0,Z.Mj)("rgb(0,145,0)"),(0,Z.Mj)("rgb(0,155,0)"),(0,Z.Mj)("rgb(0,165,0)"),(0,Z.Mj)("rgb(0,175,0)"),(0,Z.Mj)("rgb(0,185,0)"),(0,Z.Mj)("rgb(0,195,5)"),(0,Z.Mj)("rgb(0,205,10)"),(0,Z.Mj)("rgb(0,215,15)"),(0,Z.Mj)("rgb(0,225,20)"),(0,Z.Mj)("rgb(0,235,25)"),(0,Z.Mj)("rgb(0,245,30)"),(0,Z.Mj)("rgb(0,255,35)"),(0,Z.Mj)("rgb(10,255,45)"),(0,Z.Mj)("rgb(20,255,55)"),(0,Z.Mj)("rgb(30,255,65)"),(0,Z.Mj)("rgb(40,255,75)"),(0,Z.Mj)("rgb(50,255,85)"),(0,Z.Mj)("rgb(60,255,95)"),(0,Z.Mj)("rgb(70,255,105)"),(0,Z.Mj)("rgb(80,255,115)"),(0,Z.Mj)("rgb(90,255,125)"),(0,Z.Mj)("rgb(100,255,135)"),(0,Z.Mj)("rgb(110,255,145)"),(0,Z.Mj)("rgb(120,255,155)"),(0,Z.Mj)("rgb(130,255,165)"),(0,Z.Mj)("rgb(140,255,175)"),(0,Z.Mj)("rgb(150,255,185)"),(0,Z.Mj)("rgb(160,255,195)"),(0,Z.Mj)("rgb(170,255,205)"),(0,Z.Mj)("rgb(180,255,215)"),(0,Z.Mj)("rgb(190,255,225)"),(0,Z.Mj)("rgb(200,255,235)"),(0,Z.Mj)("rgb(0,0,35)"),(0,Z.Mj)("rgb(0,0,45)"),(0,Z.Mj)("rgb(0,0,55)"),(0,Z.Mj)("rgb(0,0,65)"),(0,Z.Mj)("rgb(0,0,75)"),(0,Z.Mj)("rgb(0,0,85)"),(0,Z.Mj)("rgb(0,0,95)"),(0,Z.Mj)("rgb(0,0,105)"),(0,Z.Mj)("rgb(0,0,115)"),(0,Z.Mj)("rgb(0,0,125)"),(0,Z.Mj)("rgb(0,0,135)"),(0,Z.Mj)("rgb(0,0,145)"),(0,Z.Mj)("rgb(0,0,155)"),(0,Z.Mj)("rgb(0,0,165)"),(0,Z.Mj)("rgb(0,0,175)"),(0,Z.Mj)("rgb(0,0,185)"),(0,Z.Mj)("rgb(5,0,195)"),(0,Z.Mj)("rgb(10,0,205)"),(0,Z.Mj)("rgb(15,0,215)"),(0,Z.Mj)("rgb(20,0,225)"),(0,Z.Mj)("rgb(25,0,235)"),(0,Z.Mj)("rgb(30,0,245)"),(0,Z.Mj)("rgb(35,0,255)"),(0,Z.Mj)("rgb(45,10,255)"),(0,Z.Mj)("rgb(55,20,255)"),(0,Z.Mj)("rgb(65,30,255)"),(0,Z.Mj)("rgb(75,40,255)"),(0,Z.Mj)("rgb(85,50,255)"),(0,Z.Mj)("rgb(95,60,255)"),(0,Z.Mj)("rgb(105,70,255)"),(0,Z.Mj)("rgb(115,80,255)"),(0,Z.Mj)("rgb(125,90,255)"),(0,Z.Mj)("rgb(135,100,255)"),(0,Z.Mj)("rgb(145,110,255)"),(0,Z.Mj)("rgb(155,120,255)"),(0,Z.Mj)("rgb(165,130,255)"),(0,Z.Mj)("rgb(175,140,255)"),(0,Z.Mj)("rgb(185,150,255)"),(0,Z.Mj)("rgb(195,160,255)"),(0,Z.Mj)("rgb(205,170,255)"),(0,Z.Mj)("rgb(215,180,255)"),(0,Z.Mj)("rgb(225,190,255)"),(0,Z.Mj)("rgb(235,200,255)"),(0,Z.Mj)("rgb(35,0,35)"),(0,Z.Mj)("rgb(45,0,45)"),(0,Z.Mj)("rgb(55,0,55)"),(0,Z.Mj)("rgb(65,0,65)"),(0,Z.Mj)("rgb(75,0,75)"),(0,Z.Mj)("rgb(85,0,85)"),(0,Z.Mj)("rgb(95,0,95)"),(0,Z.Mj)("rgb(105,0,105)"),(0,Z.Mj)("rgb(115,0,115)"),(0,Z.Mj)("rgb(125,0,125)"),(0,Z.Mj)("rgb(135,0,135)"),(0,Z.Mj)("rgb(145,0,145)"),(0,Z.Mj)("rgb(155,0,155)"),(0,Z.Mj)("rgb(165,0,165)"),(0,Z.Mj)("rgb(175,0,175)"),(0,Z.Mj)("rgb(185,0,185)"),(0,Z.Mj)("rgb(195,5,195)"),(0,Z.Mj)("rgb(205,10,205)"),(0,Z.Mj)("rgb(215,15,215)"),(0,Z.Mj)("rgb(225,20,225)"),(0,Z.Mj)("rgb(235,25,235)"),(0,Z.Mj)("rgb(245,30,245)"),(0,Z.Mj)("rgb(255,35,255)"),(0,Z.Mj)("rgb(255,45,255)"),(0,Z.Mj)("rgb(255,55,255)"),(0,Z.Mj)("rgb(255,65,255)"),(0,Z.Mj)("rgb(255,75,255)"),(0,Z.Mj)("rgb(255,85,255)"),(0,Z.Mj)("rgb(255,95,255)"),(0,Z.Mj)("rgb(255,105,255)"),(0,Z.Mj)("rgb(255,115,255)"),(0,Z.Mj)("rgb(255,125,255)"),(0,Z.Mj)("rgb(255,135,255)"),(0,Z.Mj)("rgb(255,145,255)"),(0,Z.Mj)("rgb(255,155,255)"),(0,Z.Mj)("rgb(255,165,255)"),(0,Z.Mj)("rgb(255,175,255)"),(0,Z.Mj)("rgb(255,185,255)"),(0,Z.Mj)("rgb(255,195,255)"),(0,Z.Mj)("rgb(255,205,255)"),(0,Z.Mj)("rgb(255,215,255)"),(0,Z.Mj)("rgb(0,35,35)"),(0,Z.Mj)("rgb(0,45,45)"),(0,Z.Mj)("rgb(0,55,55)"),(0,Z.Mj)("rgb(0,65,65)"),(0,Z.Mj)("rgb(0,75,75)"),(0,Z.Mj)("rgb(0,85,85)"),(0,Z.Mj)("rgb(0,95,95)"),(0,Z.Mj)("rgb(0,105,105)"),(0,Z.Mj)("rgb(0,115,115)"),(0,Z.Mj)("rgb(0,125,125)"),(0,Z.Mj)("rgb(0,135,135)"),(0,Z.Mj)("rgb(0,145,145)"),(0,Z.Mj)("rgb(0,155,155)"),(0,Z.Mj)("rgb(0,165,165)"),(0,Z.Mj)("rgb(0,175,175)"),(0,Z.Mj)("rgb(0,185,185)"),(0,Z.Mj)("rgb(5,195,195)"),(0,Z.Mj)("rgb(10,205,205)"),(0,Z.Mj)("rgb(15,215,215)"),(0,Z.Mj)("rgb(20,225,225)"),(0,Z.Mj)("rgb(25,235,235)"),(0,Z.Mj)("rgb(30,245,245)"),(0,Z.Mj)("rgb(35,255,255)"),(0,Z.Mj)("rgb(45,255,255)"),(0,Z.Mj)("rgb(55,255,255)"),(0,Z.Mj)("rgb(65,255,255)"),(0,Z.Mj)("rgb(75,255,255)"),(0,Z.Mj)("rgb(85,255,255)"),(0,Z.Mj)("rgb(95,255,255)"),(0,Z.Mj)("rgb(105,255,255)"),(0,Z.Mj)("rgb(115,255,255)"),(0,Z.Mj)("rgb(125,255,255)"),(0,Z.Mj)("rgb(135,255,255)"),(0,Z.Mj)("rgb(145,255,255)"),(0,Z.Mj)("rgb(155,255,255)"),(0,Z.Mj)("rgb(165,255,255)"),(0,Z.Mj)("rgb(175,255,255)"),(0,Z.Mj)("rgb(185,255,255)"),(0,Z.Mj)("rgb(195,255,255)"),(0,Z.Mj)("rgb(205,255,255)"),(0,Z.Mj)("rgb(215,255,255)"),(0,Z.Mj)("rgb(35,35,0)"),(0,Z.Mj)("rgb(45,45,0)"),(0,Z.Mj)("rgb(55,55,0)"),(0,Z.Mj)("rgb(65,65,0)"),(0,Z.Mj)("rgb(75,75,0)"),(0,Z.Mj)("rgb(85,85,0)"),(0,Z.Mj)("rgb(95,95,0)"),(0,Z.Mj)("rgb(105,105,0)"),(0,Z.Mj)("rgb(115,115,0)"),(0,Z.Mj)("rgb(125,125,0)"),(0,Z.Mj)("rgb(135,135,0)"),(0,Z.Mj)("rgb(145,145,0)"),(0,Z.Mj)("rgb(155,155,0)"),(0,Z.Mj)("rgb(165,165,0)"),(0,Z.Mj)("rgb(175,175,0)"),(0,Z.Mj)("rgb(185,185,0)"),(0,Z.Mj)("rgb(195,195,5)"),(0,Z.Mj)("rgb(205,205,10)"),(0,Z.Mj)("rgb(215,215,15)"),(0,Z.Mj)("rgb(225,225,20)"),(0,Z.Mj)("rgb(235,235,25)"),(0,Z.Mj)("rgb(245,245,30)"),(0,Z.Mj)("rgb(255,255,35)"),(0,Z.Mj)("rgb(255,255,45)"),(0,Z.Mj)("rgb(255,255,55)"),(0,Z.Mj)("rgb(255,255,65)"),(0,Z.Mj)("rgb(255,255,75)"),(0,Z.Mj)("rgb(255,255,85)"),(0,Z.Mj)("rgb(255,255,95)"),(0,Z.Mj)("rgb(255,255,105)"),(0,Z.Mj)("rgb(255,255,115)"),(0,Z.Mj)("rgb(255,255,125)"),(0,Z.Mj)("rgb(255,255,135)"),(0,Z.Mj)("rgb(255,255,145)"),(0,Z.Mj)("rgb(255,255,155)"),(0,Z.Mj)("rgb(255,255,165)"),(0,Z.Mj)("rgb(255,255,175)"),(0,Z.Mj)("rgb(255,255,185)"),(0,Z.Mj)("rgb(255,255,195)"),(0,Z.Mj)("rgb(255,255,205)"),(0,Z.Mj)("rgb(255,255,215)"),(0,Z.Mj)("rgb(215,255,200)"),(0,Z.Mj)("rgb(225,255,175)"),(0,Z.Mj)("rgb(240,250,160)"),(0,Z.Mj)("rgb(245,245,175)"),(0,Z.Mj)("rgb(150,200,255)"),(0,Z.Mj)("rgb(160,215,255)"),(0,Z.Mj)("rgb(170,225,255)"),(0,Z.Mj)("rgb(180,235,250)"),(0,Z.Mj)("rgb(190,245,240)"),(0,Z.Mj)("rgb(210,255,245)"),(0,Z.Mj)("rgb(220,255,255)"),(0,Z.Mj)("rgb(230,250,255)"),(0,Z.Mj)("rgb(240,240,255)"),(0,Z.Mj)("rgb(250,230,255)"),(0,Z.Mj)("rgb(170,190,255)"),(0,Z.Mj)("rgb(180,180,255)"),(0,Z.Mj)("rgb(200,170,255)"),(0,Z.Mj)("rgb(190,140,195)"),(0,Z.Mj)("rgb(195,145,200)"),(0,Z.Mj)("rgb(200,150,205)"),(0,Z.Mj)("rgb(205,155,210)"),(0,Z.Mj)("rgb(210,160,215)"),(0,Z.Mj)("rgb(215,165,220)"),(0,Z.Mj)("rgb(220,170,225)"),(0,Z.Mj)("rgb(225,175,230)"),(0,Z.Mj)("rgb(230,180,235)"),(0,Z.Mj)("rgb(235,185,240)"),(0,Z.Mj)("rgb(240,190,245)"),(0,Z.Mj)("rgb(245,195,250)"),(0,Z.Mj)("rgb(250,200,255)"),(0,Z.Mj)("rgb(255,205,255)"),(0,Z.Mj)("rgb(255,210,255)"),(0,Z.Mj)("rgb(255,210,250)"),(0,Z.Mj)("rgb(255,205,245)"),(0,Z.Mj)("rgb(255,215,245)"),(0,Z.Mj)("rgb(220,160,255)"),(0,Z.Mj)("rgb(235,150,255)"),(0,Z.Mj)("rgb(245,160,240)"),(0,Z.Mj)("rgb(255,170,225)"),(0,Z.Mj)("rgb(255,185,215)"),(0,Z.Mj)("rgb(255,195,235)"),(0,Z.Mj)("rgb(255,200,220)"),(0,Z.Mj)("rgb(255,210,230)"),(0,Z.Mj)("rgb(255,220,235)"),(0,Z.Mj)("rgb(255,220,250)"),(0,Z.Mj)("rgb(255,225,255)"),(0,Z.Mj)("rgb(255,230,245)"),(0,Z.Mj)("rgb(255,235,235)"),(0,Z.Mj)("rgb(255,215,195)"),(0,Z.Mj)("rgb(255,225,180)"),(0,Z.Mj)("rgb(255,230,190)"),(0,Z.Mj)("rgb(255,235,200)"),(0,Z.Mj)("rgb(255,245,210)"),(0,Z.Mj)("rgb(255,240,220)")];(0,Z.X$)([rt.A]),(0,Z.X$)([st.A]);class Et{constructor(t,e){this.assigned=new Map,this.teamPlayerColors=new Map,this.availableColors=[...t],this.fallbackColors=[...t,...e]}getTeamColorVariations(t){switch(t){case _:return mt;case"Red":return pt;case v:return ft;case A:return yt;case S:return wt;case k:return bt;case E:return Mt;case I:return Tt;case D:return mt;case j:return pt;default:return[this.assignColor(t)]}}assignColor(t){if(this.assigned.has(t))return this.assigned.get(t);0===this.availableColors.length&&(this.availableColors=[...this.fallbackColors]);let e=0;if(0===this.assigned.size||this.assigned.size>50)e=new it(n(t)).nextInt(0,this.availableColors.length);else{const t=Array.from(this.assigned.values());e=function(t,e){if(0===e.length)throw new Error("No assigned colors");const i=e.map(Dt);let s=0,r=0;for(let e=0;e<t.length;e++){const n=It(Dt(t[e]),i);n>s&&(s=n,r=e)}return r}(this.availableColors,t)??0}const i=this.availableColors.splice(e,1)[0];return this.assigned.set(t,i),i}assignTeamColor(t){const e=this.getTeamColorVariations(t)[0].toRgb();return e.r=Math.round(e.r),e.g=Math.round(e.g),e.b=Math.round(e.b),(0,Z.Mj)(e)}assignTeamPlayerColor(t,e){if(this.teamPlayerColors.has(e))return this.teamPlayerColors.get(e);const i=this.getTeamColorVariations(t),s=i[n(e)%i.length];return this.teamPlayerColors.set(e,s),s}}function It(t,e){return e.reduce(((e,i)=>{return Math.min(e,(s=i,t.deltaE(s,"2000")));var s}),1/0)}function Dt(t){const e=t.toLab();return new nt.A("lab",[e.l,e.a,e.b])}class jt{constructor(){this.borderColorCache=new Map,this.rand=new it(123),this.humanColorAllocator=new Et(At,kt),this.botColorAllocator=new Et(St,St),this.teamColorAllocator=new Et(At,kt),this.nationColorAllocator=new Et(vt,vt),this.background=(0,Z.Mj)("rgb(60,60,60)"),this.shore=(0,Z.Mj)("rgb(204,203,158)"),this.falloutColors=[(0,Z.Mj)("rgb(120,255,71)"),(0,Z.Mj)("rgb(130,255,85)"),(0,Z.Mj)("rgb(110,245,65)"),(0,Z.Mj)("rgb(125,255,75)"),(0,Z.Mj)("rgb(115,250,68)")],this.water=(0,Z.Mj)("rgb(70,132,180)"),this.shorelineWater=(0,Z.Mj)("rgb(100,143,255)"),this._selfColor=(0,Z.Mj)("rgb(0,255,0)"),this._allyColor=(0,Z.Mj)("rgb(255,255,0)"),this._neutralColor=(0,Z.Mj)("rgb(128,128,128)"),this._enemyColor=(0,Z.Mj)("rgb(255,0,0)"),this._spawnHighlightColor=(0,Z.Mj)("rgb(255,213,79)"),this._spawnHighlightSelfColor=(0,Z.Mj)("rgb(255,255,255)"),this._spawnHighlightTeamColor=(0,Z.Mj)("rgb(0,255,0)"),this._spawnHighlightEnemyColor=(0,Z.Mj)("rgb(255,0,0)")}teamColor(t){return this.teamColorAllocator.assignTeamColor(t)}territoryColor(t){const e=t.team();return null!==e?this.teamColorAllocator.assignTeamPlayerColor(e,t.id()):t.type()===F.Human?this.humanColorAllocator.assignColor(t.id()):t.type()===F.Bot?this.botColorAllocator.assignColor(t.id()):this.nationColorAllocator.assignColor(t.id())}borderColor(t){return t.darken(.125)}defendedBorderColors(t){return{light:t.darken(.2),dark:t.darken(.4)}}focusedBorderColor(){return(0,Z.Mj)("rgb(230,230,230)")}textColor(t){return t.type()===F.Human?"#000000":"#4D4D4D"}terrainColor(t,e){const i=t.magnitude(e);if(t.isShore(e))return this.shore;switch(t.terrainType(e)){case L.Ocean:case L.Lake:{const s=this.water.rgba;return t.isShoreline(e)&&t.isWater(e)?this.shorelineWater:(0,Z.Mj)({r:Math.max(s.r-10+(11-Math.min(i,10)),0),g:Math.max(s.g-10+(11-Math.min(i,10)),0),b:Math.max(s.b-10+(11-Math.min(i,10)),0)})}case L.Plains:return(0,Z.Mj)({r:190,g:220-2*i,b:138});case L.Highland:return(0,Z.Mj)({r:200+2*i,g:183+2*i,b:138+2*i});case L.Mountain:return(0,Z.Mj)({r:230+i/2,g:230+i/2,b:230+i/2})}}backgroundColor(){return this.background}falloutColor(){return this.rand.randElement(this.falloutColors)}font(){return"Overpass, sans-serif"}selfColor(){return this._selfColor}allyColor(){return this._allyColor}neutralColor(){return this._neutralColor}enemyColor(){return this._enemyColor}spawnHighlightColor(){return this._spawnHighlightColor}spawnHighlightSelfColor(){return this._spawnHighlightSelfColor}spawnHighlightTeamColor(){return this._spawnHighlightTeamColor}spawnHighlightEnemyColor(){return this._spawnHighlightEnemyColor}}class Ct extends jt{constructor(){super(...arguments),this.darkShore=(0,Z.Mj)("rgb(134,133,88)"),this.darkWater=(0,Z.Mj)("rgb(14,11,30)"),this.darkShorelineWater=(0,Z.Mj)("rgb(50,50,50)")}terrainColor(t,e){const i=t.magnitude(e);if(t.isShore(e))return this.darkShore;switch(t.terrainType(e)){case L.Ocean:case L.Lake:{const s=this.darkWater.rgba;return t.isShoreline(e)&&t.isWater(e)?this.darkShorelineWater:t.magnitude(e)<10?(0,Z.Mj)({r:Math.max(s.r+9-i,0),g:Math.max(s.g+9-i,0),b:Math.max(s.b+9-i,0)}):this.darkWater}case L.Plains:return(0,Z.Mj)({r:140,g:170-2*i,b:88});case L.Highland:return(0,Z.Mj)({r:150+2*i,g:133+2*i,b:88+2*i});case L.Mountain:return(0,Z.Mj)({r:180+i/2,g:180+i/2,b:180+i/2})}}}const xt=Math.LN2/5e4,Pt=Q.Ik({keys:Q.Ik({alg:Q.eu("EdDSA"),crv:Q.eu("Ed25519"),kty:Q.eu("OKP"),x:Q.Yj()}).array().min(1)}),Rt={[C.Africa]:[100,70,50],[C.Asia]:[50,40,30],[C.Australia]:[70,40,30],[C.Achiran]:[40,36,30],[C.Baikal]:[100,70,50],[C.BaikalNukeWars]:[100,70,50],[C.BetweenTwoSeas]:[70,50,40],[C.BlackSea]:[50,30,30],[C.Britannia]:[50,30,20],[C.DeglaciatedAntarctica]:[50,40,30],[C.EastAsia]:[50,30,20],[C.Europe]:[100,70,50],[C.EuropeClassic]:[50,30,30],[C.FalklandIslands]:[50,30,20],[C.FaroeIslands]:[20,15,10],[C.GatewayToTheAtlantic]:[100,70,50],[C.GiantWorldMap]:[100,70,50],[C.Halkidiki]:[100,50,40],[C.Iceland]:[50,40,30],[C.Italia]:[50,30,20],[C.Japan]:[20,15,10],[C.Mars]:[70,40,30],[C.Mena]:[70,50,40],[C.Montreal]:[60,40,30],[C.NorthAmerica]:[70,40,30],[C.Oceania]:[10,10,10],[C.Pangaea]:[20,15,10],[C.Pluto]:[100,70,50],[C.SouthAmerica]:[70,50,40],[C.StraitOfGibraltar]:[100,70,50],[C.World]:[50,30,20],[C.Yenisei]:[150,100,70]};class Nt{allowedFlares(){}stripePublishableKey(){return""}domain(){return process.env.DOMAIN??""}subdomain(){return process.env.SUBDOMAIN??""}cloudflareAccountId(){return process.env.CF_ACCOUNT_ID??""}cloudflareApiToken(){return process.env.CF_API_TOKEN??""}cloudflareConfigPath(){return process.env.CF_CONFIG_PATH??""}cloudflareCredsPath(){return process.env.CF_CREDS_PATH??""}jwtIssuer(){const t=this.jwtAudience();return"localhost"===t?"http://localhost:8787":`https://api.${t}`}async jwkPublicKey(){if(this.publicKey)return this.publicKey;const t=this.jwtIssuer()+"/.well-known/jwks.json";console.log(`Fetching JWKS from ${t}`);const e=await fetch(t),i=Pt.safeParse(await e.json());if(!i.success){const t=J.S1(i.error);throw console.error("Error parsing JWKS",t),new Error("Invalid JWKS")}return this.publicKey=i.data.keys[0],this.publicKey}otelEnabled(){return this.env()!==W.Dev&&Boolean(this.otelEndpoint())&&Boolean(this.otelAuthHeader())}otelEndpoint(){return process.env.OTEL_EXPORTER_OTLP_ENDPOINT??""}otelAuthHeader(){return process.env.OTEL_AUTH_HEADER??""}gitCommit(){return"727779536cbc761fdb45b3a31f7066f691085231"}r2Endpoint(){return`https://${process.env.CF_ACCOUNT_ID}.r2.cloudflarestorage.com`}r2AccessKey(){return process.env.R2_ACCESS_KEY??""}r2SecretKey(){return process.env.R2_SECRET_KEY??""}r2Bucket(){return process.env.R2_BUCKET??""}apiKey(){return process.env.API_KEY??""}adminHeader(){return"x-admin-key"}adminToken(){return process.env.ADMIN_TOKEN??"dummy-admin-token"}turnIntervalMs(){return 100}gameCreationRate(){return 3e4}lobbyMaxPlayers(t,e,i){const[s,r,n]=Rt[t]??[50,30,20],a=Math.random(),o=a<.3?s:a<.6?r:n;let h=Math.min(e===P.Team?Math.ceil(1.5*o):o,s);if(void 0===i)return h;switch(i){case w:h-=h%2;break;case b:h-=h%3;break;case M:h-=h%4;break;case T:break;default:h-=h%i}return h}workerIndex(t){return n(t)%this.numWorkers()}workerPath(t){return`w${this.workerIndex(t)}`}workerPort(t){return this.workerPortByIndex(this.workerIndex(t))}workerPortByIndex(t){return 3001+t}enableMatchmaking(){return!1}}class Ot{constructor(t,e,i,s){this._serverConfig=t,this._gameConfig=e,this._userSettings=i,this._isReplay=s,this.pastelTheme=new jt,this.pastelThemeDark=new Ct}stripePublishableKey(){return""}isReplay(){return this._isReplay}samHittingChance(){return.8}samWarheadHittingChance(){return.5}traitorDefenseDebuff(){return.5}traitorSpeedDebuff(){return.8}traitorDuration(){return 300}spawnImmunityDuration(){return 50}gameConfig(){return this._gameConfig}serverConfig(){return this._serverConfig}userSettings(){if(null===this._userSettings)throw new Error("userSettings is null");return this._userSettings}difficultyModifier(t){switch(t){case y.Easy:return 1;case y.Medium:return 3;case y.Hard:return 9;case y.Impossible:return 18}}cityTroopIncrease(){return 25e4}falloutDefenseModifier(t){return 5-2*t}SAMCooldown(){return 75}SiloCooldown(){return 75}defensePostRange(){return 30}defensePostDefenseBonus(){return 5}defensePostSpeedBonus(){return 3}playerTeams(){return this._gameConfig.playerTeams??0}spawnNPCs(){return!this._gameConfig.disableNPCs}isUnitDisabled(t){return this._gameConfig.disabledUnits?.includes(t)??!1}bots(){return this._gameConfig.bots}instantBuild(){return this._gameConfig.instantBuild}infiniteGold(){return this._gameConfig.infiniteGold}donateGold(){return this._gameConfig.donateGold}infiniteTroops(){return this._gameConfig.infiniteTroops}donateTroops(){return this._gameConfig.donateTroops}trainSpawnRate(t){return 16*(t+10)}trainGold(t){switch(t){case"ally":return 50000n;case"team":case"other":return 25000n;case"self":return 10000n}}trainStationMinRange(){return 15}trainStationMaxRange(){return 100}railroadMaxSize(){return 120}tradeShipGold(t,e){const i=this.tradeShipShortRangeDebuff(),s=1e5/(1+Math.exp(-.03*(t-i)))+100*t,r=e-1,n=1+r/(r+5)*2;return BigInt(Math.floor(s*n))}tradeShipSpawnRate(t,e,i){const s=Math.sqrt(this.tradeShipBaseSpawn(t,i)*this.tradeShipPortMultiplier(e));return Math.floor(25/s)}tradeShipBaseSpawn(t,e){return e<3?1:1-m(t,Math.LN2/10,55)}tradeShipPortMultiplier(t){return 1/(1+.1*t)}unitInfo(t){switch(t){case N.TransportShip:return{cost:()=>0n,territoryBound:!1};case N.Warship:return{cost:this.costWrapper((t=>Math.min(1e6,25e4*(t+1))),N.Warship),territoryBound:!1,maxHealth:1e3};case N.Shell:return{cost:()=>0n,territoryBound:!1,damage:250};case N.SAMMissile:return{cost:()=>0n,territoryBound:!1};case N.Port:return{cost:this.costWrapper((t=>Math.min(1e6,125e3*Math.pow(2,t))),N.Port,N.Factory),territoryBound:!0,constructionDuration:this.instantBuild()?0:20,upgradable:!0,canBuildTrainStation:!0};case N.AtomBomb:return{cost:this.costWrapper((()=>75e4),N.AtomBomb),territoryBound:!1};case N.HydrogenBomb:return{cost:this.costWrapper((()=>5e6),N.HydrogenBomb),territoryBound:!1};case N.MIRV:return{cost:this.costWrapper((()=>35e6),N.MIRV),territoryBound:!1};case N.MIRVWarhead:case N.TradeShip:return{cost:()=>0n,territoryBound:!1};case N.MissileSilo:return{cost:this.costWrapper((()=>1e6),N.MissileSilo),territoryBound:!0,constructionDuration:this.instantBuild()?0:100,upgradable:!0};case N.DefensePost:return{cost:this.costWrapper((t=>Math.min(25e4,5e4*(t+1))),N.DefensePost),territoryBound:!0,constructionDuration:this.instantBuild()?0:50};case N.SAMLauncher:return{cost:this.costWrapper((t=>Math.min(3e6,15e5*(t+1))),N.SAMLauncher),territoryBound:!0,constructionDuration:this.instantBuild()?0:300,upgradable:!0};case N.City:return{cost:this.costWrapper((t=>Math.min(1e6,125e3*Math.pow(2,t))),N.City),territoryBound:!0,constructionDuration:this.instantBuild()?0:20,upgradable:!0,canBuildTrainStation:!0};case N.Factory:return{cost:this.costWrapper((t=>Math.min(1e6,125e3*Math.pow(2,t))),N.Factory,N.Port),territoryBound:!0,constructionDuration:this.instantBuild()?0:20,canBuildTrainStation:!0,experimental:!0,upgradable:!0};case N.Construction:return{cost:()=>0n,territoryBound:!0};case N.Train:return{cost:()=>0n,territoryBound:!1,experimental:!0};default:u(t)}}costWrapper(t,...e){return i=>{if(i.type()===F.Human&&this.infiniteGold())return 0n;const s=e.reduce(((t,e)=>t+Math.min(i.unitsOwned(e),i.unitsConstructed(e))),0);return BigInt(t(s))}}defaultDonationAmount(t){return Math.floor(t.troops()/3)}donateCooldown(){return 100}embargoAllCooldown(){return 100}deletionMarkDuration(){return 300}deleteUnitCooldown(){return 300}emojiMessageDuration(){return 50}emojiMessageCooldown(){return 50}targetDuration(){return 100}targetCooldown(){return 150}allianceRequestDuration(){return 200}allianceRequestCooldown(){return 300}allianceDuration(){return 3e3}temporaryEmbargoDuration(){return 3e3}percentageTilesOwnedToWin(){return this._gameConfig.gameMode===P.Team?95:80}boatMaxNumber(){return 3}numSpawnPhaseTurns(){return this._gameConfig.gameType===x.Singleplayer?100:300}numBots(){return this.bots()}theme(){return this.userSettings()?.darkMode()?this.pastelThemeDark:this.pastelTheme}attackLogic(t,e,i,r,n){let a=0,o=0;const h=t.terrainType(n);switch(h){case L.Plains:a=80,o=16.5;break;case L.Highland:a=100,o=20;break;case L.Mountain:a=120,o=25;break;default:throw new Error(`terrain type ${h} not supported`)}if(r.isPlayer())for(const e of t.nearbyUnits(n,t.config().defensePostRange(),N.DefensePost))if(e.unit.owner()===r){a*=this.defensePostDefenseBonus(),o*=this.defensePostSpeedBonus();break}if(t.hasFallout(n)){const e=t.numTilesWithFallout()/t.numLandTiles();a*=this.falloutDefenseModifier(e),o*=this.falloutDefenseModifier(e)}if(i.isPlayer()&&r.isPlayer()&&(r.isDisconnected()&&i.isOnSameTeam(r)&&(a=0),i.type()===F.Human&&r.type()===F.Bot&&(a*=.8),i.type()===F.FakeHuman&&r.type()===F.Bot&&(a*=.8)),r.isPlayer()){const t=1-m(r.numTilesOwned(),xt,15e4),n=.7+.3*t,h=.7+.3*t;let l=1;i.numTilesOwned()>1e5&&(l=Math.sqrt(1e5/i.numTilesOwned())**.7);let c=1;return i.numTilesOwned()>1e5&&(c=(1e5/i.numTilesOwned())**.6),{attackerTroopLoss:s(r.troops()/e,.6,2)*a*.8*h*l*(r.isTraitor()?this.traitorDefenseDebuff():1),defenderTroopLoss:r.troops()/r.numTilesOwned(),tilesPerTickUsed:s(r.troops()/(5*e),.2,1.5)*o*n*c*(r.isTraitor()?this.traitorSpeedDebuff():1)}}return{attackerTroopLoss:i.type()===F.Bot?a/10:a/5,defenderTroopLoss:0,tilesPerTickUsed:s(2e3*Math.max(10,o)/e,5,100)}}attackTilesPerTick(t,e,i,r){return i.isPlayer()?s(5*t/i.troops()*2,.01,.5)*r*3:2*r}boatAttackAmount(t,e){return Math.floor(t.troops()/5)}warshipShellLifetime(){return 20}radiusPortSpawn(){return 20}tradeShipShortRangeDebuff(){return 300}proximityBonusPortsNb(t){return s(t/3,4,t)}attackAmount(t,e){return t.type()===F.Bot?t.troops()/20:t.troops()/5}startManpower(t){if(t.playerType===F.Bot)return 1e4;if(t.playerType===F.FakeHuman)switch(this._gameConfig.difficulty){case y.Easy:return 2500*(t?.nation?.strength??1);case y.Medium:return 5e3*(t?.nation?.strength??1);case y.Hard:return 2e4*(t?.nation?.strength??1);case y.Impossible:return 5e4*(t?.nation?.strength??1)}return this.infiniteTroops()?1e6:25e3}maxTroops(t){const e=t.type()===F.Human&&this.infiniteTroops()?1e9:2*(1e3*Math.pow(t.numTilesOwned(),.6)+5e4)+t.units(N.City).map((t=>t.level())).reduce(((t,e)=>t+e),0)*this.cityTroopIncrease();if(t.type()===F.Bot)return e/3;if(t.type()===F.Human)return e;switch(this._gameConfig.difficulty){case y.Easy:return.5*e;case y.Medium:return 1*e;case y.Hard:return 1.5*e;case y.Impossible:return 2*e}}troopIncreaseRate(t){const e=this.maxTroops(t);let i=10+Math.pow(t.troops(),.73)/4;if(i*=1-t.troops()/e,t.type()===F.Bot&&(i*=.6),t.type()===F.FakeHuman)switch(this._gameConfig.difficulty){case y.Easy:i*=.9;break;case y.Medium:i*=1;break;case y.Hard:i*=1.1;break;case y.Impossible:i*=1.2}return Math.min(t.troops()+i,e)-t.troops()}goldAdditionRate(t){return t.type()===F.Bot?50n:100n}nukeMagnitudes(t){switch(t){case N.MIRVWarhead:return{inner:12,outer:18};case N.AtomBomb:return{inner:12,outer:30};case N.HydrogenBomb:return{inner:80,outer:100}}throw new Error(`Unknown nuke type: ${t}`)}nukeAllianceBreakThreshold(){return 100}defaultNukeSpeed(){return 6}defaultNukeTargetableRange(){return 150}defaultSamRange(){return 70}samRange(t){return this.maxSamRange()-480/(t+5)}maxSamRange(){return 150}defaultSamMissileSpeed(){return 12}nukeDeathFactor(t,e,i,s){if(t!==N.MIRVWarhead)return 5*e/Math.max(1,i);const r=.03*s,n=Math.max(0,e-r)/s;return 500*(1-Math.exp(-2*n))}structureMinDist(){return 15}shellLifetime(){return 50}warshipPatrolRange(){return 100}warshipTargettingRange(){return 130}warshipShellAttackRate(){return 20}defensePostShellAttackRate(){return 100}safeFromPiratesCooldownMax(){return 20}defensePostTargettingRange(){return 75}allianceExtensionPromptOffset(){return 300}}class Bt extends Nt{adminToken(){return"WARNING_DEV_ADMIN_KEY_DO_NOT_USE_IN_PRODUCTION"}apiKey(){return"WARNING_DEV_API_KEY_DO_NOT_USE_IN_PRODUCTION"}env(){return W.Dev}gameCreationRate(){return 5e3}samWarheadHittingChance(){return 1}samHittingChance(){return 1}numWorkers(){return 2}jwtAudience(){return"localhost"}gitCommit(){return"DEV"}domain(){return"localhost"}subdomain(){return""}}class Ut extends Ot{constructor(t,e,i,s){super(t,e,i,s)}unitInfo(t){const e=super.unitInfo(t);return e.cost,e}}const Lt=new class extends Nt{env(){return W.Preprod}numWorkers(){return 2}jwtAudience(){return"openfront.dev"}allowedFlares(){}},Ft=new class extends Nt{numWorkers(){return 20}env(){return W.Prod}jwtAudience(){return"openfront.io"}};let qt=null;async function $t(t,e,i=!1){const s=await async function(){if(qt)return qt;const t=await fetch("/api/env");if(!t.ok)throw new Error(`Failed to fetch server config: ${t.status} ${t.statusText}`);const e=await t.json();return console.log("Server config loaded:",e),qt=function(t){switch(t){case"dev":return console.log("using dev server config"),new Bt;case"staging":return console.log("using preprod server config"),Lt;case"prod":return console.log("using prod server config"),Ft;default:throw Error(`unsupported server configuration: ${t}`)}}(e.game_env),qt}();switch(s.env()){case W.Dev:return new Ut(s,t,e,i);case W.Preprod:case W.Prod:return console.log("using prod config"),new Ot(s,t,e,i);default:throw Error("unsupported server configuration: prod")}}class Ht{constructor(t,e){this.from=t,this.toID=e}init(t,e){if(!t.hasPlayer(this.toID))return void console.warn(`[AllianceExtensionExecution] Player ${this.toID} not found`);const i=t.player(this.toID);if(!this.from.isAlive()||!i.isAlive())return void console.info(`[AllianceExtensionExecution] Player ${this.from.id()} or ${this.toID} is not alive`);const s=this.from.allianceWith(i);s?(s.addExtensionRequest(this.from),s.bothAgreedToExtend()&&(s.extend(),t.displayMessage("events_display.alliance_renewed",q.ALLIANCE_ACCEPTED,this.from.id(),void 0,{name:i.displayName()}),t.displayMessage("events_display.alliance_renewed",q.ALLIANCE_ACCEPTED,this.toID,void 0,{name:this.from.displayName()}))):console.warn(`[AllianceExtensionExecution] No alliance to extend between ${this.from.id()} and ${this.toID}`)}tick(t){}isActive(){return!1}activeDuringSpawnPhase(){return!1}}class Wt{constructor(t,e){this.requestor=t,this.recipientID=e,this.req=null,this.active=!0}init(t,e){if(this.mg=t,!t.hasPlayer(this.recipientID))return void console.warn(`AllianceRequestExecution recipient ${this.recipientID} not found`);const i=t.player(this.recipientID);if(this.requestor.canSendAllianceRequest(i)){const t=i.outgoingAllianceRequests().find((t=>t.recipient()===this.requestor));t?(this.active=!1,t.accept()):this.req=this.requestor.createAllianceRequest(i)}else console.warn("cannot send alliance request"),this.active=!1}tick(t){"accepted"!==this.req?.status()&&"rejected"!==this.req?.status()?this.mg.ticks()-(this.req?.createdAt()??0)>this.mg.config().allianceRequestDuration()&&(this.req?.reject(),this.active=!1):this.active=!1}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class Vt{constructor(t,e,i){this.requestorID=t,this.recipient=e,this.accept=i,this.active=!0,this.requestor=null}init(t,e){if(!t.hasPlayer(this.requestorID))return console.warn(`AllianceRequestReplyExecution requester ${this.requestorID} not found`),void(this.active=!1);this.requestor=t.player(this.requestorID)}tick(t){if(null===this.requestor)throw new Error("Not initialized");if(this.requestor.isFriendly(this.recipient))console.warn("already allied");else{const t=this.requestor.outgoingAllianceRequests().find((t=>t.recipient()===this.recipient));void 0===t?console.warn("no alliance request found"):this.accept?(t.accept(),this.requestor.updateRelation(this.recipient,100),this.recipient.updateRelation(this.requestor,100)):t.reject()}this.active=!1}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class Gt{constructor(t,e){this.requestor=t,this.recipientID=e,this.active=!0,this.recipient=null,this.mg=null}init(t,e){if(!t.hasPlayer(this.recipientID))return console.warn(`BreakAllianceExecution: recipient ${this.recipientID} not found`),void(this.active=!1);this.recipient=t.player(this.recipientID),this.mg=t}tick(t){if(null===this.mg||null===this.requestor||null===this.recipient)throw new Error("Not initialized");const e=this.requestor.allianceWith(this.recipient);if(null===e)console.warn("cant break alliance, not allied");else{this.requestor.breakAlliance(e),this.recipient.updateRelation(this.requestor,-200);for(const t of this.mg.players())t===this.requestor||t.isOnSameTeam(this.requestor)||t.updateRelation(this.requestor,-40)}this.active=!1}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}function zt(t){return Kt(t/10)}function Kt(t,e){return t=Number(t),(t=Math.max(t,0))>=1e7?(Math.floor(t/1e5)/10).toFixed(e??1)+"M":t>=1e6?(Math.floor(t/1e4)/100).toFixed(e??2)+"M":t>=1e5?Math.floor(t/1e3)+"K":t>=1e4?(Math.floor(t/100)/10).toFixed(e??1)+"K":t>=1e3?(Math.floor(t/10)/100).toFixed(e??2)+"K":Math.floor(t).toString()}class Yt{constructor(t=1024){this.len=0,this.pri=new Float32Array(t),this.tiles=new Array(t)}clear(){this.len=0}size(){return this.len}enqueue(t,e){this.len===this.pri.length&&this.grow();let i=this.len++;for(;i>0;){const t=i-1>>1;if(e>=this.pri[t])break;this.pri[i]=this.pri[t],this.tiles[i]=this.tiles[t],i=t}this.pri[i]=e,this.tiles[i]=t}dequeue(){if(0===this.len)throw new Error("heap empty");const t=this.tiles[0],e=this.pri[0],i=this.pri[--this.len],s=this.tiles[this.len];let r=0;for(;;){const t=1+(r<<1);if(t>=this.len)break;const e=t+1,s=e<this.len&&this.pri[e]<this.pri[t]?e:t;if(i<=this.pri[s])break;this.pri[r]=this.pri[s],this.tiles[r]=this.tiles[s],r=s}return this.pri[r]=i,this.tiles[r]=s,[t,e]}grow(){const t=this.pri.length<<1,e=new Float32Array(t);e.set(this.pri),this.pri=e,this.tiles.length=t}}class Xt{constructor(t=null,e,i,s=null,r=!0){this.startTroops=t,this._owner=e,this._targetID=i,this.sourceTile=s,this.removeTroops=r,this.active=!0,this.toConquer=new Yt,this.random=new it(123),this.attack=null}targetID(){return this._targetID}activeDuringSpawnPhase(){return!1}init(t,e){if(this.active){if(this.mg=t,null!==this._targetID&&!t.hasPlayer(this._targetID))return console.warn(`target ${this._targetID} not found`),void(this.active=!1);if(this.target=this._targetID===this.mg.terraNullius().id()?t.terraNullius():t.player(this._targetID),this._owner===this.target)return console.error(`Player ${this._owner} cannot attack itself`),void(this.active=!1);if(this.target.isPlayer()){const t=this.target;if(this._owner.isFriendly(t))return console.warn(`${this._owner.displayName()} cannot attack ${t.displayName()} because they are friendly (allied or same team)`),void(this.active=!1)}if(this.target&&this.target.isPlayer()){const t=this.target;t.type()!==F.Bot&&this._owner.type()!==F.Bot&&(t.addEmbargo(this._owner,!0),this.rejectIncomingAllianceRequests(t))}if(this.target.isPlayer()&&this.mg.config().numSpawnPhaseTurns()+this.mg.config().spawnImmunityDuration()>this.mg.ticks())return console.warn("cannot attack player during immunity phase"),void(this.active=!1);this.startTroops??(this.startTroops=this.mg.config().attackAmount(this._owner,this.target)),this.removeTroops&&(this.startTroops=Math.min(this._owner.troops(),this.startTroops),this._owner.removeTroops(this.startTroops)),this.attack=this._owner.createAttack(this.target,this.startTroops,this.sourceTile,new Set),null!==this.sourceTile?this.addNeighbors(this.sourceTile):this.refreshToConquer(),this.mg.stats().attack(this._owner,this.target,this.startTroops);for(const t of this._owner.incomingAttacks())if(t.attacker()===this.target){if(t.troops()>this.attack.troops())return t.setTroops(t.troops()-this.attack.troops()),this.attack.delete(),void(this.active=!1);this.attack.setTroops(this.attack.troops()-t.troops()),t.delete()}for(const t of this._owner.outgoingAttacks())t!==this.attack&&t.target()===this.attack.target()&&null===this.attack.sourceTile()&&(this.attack.setTroops(this.attack.troops()+t.troops()),t.delete());this.target.isPlayer()&&this.target.updateRelation(this._owner,-80)}}refreshToConquer(){if(null===this.attack)throw new Error("Attack not initialized");this.toConquer.clear(),this.attack.clearBorder();for(const t of this._owner.borderTiles())this.addNeighbors(t)}retreat(t=0){if(null===this.attack)throw new Error("Attack not initialized");const e=this.attack.troops()*(t/100);e&&this.mg.displayMessage(`Attack cancelled, ${zt(e)} soldiers killed during retreat.`,q.ATTACK_CANCELLED,this._owner.id()),!1===this.removeTroops&&this.attack.setTroops(this.attack.troops()-(this.startTroops??0));const i=this.attack.troops()-e;this._owner.addTroops(i),this.attack.delete(),this.active=!1,this.attack.retreated()&&this.mg.stats().attackCancel(this._owner,this.target,i)}tick(t){if(null===this.attack)throw new Error("Attack not initialized");let e=this.attack.troops();const i=this.target.isPlayer(),s=i?this.target:null;if(this.attack.retreated())return i?this.retreat(25):this.retreat(),void(this.active=!1);if(this.attack.retreating())return;if(!this.attack.isActive())return void(this.active=!1);if(s&&this._owner.isFriendly(s))return void this.retreat();let r=this.mg.config().attackTilesPerTick(e,this._owner,this.target,this.attack.borderSize()+this.random.nextInt(0,5));for(;r>0;){if(e<1)return this.attack.delete(),void(this.active=!1);if(0===this.toConquer.size())return this.refreshToConquer(),void this.retreat();const[t]=this.toConquer.dequeue();this.attack.removeBorderTile(t);let i=!1;for(const e of this.mg.neighbors(t))if(this.mg.owner(e)===this._owner){i=!0;break}if(this.mg.owner(t)!==this.target||!i)continue;this.addNeighbors(t);const{attackerTroopLoss:n,defenderTroopLoss:a,tilesPerTickUsed:o}=this.mg.config().attackLogic(this.mg,e,this._owner,this.target,t);r-=o,e-=n,this.attack.setTroops(e),s&&s.removeTroops(a),this._owner.conquer(t),this.handleDeadDefender()}}rejectIncomingAllianceRequests(t){const e=this._owner.incomingAllianceRequests().find((e=>e.requestor()===t));void 0!==e&&e.reject()}addNeighbors(t){if(null===this.attack)throw new Error("Attack not initialized");const e=this.mg.ticks();for(const i of this.mg.neighbors(t)){if(this.mg.isWater(i)||this.mg.owner(i)!==this.target)continue;this.attack.addBorderTile(i);let t=0;for(const e of this.mg.neighbors(i))this.mg.owner(e)===this._owner&&t++;let s=0;switch(this.mg.terrainType(i)){case L.Plains:s=1;break;case L.Highland:s=1.5;break;case L.Mountain:s=2}const r=(this.random.nextInt(0,7)+10)*(1-.5*t+s/2)+e;this.toConquer.enqueue(i,r)}}handleDeadDefender(){if(this.target.isPlayer()&&this.target.numTilesOwned()<100){this.mg.conquerPlayer(this._owner,this.target);for(let t=0;t<10;t++)for(const t of this.target.tiles())if(this.mg.neighbors(t).some((t=>this.mg.owner(t)===this._owner)))this._owner.conquer(t);else for(const e of this.mg.neighbors(t)){const i=this.mg.owner(e);if(i.isPlayer()&&i!==this.target){this.mg.player(i.id()).conquer(t);break}}}}owner(){return this._owner}isActive(){return this.active}}class Qt{constructor(t,e){this.player=t,this.unitID=e,this.active=!0}init(t,e){}tick(t){const e=this.player.units().find((t=>t.id()===this.unitID&&t.type()===N.TransportShip));if(!e)return console.warn(`Didn't find outgoing boat with id ${this.unitID}`),void(this.active=!1);e.orderBoatRetreat(),this.active=!1}owner(){return this.player}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class Jt{constructor(t,e,i){this.requestor=t,this.recipientID=e,this.emoji=i,this.active=!0}init(t,e){if(this.recipientID!==f&&!t.hasPlayer(this.recipientID))return console.warn(`EmojiExecution: recipient ${this.recipientID} not found`),void(this.active=!1);this.recipient=this.recipientID===f?f:t.player(this.recipientID)}tick(t){const e=p[this.emoji];void 0===e?console.warn(`cannot send emoji ${this.emoji} from ${this.requestor} to ${this.recipient}`):this.requestor.canSendEmoji(this.recipient)?(this.requestor.sendEmoji(this.recipient,e),"ðŸ–•"===e&&this.recipient!==f&&this.recipient.type()===F.FakeHuman&&this.recipient.updateRelation(this.requestor,-100)):console.warn(`cannot send emoji from ${this.requestor} to ${this.recipient}`),this.active=!1}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}const Zt=t=>p.indexOf(t),te=["ðŸ‘","â›µ","ðŸ¤","ðŸŽ¯"].map(Zt),ee=["ðŸ¥±","ðŸ¤¦â€â™‚ï¸"].map(Zt),ie=["ðŸ¥º","ðŸ’€"].map(Zt),se=["ðŸ•Šï¸","ðŸ‘Ž"].map(Zt),re=["ðŸ¤¡","ðŸ˜¡"].map(Zt);class ne{constructor(t,e,i,s,r,n){this.random=t,this.game=e,this.player=i,this.triggerRatio=s,this.reserveRatio=r,this.expandRatio=n,this.enemy=null}handleAllianceRequests(){for(const i of this.player.incomingAllianceRequests())t=this.player,e=i,t.relation(e.requestor())<U.Neutral||e.requestor().isTraitor()||!(e.requestor().numTilesOwned()>3*t.numTilesOwned())&&e.requestor().alliances().length>=3?i.reject():i.accept();var t,e}handleAllianceExtensionRequests(){for(const t of this.player.alliances()){if(!t.onlyOneAgreedToExtend())continue;const e=t.other(this.player);(this.player.type()!==F.FakeHuman||this.player.relation(e)!==U.Neutral||this.random.chance(1.5))&&this.game.addExecution(new Ht(this.player,e.id()))}}emoji(t,e){t.type()===F.Human&&this.game.addExecution(new Jt(this.player,t.id(),e))}setNewEnemy(t,e=!1){(null===t||e||this.shouldAttack(t))&&(this.enemy=t,this.enemyUpdated=this.game.ticks())}shouldAttack(t){if(null===this.player)throw new Error("not initialized");if(this.player.isOnSameTeam(t))return!1;const e=this.attackChance(t);return e&&this.player.isAlliedWith(t)?(this.betray(t),!0):e}betray(t){if(null===this.player)throw new Error("not initialized");const e=this.player.allianceWith(t);e&&this.player.breakAlliance(e)}attackChance(t){if(null===this.player)throw new Error("not initialized");return this.player.isAlliedWith(t)?this.shouldDiscourageAttack(t)?this.random.chance(200):this.random.chance(50):!this.shouldDiscourageAttack(t)||this.random.chance(4)}shouldDiscourageAttack(t){if(t.isTraitor())return!1;const{difficulty:e}=this.game.config().gameConfig();return e!==y.Hard&&e!==y.Impossible&&t.type()===F.Human}clearEnemy(){this.enemy=null}forgetOldEnemies(){this.game.ticks()-(this.enemyUpdated??0)>100&&this.clearEnemy()}hasReserveRatioTroops(){const t=this.game.config().maxTroops(this.player);return this.player.troops()/t>=this.reserveRatio}hasTriggerRatioTroops(){const t=this.game.config().maxTroops(this.player);return this.player.troops()/t>=this.triggerRatio}checkIncomingAttacks(){const t=this.player.incomingAttacks();let e,i=0;for(const s of t)s.troops()<=i||(i=s.troops(),e=s.attacker());void 0!==e&&this.setNewEnemy(e,!0)}getNeighborTraitorToAttack(){const t=this.player.neighbors().filter((t=>t.isPlayer()&&t.isTraitor()));return t.length>0?this.random.randElement(t):null}assistAllies(){for(const t of this.player.allies())if(0!==t.targets().length)if(this.player.relation(t)<U.Friendly)this.emoji(t,this.random.randElement(ee));else for(const e of t.targets())if(e!==this.player){if(!this.player.isAlliedWith(e))return this.player.updateRelation(t,-20),this.setNewEnemy(e),void this.emoji(t,this.random.randElement(te));this.emoji(t,this.random.randElement(se))}else this.emoji(t,this.random.randElement(ie))}selectEnemy(t){if(null===this.enemy){if(!this.hasReserveRatioTroops())return null;if(!this.hasTriggerRatioTroops()&&!this.random.chance(10))return null;const e=this.player.neighbors().filter((t=>t.isPlayer()&&t.type()===F.Bot));if(e.length>0){const t=t=>t.troops()/t.numTilesOwned();let i,s=1/0;for(const r of e){const e=t(r);e<s&&(s=e,i=r)}void 0!==i&&this.setNewEnemy(i)}if(null===this.enemy&&this.checkIncomingAttacks(),null===this.enemy&&this.random.chance(2)){const t=this.player.allRelationsSorted()[0];void 0!==t&&t.relation===U.Hostile&&this.setNewEnemy(t.player)}null===this.enemy&&t.length>0&&this.setNewEnemy(t[0]),null===this.enemy&&t.length>0&&this.setNewEnemy(this.random.randElement(t)),null===this.enemy&&0===t.length&&this.selectNearestIslandEnemy()}return this.enemySanityCheck()}getPlayerCenter(t){return t.largestClusterBoundingBox?h(t.largestClusterBoundingBox):function(t,e){const{min:i,max:s}=a(t,e);return h({min:i,max:s})}(this.game,t.borderTiles())}selectNearestIslandEnemy(){if(0===this.player.borderTiles().size)return;const t=this.game.players().filter((t=>t!==this.player&&!!t.isAlive()&&0!==t.borderTiles().size&&!this.player.isFriendly(t)&&t.troops()<=2*this.player.troops()));if(t.length>0){const e=this.getPlayerCenter(this.player),i=t.map((t=>{const i=this.getPlayerCenter(t),s=this.game.ref(e.x,e.y),r=this.game.ref(i.x,i.y);return{player:t,distance:this.game.manhattanDist(s,r)}})).sort(((t,e)=>t.distance-e.distance));let s;s=i.length>1&&this.random.chance(2)?i[1].player:i[0].player,null!==s&&this.setNewEnemy(s)}}selectRandomEnemy(){if(null===this.enemy){if(!this.hasTriggerRatioTroops())return null;const t=this.player.neighbors();for(const e of this.random.shuffleArray(t))e.isPlayer()&&(this.player.isFriendly(e)||e.type()===F.FakeHuman&&this.random.chance(2)||this.setNewEnemy(e));if(null===this.enemy&&this.checkIncomingAttacks(),null===this.enemy){const t=this.getNeighborTraitorToAttack();null!==t&&!this.player.isFriendly(t)&&this.random.chance(3)&&this.setNewEnemy(t)}}return this.enemySanityCheck()}enemySanityCheck(){return this.enemy&&this.player.isFriendly(this.enemy)&&this.clearEnemy(),this.enemy}forceSendAttack(t){this.game.addExecution(new Xt(this.player.troops()/2,this.player,t.isPlayer()?t.id():this.game.terraNullius().id()))}sendAttack(t){if(t.isPlayer()&&this.player.isFriendly(t))return;const e=this.game.config().maxTroops(this.player)*(t.isPlayer()?this.reserveRatio:this.expandRatio),i=this.player.troops()-e;i<1||this.game.addExecution(new Xt(i,this.player,t.isPlayer()?t.id():this.game.terraNullius().id()))}}class ae{constructor(t){this.bot=t,this.active=!0,this.neighborsTerraNullius=!0,this.behavior=null,this.random=new it(n(t.id())),this.attackRate=this.random.nextInt(40,80),this.attackTick=this.random.nextInt(0,this.attackRate),this.triggerRatio=this.random.nextInt(50,60)/100,this.reserveRatio=this.random.nextInt(30,40)/100,this.expandRatio=this.random.nextInt(10,20)/100}activeDuringSpawnPhase(){return!1}init(t){this.mg=t}tick(t){if(t%this.attackRate===this.attackTick)if(this.bot.isAlive()){if(null===this.behavior)return this.behavior=new ne(this.random,this.mg,this.bot,this.triggerRatio,this.reserveRatio,this.expandRatio),void this.behavior.sendAttack(this.mg.terraNullius());this.behavior.handleAllianceRequests(),this.behavior.handleAllianceExtensionRequests(),this.maybeAttack()}else this.active=!1}maybeAttack(){if(null===this.behavior)throw new Error("not initialized");const t=this.behavior.getNeighborTraitorToAttack();if(null!==t){const e=this.bot.isFriendly(t)?6:3;if(this.random.chance(e)){const e=this.bot.allianceWith(t);return null!==e&&this.bot.breakAlliance(e),void this.behavior.sendAttack(t)}}if(this.neighborsTerraNullius){if(this.bot.sharesBorderWith(this.mg.terraNullius()))return void this.behavior.sendAttack(this.mg.terraNullius());this.neighborsTerraNullius=!1}this.behavior.forgetOldEnemies();const e=this.behavior.selectRandomEnemy();e&&this.bot.sharesBorderWith(e)&&this.behavior.sendAttack(e)}isActive(){return this.active}}class oe{constructor(t){this.player=t,this.ticksPerClusterCalc=20,this.lastCalc=0,this.active=!0}activeDuringSpawnPhase(){return!1}init(t,e){this.mg=t,this.config=t.config(),this.lastCalc=e+n(this.player.name())%this.ticksPerClusterCalc}tick(t){this.player.decayRelations();for(const t of this.player.units()){if(!t.info().territoryBound)continue;const e=this.mg.owner(t.tile());if(!e?.isPlayer()){t.delete();continue}if(e===this.player)continue;const i=this.mg.player(e.id());t.type()===N.DefensePost?(t.decreaseLevel(i),t.isActive()&&i.captureUnit(t)):i.captureUnit(t)}if(!this.player.isAlive()){const e=this.player.gold();return this.player.removeGold(e),this.player.units().forEach((t=>{t.type()!==N.AtomBomb&&t.type()!==N.HydrogenBomb&&t.type()!==N.MIRVWarhead&&t.type()!==N.MIRV&&t.delete()})),this.active=!1,void this.mg.stats().playerKilled(this.player,t)}const e=this.config.troopIncreaseRate(this.player);this.player.addTroops(e);const i=this.config.goldAdditionRate(this.player);this.player.addGold(i),this.mg.stats().goldWork(this.player,i);const s=Array.from(this.player.alliances());for(const t of s)t.expiresAt()<=this.mg.ticks()&&t.expire();const r=this.player.getEmbargoes();for(const t of r)t.isTemporary&&this.mg.ticks()-t.createdAt>this.mg.config().temporaryEmbargoDuration()&&this.player.stopEmbargo(t.target);if(t-this.lastCalc>this.ticksPerClusterCalc&&this.player.lastTileChange()>this.lastCalc){this.lastCalc=t;const e=performance.now();this.removeClusters();const i=performance.now();i-e>1e3&&console.log(`player ${this.player.name()}, took ${i-e}ms`)}}removeClusters(){const t=this.calculateClusters();t.sort(((t,e)=>e.size-t.size));const e=t.shift();if(void 0===e)throw new Error("No clusters");this.player.largestClusterBoundingBox=a(this.mg,e);const i=this.surroundedBySamePlayer(e);i&&!i.isFriendly(this.player)&&this.removeCluster(e);for(const e of t)this.isSurrounded(e)&&this.removeCluster(e)}surroundedBySamePlayer(t){const e=new Set;for(const i of t){if(this.mg.isOceanShore(i)||this.mg.isOnEdgeOfMap(i)||this.mg.neighbors(i).some((t=>!this.mg?.hasOwner(t))))return!1;if(this.mg.neighbors(i).filter((t=>this.mg?.ownerID(t)!==this.player?.smallID())).forEach((t=>this.mg&&e.add(this.mg.ownerID(t)))),1!==e.size)return!1}if(1!==e.size)return!1;const i=this.mg.playerBySmallID(Array.from(e)[0]);return!!l(a(this.mg,i.borderTiles()),a(this.mg,t))&&i}isSurrounded(t){const e=new Set;for(const i of t){if(this.mg.isShore(i)||this.mg.isOnEdgeOfMap(i))return!1;this.mg.neighbors(i).filter((t=>this.mg?.owner(t).isPlayer()&&this.mg?.ownerID(t)!==this.player?.smallID())).forEach((t=>e.add(t)))}return 0!==e.size&&l(a(this.mg,e),a(this.mg,t))}removeCluster(t){if(Array.from(t).some((t=>this.mg?.ownerID(t)!==this.player?.smallID())))return;const e=this.getCapturingPlayer(t);if(null===e)return;const i=t.values().next().value;if(!i)return;const s=this.mg.bfs(i,((t,e)=>this.mg?.ownerID(e)===this.player?.smallID()));this.player.numTilesOwned()===s.size&&this.mg.conquerPlayer(e,this.player);for(const t of s)e.conquer(t)}getCapturingPlayer(t){const e=new Map;for(const i of t)for(const t of this.mg.neighbors(i)){const i=this.mg.owner(t);i.isPlayer()&&i!==this.player&&!i.isFriendly(this.player)&&e.set(i,(e.get(i)??0)+1)}if(0===e.size)return null;let i=null,s=0;for(const[t]of e)for(const e of t.outgoingAttacks())e.target()===this.player&&e.troops()>s&&(s=e.troops(),i=t);return null!==i?i:function(t){let e=null,i=0;for(const[s,r]of t)r>i&&(i=r,e=s);return e}(e)}calculateClusters(){const t=new Set,e=this.player.borderTiles(),i=[];for(const s of e){if(t.has(s))continue;const r=new Set,n=[s];for(t.add(s);n.length>0;){const i=n.shift();if(void 0===i)throw new Error("curr is undefined");r.add(i);const s=this.mg.neighborsWithDiag(i);for(const i of s)e.has(i)&&!t.has(i)&&(n.push(i),t.add(i))}i.push(r)}return i}owner(){if(null===this.player)throw new Error("Not initialized");return this.player}isActive(){return this.active}}class he{constructor(t,e,i,s){if(this.numLandTiles_=s,this._numTilesWithFallout=0,i.length!==t*e)throw new Error(`Terrain data length ${i.length} doesn't match dimensions ${t}x${e}`);this.width_=t,this.height_=e,this.terrain=i,this.state=new Uint16Array(t*e);let r=0;this.refToX=new Array(t*e),this.refToY=new Array(t*e),this.yToRef=new Array(e);for(let i=0;i<e;i++){this.yToRef[i]=r;for(let e=0;e<t;e++)this.refToX[r]=e,this.refToY[r]=i,r++}}numTilesWithFallout(){return this._numTilesWithFallout}ref(t,e){if(!this.isValidCoord(t,e))throw new Error(`Invalid coordinates: ${t},${e}`);return this.yToRef[e]+t}isValidRef(t){return t>=0&&t<this.refToX.length}x(t){return this.refToX[t]}y(t){return this.refToY[t]}cell(t){return new G(this.x(t),this.y(t))}width(){return this.width_}height(){return this.height_}numLandTiles(){return this.numLandTiles_}isValidCoord(t,e){return t>=0&&t<this.width_&&e>=0&&e<this.height_}isLand(t){return Boolean(this.terrain[t]&1<<he.IS_LAND_BIT)}isOceanShore(t){return this.isLand(t)&&this.neighbors(t).some((t=>this.isOcean(t)))}isOcean(t){return Boolean(this.terrain[t]&1<<he.OCEAN_BIT)}isShoreline(t){return Boolean(this.terrain[t]&1<<he.SHORELINE_BIT)}magnitude(t){return this.terrain[t]&he.MAGNITUDE_MASK}ownerID(t){return this.state[t]&he.PLAYER_ID_MASK}hasOwner(t){return 0!==this.ownerID(t)}setOwnerID(t,e){if(e>he.PLAYER_ID_MASK)throw new Error(`Player ID ${e} exceeds maximum value ${he.PLAYER_ID_MASK}`);this.state[t]=this.state[t]&~he.PLAYER_ID_MASK|e}hasFallout(t){return Boolean(this.state[t]&1<<he.FALLOUT_BIT)}setFallout(t,e){const i=this.hasFallout(t);e?i||(this._numTilesWithFallout++,this.state[t]|=1<<he.FALLOUT_BIT):i&&(this._numTilesWithFallout--,this.state[t]&=~(1<<he.FALLOUT_BIT))}isOnEdgeOfMap(t){const e=this.x(t),i=this.y(t);return 0===e||e===this.width()-1||0===i||i===this.height()-1}isBorder(t){return this.neighbors(t).some((e=>this.ownerID(e)!==this.ownerID(t)))}hasDefenseBonus(t){return Boolean(this.state[t]&1<<he.DEFENSE_BONUS_BIT)}setDefenseBonus(t,e){e?this.state[t]|=1<<he.DEFENSE_BONUS_BIT:this.state[t]&=~(1<<he.DEFENSE_BONUS_BIT)}isWater(t){return!this.isLand(t)}isLake(t){return!this.isLand(t)&&!this.isOcean(t)}isShore(t){return this.isLand(t)&&this.isShoreline(t)}cost(t){return this.magnitude(t)<10?2:1}terrainType(t){if(this.isLand(t)){const e=this.magnitude(t);return e<10?L.Plains:e<20?L.Highland:L.Mountain}return this.isOcean(t)?L.Ocean:L.Lake}neighbors(t){const e=[],i=this.width_,s=this.refToX[t];return t>=i&&e.push(t-i),t<(this.height_-1)*i&&e.push(t+i),0!==s&&e.push(t-1),s!==i-1&&e.push(t+1),e}forEachTile(t){for(let e=0;e<this.width_*this.height_;e++)t(e)}manhattanDist(t,e){return Math.abs(this.x(t)-this.x(e))+Math.abs(this.y(t)-this.y(e))}euclideanDistSquared(t,e){const i=this.x(t)-this.x(e),s=this.y(t)-this.y(e);return i*i+s*s}bfs(t,e){const i=new Set,s=[];for(e(this,t)&&(i.add(t),s.push(t));s.length>0;){const t=s.pop();if(void 0!==t)for(const r of this.neighbors(t))!i.has(r)&&e(this,r)&&(i.add(r),s.push(r))}return i}toTileUpdate(t){return BigInt(t)<<16n|BigInt(this.state[t])}updateTile(t){const e=Number(t>>16n),i=Number(0xffffn&t),s=this.hasFallout(e);this.state[e]=i;const r=this.hasFallout(e);return s&&!r&&this._numTilesWithFallout--,!s&&r&&this._numTilesWithFallout++,e}}function le(t,e,i=!1){const s=e*e;return i?(e,i)=>{const r=e.x(t)-.5,n=e.y(t)-.5,a=e.x(i)-r,o=e.y(i)-n;return a*a+o*o<=s}:(e,i)=>e.euclideanDistSquared(t,i)<=s}function ce(t,e,i=!1){return i?(i,s)=>{const r=i.x(t)-.5,n=i.y(t)-.5;return Math.abs(i.x(s)-r)+Math.abs(i.y(s)-n)<=e}:(i,s)=>i.manhattanDist(t,s)<=e}function ue(t,e){return(i,s)=>t(i,s)&&e(i,s)}function de(t,e,i){let s=1/0,r=null;for(const n of e){const e=t.manhattanDist(n,i);e<s&&(s=e,r=n)}return[r,s]}function ge(t,e,i){const s=Array.from(e).sort(((e,i)=>t.x(e)-t.x(i))),r=Array.from(i).sort(((e,i)=>t.x(e)-t.x(i)));if(0===s.length||0===r.length)return null;let n=0,a=0,o=1/0,h={x:s[0],y:r[0]};for(;n<s.length&&a<r.length;){const e=s[n],i=r[a],l=Math.abs(t.x(e)-t.x(i))+Math.abs(t.y(e)-t.y(i));l<o&&(o=l,h={x:e,y:i}),n===s.length-1?a++:a===r.length-1||t.x(e)<t.x(i)?n++:a++}return h}he.IS_LAND_BIT=7,he.SHORELINE_BIT=6,he.OCEAN_BIT=5,he.MAGNITUDE_MASK=31,he.PLAYER_ID_MASK=4095,he.FALLOUT_BIT=13,he.DEFENSE_BONUS_BIT=14;class pe{constructor(t,e){this.playerInfo=t,this.tile=e,this.active=!0}init(t,e){this.mg=t}tick(t){if(this.active=!1,!this.mg.isValidRef(this.tile))return void console.warn(`SpawnExecution: tile ${this.tile} not valid`);if(!this.mg.inSpawnPhase())return void(this.active=!1);let e=null;var i,s;e=this.mg.hasPlayer(this.playerInfo.id)?this.mg.player(this.playerInfo.id):this.mg.addPlayer(this.playerInfo),e.tiles().forEach((t=>e.relinquish(t))),(i=this.mg,s=this.tile,Array.from(i.bfs(s,le(s,4,!0))).filter((t=>!i.hasOwner(t)&&i.isLand(t)))).forEach((t=>{e.conquer(t)})),e.hasSpawned()||(this.mg.addExecution(new oe(e)),e.type()===F.Bot&&this.mg.addExecution(new ae(e))),e.setHasSpawned(!0)}isActive(){return this.active}activeDuringSpawnPhase(){return!0}}const me=["Akkadian","Babylonian","Sumerian","Hittite","Phoenician","Canaanite","Minoan","Mycenaean","Etruscan","Scythian","Thracian","Dacian","Illyrian","Median","Chaldean","Roman","Greek","Byzantine","Persian","Parthian","Seleucid","Ptolemaic","Palmyrene","Macedonian","Carthaginian","Ming","Tang","Song","Yuan","Mauryan","Kushan","Rajput","Mughal","Satavahana","Vijayanagara","Egyptian","Nubian","Kushite","Aksumite","Ethiopian","Songhai","Malian","Ghanaian","Benin","Ashanti","Zulu","Tuareg","Berber","Kanem-Bornu","Buganda","Mossi","Swahili","Somali","Wolof","Umayyad","Abbasid","Ayyubid","Fatimid","Mamluk","Seljuk","Safavid","Ottoman","Almoravid","Almohad","Rashidun","Ziyarid","Frankish","Visigothic","Ostrogothic","Viking","Norman","Saxon","Anglo-Saxon","Celtic","Gaulish","Carolingian","Merovingian","Capetian","Plantagenet","Tudor","Stuart","Habsburg","Romanov","Lancaster","York","Bourbon","Napoleonic","British","French","Spanish","Portuguese","Dutch","Russian","German","Italian","Swedish","Norwegian","Danish","Polish","Hungarian","Austrian","Swiss","Czech","Slovak","Serbian","Croatian","Bosnian","Montenegrin","Bulgarian","Romanian","Apache","Sioux","Cherokee","Navajo","Iroquois","Inuit","Arawak","Carib","Taino","Aztec","Mayan","Incan","Mapuche","Guarani","Tupi","Yanomami","Zuni","Hopi","Kiowa","Comanche","Shoshone","Japanese","Ryukyu","Ainu","Cham","Khmer","Thai","Vietnamese","Burmese","Balinese","Malay","Filipino","Mongolian","Korean","Tibetan","Manchu","Uyghur","Hmong","Karen","Pyu","Hawaiian","Fijian","Tongan","Samoan","Maori","Micronesian","Hebrew","Armenian","Circassian","Georgian","Phoenician","Chaldean","Kurdish","Turkic","Kazakh","Uzbek","Kyrgyz","Tajik","Uighur","Pashtun","Baloch","Afghan","Persian","Kenyan","Ugandan","Bhutanese","Latin","Moldovan","Militant","Spartan"],fe=["Empire","Dynasty","Kingdom","Queendom","Sultanate","Confederation","Union","Republic","Caliphate","Dominion","Realm","State","Federation","Territory","Commonwealth","League","Duchy","Province","Protectorate","Colony","Mandate","Free State","Canton","Region","Nation","Assembly","Hierarchy","Archduchy","Grand Duchy","Metropolis","Cluster","Alliance","Tribunal","Council","Confederacy","Order","Regime","Dominion","Syndicate","Guild","Corporation","Patriarchy","Matriarchy","Legion","Horde","Clan","Brotherhood","Sisterhood","Ascendancy","Supremacy","Province","Tribe","Dominion","Assembly","Republics","Army","Dictatorship","Country","Oligarchy","Monkdom","Throng","Host","Area","District","Fief","Wilderness","Settlement","Parliament","Anarchy","Democracy","Autocracy"];class ye{constructor(t,e){this.gs=t,this.bots=[],this.random=new it(n(e))}spawnBots(t){let e=0;for(;this.bots.length<t;){if(e>1e4)return console.log("too many retries while spawning bots, giving up"),this.bots;const t=this.randomBotName(),i=this.spawnBot(t);null!==i?this.bots.push(i):e++}return this.bots}spawnBot(t){const e=this.randTile();if(!this.gs.isLand(e))return null;for(const t of this.bots)if(this.gs.manhattanDist(t.tile,e)<30)return null;return new pe(new z(t,F.Bot,null,this.random.nextID()),e)}randomBotName(){const t=this.random.nextInt(0,me.length),e=this.random.nextInt(0,fe.length);return`${me[t]} ${fe[e]}`}randTile(){return this.gs.ref(this.random.nextInt(0,this.gs.width()),this.random.nextInt(0,this.gs.height()))}}var we,be,Me;!function(t){t[t.Tile=0]="Tile",t[t.Unit=1]="Unit",t[t.Player=2]="Player",t[t.DisplayEvent=3]="DisplayEvent",t[t.DisplayChatEvent=4]="DisplayChatEvent",t[t.AllianceRequest=5]="AllianceRequest",t[t.AllianceRequestReply=6]="AllianceRequestReply",t[t.BrokeAlliance=7]="BrokeAlliance",t[t.AllianceExpired=8]="AllianceExpired",t[t.AllianceExtension=9]="AllianceExtension",t[t.TargetPlayer=10]="TargetPlayer",t[t.Emoji=11]="Emoji",t[t.Win=12]="Win",t[t.Hash=13]="Hash",t[t.UnitIncoming=14]="UnitIncoming",t[t.BonusEvent=15]="BonusEvent",t[t.RailroadEvent=16]="RailroadEvent",t[t.ConquestEvent=17]="ConquestEvent",t[t.EmbargoEvent=18]="EmbargoEvent"}(we||(we={})),function(t){t[t.VERTICAL=0]="VERTICAL",t[t.HORIZONTAL=1]="HORIZONTAL",t[t.TOP_LEFT=2]="TOP_LEFT",t[t.TOP_RIGHT=3]="TOP_RIGHT",t[t.BOTTOM_LEFT=4]="BOTTOM_LEFT",t[t.BOTTOM_RIGHT=5]="BOTTOM_RIGHT"}(be||(be={}));class Te{onStop(t,e,i){const s=e.unit.owner(),r=i.owner(),n=t.config().trainGold(Ee(r,s));r!==s&&s.addGold(n,e.tile()),r.addGold(n,e.tile())}}class _e{constructor(t){this.random=t}onStop(t,e,i){const s=e.unit.owner(),r=i.owner(),n=t.config().trainGold(Ee(r,s));r.addGold(n,e.tile()),r!==s&&s.addGold(n,e.tile())}}class ve{onStop(t,e,i){}}class Ae{constructor(t,e){var i;this.mg=t,this.unit=e,this.stopHandlers={},this.railroads=new Set,this.stopHandlers=(i=new it(t.ticks()),{[N.City]:new Te,[N.Port]:new _e(i),[N.Factory]:new ve})}tradeAvailable(t){const e=this.unit.owner();return t===e||e.canTrade(t)}clearRailroads(){this.railroads.clear()}addRailroad(t){this.railroads.add(t)}removeNeighboringRails(t){const e=[...this.railroads].find((e=>e.from===t||e.to===t));if(e){const t=e.tiles.map((t=>({tile:t,railType:be.VERTICAL})));this.mg.addUpdate({type:we.RailroadEvent,isActive:!1,railTiles:t}),this.railroads.delete(e)}}neighbors(){const t=[];for(const e of this.railroads)e.from!==this?t.push(e.from):t.push(e.to);return t}tile(){return this.unit.tile()}isActive(){return this.unit.isActive()}getRailroads(){return this.railroads}setCluster(t){this.cluster=t}getCluster(){return this.cluster}onTrainStop(t){const e=this.unit.type(),i=this.stopHandlers[e];i&&i.onStop(this.mg,this,t)}}class Se{constructor(t){this.game=t}neighbors(t){return t.neighbors()}cost(t){return 1}position(t){return{x:this.game.x(t.tile()),y:this.game.y(t.tile())}}isTraversable(t,e){return!0}}class ke{constructor(){this.stations=new Set}has(t){return this.stations.has(t)}addStation(t){this.stations.add(t),t.setCluster(this)}removeStation(t){this.stations.delete(t)}addStations(t){for(const e of t)this.addStation(e)}merge(t){for(const e of t.stations)this.addStation(e)}availableForTrade(t){const e=new Set;for(const i of this.stations)i.unit.type()!==N.City&&i.unit.type()!==N.Port||!i.tradeAvailable(t)||e.add(i);return e}size(){return this.stations.size}clear(){this.stations.clear()}}function Ee(t,e){return t===e?"self":t.isOnSameTeam(e)?"team":t.isAlliedWith(e)?"ally":"other"}class Ie{constructor(t,e,i){this.from=t,this.to=e,this.tiles=i}delete(t){const e=this.tiles.map((t=>({tile:t,railType:be.VERTICAL})));t.addUpdate({type:we.RailroadEvent,isActive:!1,railTiles:e}),this.from.getRailroads().delete(this),this.to.getRailroads().delete(this)}}function De(t,e){for(const i of t.getRailroads()){if(i.from===e)return new je(i,!1);if(i.to===e)return new je(i,!0)}return null}class je{constructor(t,e){this.railroad=t,this.forward=e,this.tiles=[],this.tiles=this.forward?this.railroad.tiles:[...this.railroad.tiles].reverse()}getTiles(){return this.tiles}getStart(){return this.forward?this.railroad.from:this.railroad.to}getEnd(){return this.forward?this.railroad.to:this.railroad.from}}class Ce{constructor(t,e,i,s,r){this.railNetwork=t,this.player=e,this.source=i,this.destination=s,this.numCars=r,this.active=!0,this.mg=null,this.train=null,this.cars=[],this.hasCargo=!1,this.currentTile=0,this.spacing=2,this.usedTiles=[],this.stations=[],this.currentRailroad=null,this.speed=2}owner(){return this.player}init(t,e){this.mg=t;const i=this.railNetwork.findStationsPath(this.source,this.destination);if(!i||i.length<=1)return void(this.active=!1);this.stations=i;const s=De(this.stations[0],this.stations[1]);if(!s)return void(this.active=!1);this.currentRailroad=s;const r=this.player.canBuild(N.Train,this.stations[0].tile());if(!1===r)return console.warn("cannot build train"),void(this.active=!1);this.train=this.createTrainUnits(r)}tick(t){if(null===this.train)throw new Error("Not initialized");if(!this.train.isActive()||!this.activeSourceOrDestination())return void this.deleteTrain();const e=this.getNextTile();e?this.updateCarsPositions(e):(this.targetReached(),this.deleteTrain())}loadCargo(){if(!this.hasCargo&&null!==this.train){this.hasCargo=!0;for(let t=1;t<this.cars.length;t++)this.cars[t].setLoaded(!0)}}targetReached(){null!==this.train&&(this.train.setReachedTarget(),this.cars.forEach((t=>{t.setReachedTarget()})))}createTrainUnits(t){const e=this.player.buildUnit(N.Train,t,{targetUnit:this.destination.unit,trainType:O.Engine});this.cars.push(this.player.buildUnit(N.Train,t,{targetUnit:this.destination.unit,trainType:O.Engine}));for(let e=0;e<this.numCars;e++)this.cars.push(this.player.buildUnit(N.Train,t,{trainType:O.Carriage,loaded:this.hasCargo}));return e}deleteTrain(){this.active=!1,this.train?.isActive()&&this.train.delete(!1);for(const t of this.cars)t.isActive()&&t.delete(!1)}activeSourceOrDestination(){return this.stations.length>1&&this.stations[1].isActive()&&this.stations[0].isActive()}saveTraversedTiles(t,e){if(!this.currentRailroad)return;let i=t;for(let t=0;t<e&&i<this.currentRailroad.getTiles().length;t++)this.saveTile(this.currentRailroad.getTiles()[i]),i+=1}saveTile(t){this.usedTiles.push(t),this.usedTiles.length>this.cars.length*this.spacing+3&&this.usedTiles.shift()}updateCarsPositions(t){if(this.cars.length>0)for(let t=this.cars.length-1;t>=0;--t){const e=(t+1)*this.spacing+2;this.usedTiles.length>e&&this.cars[t].move(this.usedTiles[e])}null!==this.train&&this.train.move(t)}nextStation(){if(this.stations.length>2){this.stations.shift();const t=De(this.stations[0],this.stations[1]);if(t)return this.currentRailroad=t,!0}return!1}canTradeWithDestination(){return this.stations.length>1&&this.stations[1].tradeAvailable(this.player)}getNextTile(){if(null===this.currentRailroad||!this.canTradeWithDestination())return null;this.saveTraversedTiles(this.currentTile,this.speed),this.currentTile=this.currentTile+this.speed;const t=this.currentTile-this.currentRailroad.getTiles().length;if(t>=0){if(this.stationReached(),!this.nextStation())return null;this.currentTile=t,this.saveTraversedTiles(0,t)}return this.currentRailroad.getTiles()[this.currentTile]}stationReached(){if(null===this.mg||null===this.player)throw new Error("Not initialized");this.stations[1].onTrainStop(this)}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class xe{constructor(t,e){this.unit=t,this.spawnTrains=e,this.active=!0,this.station=null,this.numCars=5,this.lastSpawnTick=0,this.ticksCooldown=10,this.unit.setTrainStation(!0)}isActive(){return this.active}init(t,e){this.mg=t,this.spawnTrains&&(this.random=new it(t.ticks()))}tick(t){if(void 0===this.mg)throw new Error("Not initialized");this.isActive()&&void 0!==this.unit&&(null===this.station&&(this.station=new Ae(this.mg,this.unit),this.mg.railNetwork().connectStation(this.station)),this.station.isActive()?this.spawnTrain(this.station,t):this.active=!1)}shouldSpawnTrain(){const t=this.mg.config().trainSpawnRate(this.unit.owner().unitCount(N.Factory));for(let e=0;e<this.unit.level();e++)if(this.random.chance(t))return!0;return!1}spawnTrain(t,e){if(void 0===this.mg)throw new Error("Not initialized");if(!this.spawnTrains)return;if(void 0===this.random)throw new Error("Not initialized");if(e<this.lastSpawnTick+this.ticksCooldown)return;const i=t.getCluster();if(null===i)return;const s=i.availableForTrade(this.unit.owner());if(0===s.size)return;if(!this.shouldSpawnTrain())return;const r=this.random.randFromSet(s);r!==t&&(this.mg.addExecution(new Ce(this.mg.railNetwork(),this.unit.owner(),t,r,this.numCars)),this.lastSpawnTick=e)}activeDuringSpawnPhase(){return!1}}class Pe{constructor(t,e){this.player=t,this.tile=e,this.city=null,this.active=!0}init(t,e){this.mg=t}tick(t){if(null===this.city){const t=this.player.canBuild(N.City,this.tile);if(!1===t)return console.warn("cannot build city"),void(this.active=!1);this.city=this.player.buildUnit(N.City,t,{}),this.createStation()}this.city.isActive()?this.player!==this.city.owner()&&(this.player=this.city.owner()):this.active=!1}isActive(){return this.active}activeDuringSpawnPhase(){return!1}createStation(){null!==this.city&&this.mg.hasUnitNearby(this.city.tile(),this.mg.config().trainStationMaxRange(),N.Factory)&&this.mg.addExecution(new xe(this.city))}}class Re{constructor(t,e,i,s){this.p0=t,this.p1=e,this.p2=i,this.p3=s}getPointAt(t){const e=1-t,i=e*e,s=i*e,r=t*t,n=r*t;return{x:s*this.p0.x+3*i*t*this.p1.x+3*e*r*this.p2.x+n*this.p3.x,y:s*this.p0.y+3*i*t*this.p1.y+3*e*r*this.p2.y+n*this.p3.y}}}class Ne extends Re{constructor(t,e,i,s,r){super(t,e,i,s),this.totalDistance=0,this.cachedPoints=[],this.currentIndex=0,this.computeAllPoints(r,.002)}getAllPoints(){return this.cachedPoints}increment(t){for(this.totalDistance+=t;this.currentIndex<this.cachedPoints.length-1&&this.getDistanceUpToIndex(this.currentIndex+1)<this.totalDistance;)this.currentIndex++;return this.currentIndex>=this.cachedPoints.length-1?null:this.cachedPoints[this.currentIndex]}getCurrentIndex(){return this.currentIndex}computeAllPoints(t,e){this.cachedPoints=[],this.totalDistance=0,this.currentIndex=0;let i=0,s=this.getPointAt(i);this.cachedPoints.push(s);let r=0;for(;i<1;){i=Math.min(i+e,1);const n=this.getPointAt(i),a=n.x-s.x,o=n.y-s.y;r+=Math.sqrt(a*a+o*o),r>=t&&(this.cachedPoints.push(n),r=0),s=n}const n=this.getPointAt(1);0!==this.cachedPoints.length&&n.x===this.cachedPoints[this.cachedPoints.length-1].x&&n.y===this.cachedPoints[this.cachedPoints.length-1].y||this.cachedPoints.push(n)}getDistanceUpToIndex(t){let e=0;for(let i=1;i<=t;i++){const t=this.cachedPoints[i-1],s=this.cachedPoints[i],r=s.x-t.x,n=s.y-t.y;e+=Math.sqrt(r*r+n*n)}return e}}!function(t){t[t.NextTile=0]="NextTile",t[t.Pending=1]="Pending",t[t.Completed=2]="Completed",t[t.PathNotFound=3]="PathNotFound"}(Me||(Me={}));var Oe=i(71451),Be=i.n(Oe);class Ue{constructor(t,e,i,s,r,n=0){this.dst=e,this.iterations=i,this.maxTries=s,this.graph=r,this.directionChangePenalty=n,this.fwdCameFrom=new Map,this.bwdCameFrom=new Map,this.fwdGScore=new Map,this.bwdGScore=new Map,this.meetingPoint=null,this.completed=!1,this.fwdOpenSet=new(Be())(((t,e)=>t.fScore<e.fScore)),this.bwdOpenSet=new(Be())(((t,e)=>t.fScore<e.fScore)),this.sources=Array.isArray(t)?t:[t],this.closestSource=this.findClosestSource(e),this.sources.forEach((t=>{this.fwdGScore.set(t,0),this.fwdOpenSet.add({tile:t,fScore:this.heuristic(t,e)})})),this.bwdGScore.set(e,0),this.bwdOpenSet.add({tile:e,fScore:this.heuristic(e,this.findClosestSource(e))})}findClosestSource(t){return this.sources.reduce(((e,i)=>this.heuristic(t,i)<this.heuristic(t,e)?i:e))}compute(){if(this.completed)return Me.Completed;this.maxTries-=1;let t=this.iterations;for(;!this.fwdOpenSet.isEmpty()&&!this.bwdOpenSet.isEmpty();){if(t--,t<=0)return this.maxTries<=0?Me.PathNotFound:Me.Pending;const e=this.fwdOpenSet.poll().tile;if(this.bwdGScore.has(e))return this.meetingPoint=e,this.completed=!0,Me.Completed;this.expandNode(e,!0);const i=this.bwdOpenSet.poll().tile;if(this.fwdGScore.has(i))return this.meetingPoint=i,this.completed=!0,Me.Completed;this.expandNode(i,!1)}return this.completed?Me.Completed:Me.PathNotFound}expandNode(t,e){for(const i of this.graph.neighbors(t)){if(i!==(e?this.dst:this.closestSource)&&!this.graph.isTraversable(t,i))continue;const s=e?this.fwdGScore:this.bwdGScore,r=e?this.fwdOpenSet:this.bwdOpenSet,n=e?this.fwdCameFrom:this.bwdCameFrom,a=s.get(t)+this.graph.cost(i);let o=0;if(this.directionChangePenalty>0){const e=n.get(t);e&&this.getDirection(e,t)!==this.getDirection(t,i)&&(o=this.directionChangePenalty)}const h=a+o;if(!s.has(i)||h<s.get(i)){n.set(i,t),s.set(i,h);const a=h+this.heuristic(i,e?this.dst:this.closestSource);r.add({tile:i,fScore:a})}}}heuristic(t,e){const i=this.graph.position(t),s=this.graph.position(e);return 2*(Math.abs(i.x-s.x)+Math.abs(i.y-s.y))}getDirection(t,e){const i=this.graph.position(t),s=this.graph.position(e),r=s.x-i.x,n=s.y-i.y;return`${Math.sign(r)},${Math.sign(n)}`}reconstructPath(){if(!this.meetingPoint)return[];const t=[this.meetingPoint];let e=this.meetingPoint;for(;this.fwdCameFrom.has(e);)e=this.fwdCameFrom.get(e),t.unshift(e);for(e=this.meetingPoint;this.bwdCameFrom.has(e);)e=this.bwdCameFrom.get(e),t.push(e);return t}}class Le{constructor(t,e){this.gameMap=t,this.waterPath=e,this.waterPenalty=3}neighbors(t){return this.gameMap.neighbors(t)}cost(t){let e=this.gameMap.cost(t);return!this.waterPath&&this.gameMap.isWater(t)&&(e+=this.waterPenalty),e}position(t){return{x:this.gameMap.x(t),y:this.gameMap.y(t)}}isTraversable(t,e){const i=this.gameMap.isWater(e);if(this.waterPath)return i;const s=this.gameMap.isShoreline(t),r=this.gameMap.isShoreline(e);return!i||s||r}}class Fe{constructor(t,e,i,s,r,n,a=!0,o=0){this.gameMap=t,this.miniMap=e,this.src=i,this.dst=s;const h=(Array.isArray(i)?i:[i]).map((e=>this.miniMap.ref(Math.floor(t.x(e)/2),Math.floor(t.y(e)/2)))),l=this.miniMap.ref(Math.floor(t.x(s)/2),Math.floor(t.y(s)/2));this.aStar=new Ue(h,l,r,n,new Le(e,a),o)}compute(){return this.aStar.compute()}reconstructPath(){let t;Array.isArray(this.src)||(t=new G(this.gameMap.x(this.src),this.gameMap.y(this.src)));const e=new G(this.gameMap.x(this.dst),this.gameMap.y(this.dst)),i=function(t,e,i){if(void 0!==i){const e=qe(t,i);-1===e?t.unshift(i):0!==e&&(t=t.slice(e))}const s=qe(t,e);return-1===s?t.push(e):s!==t.length-1&&(t=t.slice(0,s+1)),t}(function(t,e=2){const i=t.map((t=>new G(t.x*e,t.y*e))),s=[];for(let t=0;t<i.length-1;t++){const e=i[t],r=i[t+1];s.push(e);const n=r.x-e.x,a=r.y-e.y,o=Math.max(Math.abs(n),Math.abs(a));for(let t=1;t<o;t++)s.push(new G(Math.round(e.x+n*t/o),Math.round(e.y+a*t/o)))}return i.length>0&&s.push(i[i.length-1]),s}(this.aStar.reconstructPath().map((t=>new G(this.miniMap.x(t),this.miniMap.y(t))))),e,t);return i.map((t=>this.gameMap.ref(t.x,t.y)))}}function qe(t,e){for(let i=0;i<t.length;i++)if(t[i].x===e.x&&t[i].y===e.y)return i;return-1}class $e{constructor(t){this.mg=t}computeControlPoints(t,e,i=3,s=!0){const r={x:this.mg.x(t),y:this.mg.y(t)},n={x:this.mg.x(e),y:this.mg.y(e)},a=n.x-r.x,o=n.y-r.y,h=Math.sqrt(a*a+o*o),l=s?Math.max(h/3,50):0,c={x:r.x+(n.x-r.x)/4,y:Math.max(r.y+(n.y-r.y)/4-l,0)},u={x:r.x+3*(n.x-r.x)/4,y:Math.max(r.y+3*(n.y-r.y)/4-l,0)};this.curve=new Ne(r,c,u,n,i)}nextTile(t){if(!this.curve)throw new Error("ParabolaPathFinder not initialized");const e=this.curve.increment(t);return!e||this.mg.ref(Math.floor(e.x),Math.floor(e.y))}currentIndex(){return this.curve?this.curve.getCurrentIndex():0}allTiles(){return this.curve?this.curve.getAllPoints().map((t=>this.mg.ref(Math.floor(t.x),Math.floor(t.y)))):[]}}class He{constructor(t,e){this.mg=t,this.random=e}nextTile(t,e){const i=this.mg.x(t),s=this.mg.y(t),r=this.mg.x(e),n=this.mg.y(e);if(i===r&&s===n)return!0;let a=i,o=s;const h=Math.floor(1+Math.abs(n-s)/(Math.abs(r-i)+1));return this.random.chance(h)&&i!==r?i<r?a++:i>r&&a--:s<n?o++:s>n&&o--,a===i&&o===s||this.mg.ref(a,o)}}class We{constructor(t,e){this.game=t,this.newAStar=e,this.curr=null,this.dst=null,this.path=null,this.path_idx=0,this.computeFinished=!0}static Mini(t,e,i=!0,s=20){return new We(t,((r,n)=>new Fe(t.map(),t.miniMap(),r,n,e,s,i)))}nextTile(t,e,i=1){if(null===t)return console.error("curr is null"),{type:Me.PathNotFound};if(null===e)return console.error("dst is null"),{type:Me.PathNotFound};if(this.game.manhattanDist(t,e)<i)return this.path=null,{type:Me.Completed,node:t};if(this.computeFinished){if(this.shouldRecompute(t,e))return this.curr=t,this.dst=e,this.path=null,this.path_idx=0,this.aStar=this.newAStar(t,e),this.computeFinished=!1,this.nextTile(t,e);{const t=this.path?.[this.path_idx++];if(void 0===t)throw new Error("missing tile");return{type:Me.NextTile,node:t}}}switch(this.aStar.compute()){case Me.Completed:return this.computeFinished=!0,this.path=this.aStar.reconstructPath(),this.path_idx=1,this.nextTile(t,e);case Me.Pending:return{type:Me.Pending};case Me.PathNotFound:return{type:Me.PathNotFound};default:throw new Error("unexpected compute result")}}shouldRecompute(t,e){if(null===this.path||null===this.curr||null===this.dst)return!0;const i=this.game.manhattanDist(t,e);let s=10;return s=i>50?10:i>25?5:0,this.game.manhattanDist(this.dst,e)>s}}class Ve{constructor(t,e,i,s){this.spawn=t,this._owner=e,this.ownerUnit=i,this.target=s,this.active=!0,this.destroyAtTick=-1}init(t,e){this.pathFinder=new He(t,new it(t.ticks())),this.mg=t,this.random=new it(t.ticks())}tick(t){if(this.shell??(this.shell=this._owner.buildUnit(N.Shell,this.spawn,{})),this.shell.isActive()){if(!this.target.isActive()||this.target.owner()===this.shell.owner()||-1!==this.destroyAtTick&&this.mg.ticks()>=this.destroyAtTick)return this.shell.delete(!1),void(this.active=!1);-1!==this.destroyAtTick||this.ownerUnit.isActive()||(this.destroyAtTick=this.mg.ticks()+this.mg.config().shellLifetime());for(let t=0;t<3;t++){const t=this.pathFinder.nextTile(this.shell.tile(),this.target.tile());if(!0===t)return this.active=!1,this.target.modifyHealth(-this.effectOnTarget(),this._owner),this.shell.setReachedTarget(),void this.shell.delete(!1);this.shell.move(t)}}else this.active=!1}effectOnTarget(){const{damage:t}=this.mg.config().unitInfo(N.Shell),e=t??250,i=25*(this.random.nextInt(1,6)-1)+200;return Math.round(e/250*i)}getEffectOnTargetForTesting(){return this.effectOnTarget()}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class Ge{constructor(t,e){this.player=t,this.tile=e,this.post=null,this.active=!0,this.target=null,this.lastShellAttack=0,this.alreadySentShell=new Set}init(t,e){this.mg=t}shoot(){if(null===this.post)return;if(null===this.target)return;const t=this.mg.config().defensePostShellAttackRate();return this.mg.ticks()-this.lastShellAttack>t&&(this.lastShellAttack=this.mg.ticks(),this.mg.addExecution(new Ve(this.post.tile(),this.post.owner(),this.post,this.target)),!this.target.hasHealth())?(this.alreadySentShell.add(this.target),void(this.target=null)):void 0}tick(t){if(null===this.post){const t=this.player.canBuild(N.DefensePost,this.tile);if(!1===t)return console.warn("cannot build Defense Post"),void(this.active=!1);this.post=this.player.buildUnit(N.DefensePost,t,{})}this.post.isActive()?(this.player!==this.post.owner()&&(this.player=this.post.owner()),null===this.target||this.target.isActive()||(this.target=null)):this.active=!1}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class ze{constructor(t,e){this.player=t,this.tile=e,this.factory=null,this.active=!0}init(t,e){this.game=t}tick(t){if(!this.factory){const t=this.player.canBuild(N.Factory,this.tile);if(!1===t)return console.warn("cannot build factory"),void(this.active=!1);this.factory=this.player.buildUnit(N.Factory,t,{}),this.createStation()}this.factory.isActive()?this.player!==this.factory.owner()&&(this.player=this.factory.owner()):this.active=!1}isActive(){return this.active}activeDuringSpawnPhase(){return!1}createStation(){if(null!==this.factory){const t=this.game.nearbyUnits(this.factory.tile(),this.game.config().trainStationMaxRange(),[N.City,N.Port,N.Factory]);this.game.addExecution(new xe(this.factory,!0));for(const{unit:e}of t)e.hasTrainStation()||this.game.addExecution(new xe(e))}}}class Ke{constructor(t,e,i,s,r=-1,n=0){this.nukeType=t,this.player=e,this.dst=i,this.src=s,this.speed=r,this.waitTicks=n,this.active=!0,this.nuke=null}init(t,e){this.mg=t,-1===this.speed&&(this.speed=this.mg.config().defaultNukeSpeed()),this.pathFinder=new $e(t)}target(){return this.mg.owner(this.dst)}tilesToDestroy(){if(void 0!==this.tilesToDestroyCache)return this.tilesToDestroyCache;if(null===this.nuke)throw new Error("Not initialized");const t=this.mg.config().nukeMagnitudes(this.nuke.type()),e=new it(this.mg.ticks()),i=t.inner*t.inner,s=t.outer*t.outer;return this.tilesToDestroyCache=this.mg.bfs(this.dst,((t,r)=>{const n=this.mg?.euclideanDistSquared(this.dst,r)??0;return n<=s&&(n<=i||e.chance(2))})),this.tilesToDestroyCache}maybeBreakAlliances(t){if(null===this.nuke)throw new Error("Not initialized");const e=new Map;for(const i of t){const t=this.mg.owner(i);if(t.isPlayer()){const i=e.get(t)??0;e.set(t,i+1)}}const i=this.mg.config().nukeAllianceBreakThreshold();for(const[t,s]of e)if(s>i&&this.nuke.type()!==N.MIRVWarhead){const e=t.incomingAllianceRequests().find((t=>t.requestor()===this.player));e&&e?.reject();const i=this.player.allianceWith(t);null!==i&&this.player.breakAlliance(i),t!==this.player&&t.updateRelation(this.player,-100)}}tick(t){if(null===this.nuke){const t=this.src??this.player.canBuild(this.nukeType,this.dst);if(!1===t)return console.warn("cannot build Nuke"),void(this.active=!1);if(this.src=t,this.pathFinder.computeControlPoints(t,this.dst,this.speed,this.nukeType!==N.MIRVWarhead),this.nuke=this.player.buildUnit(this.nukeType,t,{targetTile:this.dst,trajectory:this.getTrajectory(this.dst)}),this.maybeBreakAlliances(this.tilesToDestroy()),this.mg.hasOwner(this.dst)){const t=this.mg.owner(this.dst);t.isPlayer()&&(this.nukeType===N.AtomBomb?this.mg.displayIncomingUnit(this.nuke.id(),`${this.player.name()} - atom bomb inbound`,q.NUKE_INBOUND,t.id()):this.nukeType===N.HydrogenBomb&&this.mg.displayIncomingUnit(this.nuke.id(),`${this.player.name()} - hydrogen bomb inbound`,q.HYDROGEN_BOMB_INBOUND,t.id())),this.mg.stats().bombLaunch(this.player,t,this.nukeType)}const e=this.player.units(N.MissileSilo).find((e=>e.tile()===t));return void(e&&e.launch())}if(!this.nuke.isActive())return console.log("Nuke destroyed before reaching target"),void(this.active=!1);if(this.waitTicks>0)return void this.waitTicks--;const e=this.pathFinder.nextTile(this.speed);!0!==e?(this.updateNukeTargetable(),this.nuke.move(e),this.nuke.setTrajectoryIndex(this.pathFinder.currentIndex())):this.detonate()}getNuke(){return this.nuke}getTrajectory(t){const e=[],i=this.mg.config().defaultNukeTargetableRange()**2,s=this.pathFinder.allTiles();for(const r of s)e.push({tile:r,targetable:this.isTargetable(t,r,i)});return e}isTargetable(t,e,i){return this.mg.euclideanDistSquared(e,t)<i||void 0!==this.src&&null!==this.src&&this.mg.euclideanDistSquared(this.src,e)<i}updateNukeTargetable(){if(null===this.nuke||void 0===this.nuke.targetTile())return;const t=this.mg.config().defaultNukeTargetableRange()**2,e=this.nuke.targetTile();this.nuke.setTargetable(this.isTargetable(e,this.nuke.tile(),t))}detonate(){if(null===this.nuke)throw new Error("Not initialized");const t=this.mg.config().nukeMagnitudes(this.nuke.type()),e=this.tilesToDestroy();this.maybeBreakAlliances(e);const i=this.target().isPlayer()?this.mg.config().maxTroops(this.target()):1;for(const t of e){const e=this.mg.owner(t);e.isPlayer()&&(e.relinquish(t),e.removeTroops(this.mg.config().nukeDeathFactor(this.nukeType,e.troops(),e.numTilesOwned(),i)),e.outgoingAttacks().forEach((t=>{const s=this.mg?.config().nukeDeathFactor(this.nukeType,t.troops(),e.numTilesOwned(),i)??0;t.setTroops(t.troops()-s)})),e.units(N.TransportShip).forEach((t=>{const s=this.mg?.config().nukeDeathFactor(this.nukeType,t.troops(),e.numTilesOwned(),i)??0;t.setTroops(t.troops()-s)}))),this.mg.isLand(t)&&this.mg.setFallout(t,!0)}const s=t.outer*t.outer;for(const t of this.mg.units())t.type()!==N.AtomBomb&&t.type()!==N.HydrogenBomb&&t.type()!==N.MIRVWarhead&&t.type()!==N.MIRV&&this.mg.euclideanDistSquared(this.dst,t.tile())<s&&t.delete(!0,this.player);this.redrawBuildings(t.outer+16),this.active=!1,this.nuke.setReachedTarget(),this.nuke.delete(!1),this.mg.stats().bombLand(this.player,this.target(),this.nuke.type())}redrawBuildings(t){const e=t*t;for(const t of this.mg.units())i=t.type(),B.has(i)&&this.mg.euclideanDistSquared(this.dst,t.tile())<e&&t.touch();var i}owner(){return this.player}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class Ye{constructor(t,e){this.player=t,this.dst=e,this.active=!0,this.nuke=null,this.mirvRange=1500,this.warheadCount=350,this.speed=-1}init(t,e){if(this.random=new it(t.ticks()+n(this.player.id())),this.mg=t,this.pathFinder=new $e(t),this.targetPlayer=this.mg.owner(this.dst),this.speed=this.mg.config().defaultNukeSpeed(),this.mg.stats().bombLaunch(this.player,this.targetPlayer,N.MIRV),this.targetPlayer.isPlayer()){const t=this.player.allianceWith(this.targetPlayer);null!==t&&this.player.breakAlliance(t),this.targetPlayer!==this.player&&this.targetPlayer.updateRelation(this.player,-100)}}tick(t){if(null===this.nuke){const t=this.player.canBuild(N.MIRV,this.dst);if(!1===t)return console.warn("cannot build MIRV"),void(this.active=!1);this.nuke=this.player.buildUnit(N.MIRV,t,{targetTile:this.dst});const e=Math.floor((this.mg.x(this.dst)+this.mg.x(this.mg.x(this.nuke.tile())))/2),i=Math.max(0,this.mg.y(this.dst)-500)+50;this.separateDst=this.mg.ref(e,i),this.pathFinder.computeControlPoints(t,this.separateDst),this.mg.displayIncomingUnit(this.nuke.id(),`âš ï¸âš ï¸âš ï¸ ${this.player.name()} - MIRV INBOUND âš ï¸âš ï¸âš ï¸`,q.MIRV_INBOUND,this.targetPlayer.id())}const e=this.pathFinder.nextTile(this.speed);if(!0===e)return this.separate(),this.active=!1,void this.mg.stats().bombLand(this.player,this.targetPlayer,N.MIRV);this.nuke.move(e)}separate(){if(null===this.nuke)throw new Error("uninitialized");const t=[this.dst];let e=1e3;for(;e>0&&t.length<this.warheadCount;){e--;const i=this.randomLand(this.dst,t);null!==i&&t.push(i)}console.log(`dsts: ${t.length}`),t.sort(((t,e)=>this.mg.manhattanDist(e,this.dst)-this.mg.manhattanDist(t,this.dst))),console.log(`got ${t.length} dsts!!`);for(const[e,i]of t.entries())this.mg.addExecution(new Ke(N.MIRVWarhead,this.player,i,this.nuke.tile(),15+Math.floor(e/this.warheadCount*5),this.random.nextInt(0,15)));this.nuke.delete(!1)}randomLand(t,e){let i=0;const s=this.mirvRange*this.mirvRange;for(;i<100;){i++;const r=this.random.nextInt(this.mg.x(t)-this.mirvRange,this.mg.x(t)+this.mirvRange),n=this.random.nextInt(this.mg.y(t)-this.mirvRange,this.mg.y(t)+this.mirvRange);if(!this.mg.isValidCoord(r,n))continue;const a=this.mg.ref(r,n);if(this.mg.isLand(a)&&!(this.mg.euclideanDistSquared(a,t)>s||this.mg.owner(a)!==this.targetPlayer||this.proximityCheck(a,e)))return a}return console.log("couldn't find place, giving up"),null}proximityCheck(t,e){for(const i of e)if(this.mg.manhattanDist(t,i)<55)return!0;return!1}owner(){return this.player}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class Xe{constructor(t,e){this.player=t,this.tile=e,this.active=!0,this.silo=null}init(t,e){this.mg=t}tick(t){if(null===this.silo){const t=this.player.canBuild(N.MissileSilo,this.tile);if(!1===t)return console.warn(`player ${this.player} cannot build missile silo at ${this.tile}`),void(this.active=!1);this.silo=this.player.buildUnit(N.MissileSilo,t,{}),this.player!==this.silo.owner()&&(this.player=this.silo.owner())}const e=this.silo.missileTimerQueue()[0];void 0!==e&&this.mg.config().SiloCooldown()-(this.mg.ticks()-e)<=0&&this.silo.reloadMissile()}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class Qe{constructor(t,e,i){this.origOwner=t,this.srcPort=e,this._dstPort=i,this.active=!0,this.wasCaptured=!1,this.tilesTraveled=0}init(t,e){this.mg=t,this.pathFinder=We.Mini(t,2500)}tick(t){if(void 0===this.tradeShip){const e=this.origOwner.canBuild(N.TradeShip,this.srcPort.tile());if(!1===e)return console.warn("cannot build trade ship"),void(this.active=!1);this.tradeShip=this.origOwner.buildUnit(N.TradeShip,e,{targetUnit:this._dstPort,lastSetSafeFromPirates:t}),this.mg.stats().boatSendTrade(this.origOwner,this._dstPort.owner())}if(!this.tradeShip.isActive())return void(this.active=!1);const e=this.tradeShip.owner(),i=this._dstPort.owner();if(!0!==this.wasCaptured&&this.origOwner!==e&&(this.wasCaptured=!0),i.id()===this.srcPort.owner().id())return this.tradeShip.delete(!1),void(this.active=!1);if(!(this.wasCaptured||this._dstPort.isActive()&&e.canTrade(i)))return this.tradeShip.delete(!1),void(this.active=!1);if(this.wasCaptured&&(e!==i||!this._dstPort.isActive())){const t=this.tradeShip.owner().units(N.Port).sort(r(this.mg,this.tradeShip));if(0===t.length)return this.tradeShip.delete(!1),void(this.active=!1);this._dstPort=t[0],this.tradeShip.setTargetUnit(this._dstPort)}const s=this.tradeShip.tile();if(s===this.dstPort())return void this.complete();const n=this.pathFinder.nextTile(s,this._dstPort.tile());switch(n.type){case Me.Pending:this.tradeShip.move(s);break;case Me.NextTile:this.mg.isWater(n.node)&&this.mg.isShoreline(n.node)&&this.tradeShip.setSafeFromPirates(),this.tradeShip.move(n.node),this.tilesTraveled++;break;case Me.Completed:this.complete();break;case Me.PathNotFound:console.warn("captured trade ship cannot find route"),this.tradeShip.isActive()&&this.tradeShip.delete(!1),this.active=!1}}complete(){this.active=!1,this.tradeShip.delete(!1);const t=this.mg.config().tradeShipGold(this.tilesTraveled,this.tradeShip.owner().unitCount(N.Port));this.wasCaptured?(this.tradeShip.owner().addGold(t,this._dstPort.tile()),this.mg.displayMessage(`Received ${Kt(t)} gold from ship captured from ${this.origOwner.displayName()}`,q.CAPTURED_ENEMY_UNIT,this.tradeShip.owner().id(),t)):(this.srcPort.owner().addGold(t),this._dstPort.owner().addGold(t,this._dstPort.tile()),this.mg.displayMessage(`Received ${Kt(t)} gold from trade with ${this.srcPort.owner().displayName()}`,q.RECEIVED_GOLD_FROM_TRADE,this._dstPort.owner().id(),t),this.mg.displayMessage(`Received ${Kt(t)} gold from trade with ${this._dstPort.owner().displayName()}`,q.RECEIVED_GOLD_FROM_TRADE,this.srcPort.owner().id(),t))}isActive(){return this.active}activeDuringSpawnPhase(){return!1}dstPort(){return this._dstPort.tile()}}class Je{constructor(t,e){this.player=t,this.tile=e,this.active=!0,this.port=null}init(t,e){this.mg=t,this.random=new it(t.ticks()),this.checkOffset=t.ticks()%10}tick(t){if(null===this.mg||null===this.random||null===this.checkOffset)throw new Error("Not initialized");if(null===this.port){const t=this.tile,e=this.player.canBuild(N.Port,t);if(!1===e)return console.warn(`player ${this.player.id()} cannot build port at ${this.tile}`),void(this.active=!1);this.port=this.player.buildUnit(N.Port,e,{}),this.createStation()}if(!this.port.isActive())return void(this.active=!1);if(this.player.id()!==this.port.owner().id()&&(this.player=this.port.owner()),(this.mg.ticks()+this.checkOffset)%10!=0)return;if(!this.shouldSpawnTradeShip())return;const e=this.tradingPorts();if(0===e.length)return;const i=this.random.randElement(e);this.mg.addExecution(new Qe(this.player,this.port,i))}isActive(){return this.active}activeDuringSpawnPhase(){return!1}shouldSpawnTradeShip(){const t=this.mg.unitCount(N.TradeShip),e=this.player.unitCount(N.Port),i=this.player.unitCount(N.TradeShip),s=this.mg.config().tradeShipSpawnRate(t,e,i);for(let t=0;t<this.port.level();t++)if(this.random.chance(s))return!0;return!1}createStation(){null!==this.port&&this.mg.hasUnitNearby(this.port.tile(),this.mg.config().trainStationMaxRange(),N.Factory)&&this.mg.addExecution(new xe(this.port))}tradingPorts(){const t=this.mg.players().filter((t=>t!==this.port.owner()&&t.canTrade(this.port.owner()))).flatMap((t=>t.units(N.Port))).sort(((t,e)=>this.mg.manhattanDist(this.port.tile(),t.tile())-this.mg.manhattanDist(this.port.tile(),e.tile()))),e=[];for(const[i,s]of t.entries()){const r=new Array(s.level()).fill(s);e.push(...r);const n=this.mg.manhattanDist(this.port.tile(),s.tile())<this.mg.config().tradeShipShortRangeDebuff(),a=i<this.mg.config().proximityBonusPortsNb(t.length);!n&&a&&e.push(...r),!n&&this.port.owner().isFriendly(s.owner())&&e.push(...r)}return e}}class Ze{constructor(t,e,i,s,r){this.spawn=t,this._owner=e,this.ownerUnit=i,this.target=s,this.targetTile=r,this.active=!0,this.speed=0}init(t,e){this.pathFinder=new He(t,new it(t.ticks())),this.mg=t,this.speed=this.mg.config().defaultSamMissileSpeed()}tick(t){if(this.SAMMissile??(this.SAMMissile=this._owner.buildUnit(N.SAMMissile,this.spawn,{})),!this.SAMMissile.isActive())return void(this.active=!1);const e=[N.AtomBomb,N.HydrogenBomb];if(!this.target.isActive()||!this.ownerUnit.isActive()||this.target.owner()===this.SAMMissile.owner()||!e.includes(this.target.type()))return this.SAMMissile.delete(!1),void(this.active=!1);for(let t=0;t<this.speed;t++){const t=this.pathFinder.nextTile(this.SAMMissile.tile(),this.targetTile);if(!0===t)return this.mg.displayMessage(`Missile intercepted ${this.target.type()}`,q.SAM_HIT,this._owner.id()),this.active=!1,this.target.delete(!0,this._owner),this.SAMMissile.delete(!1),void this.mg.stats().bombIntercept(this._owner,this.target.type(),1);this.SAMMissile.move(t)}}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class ti{constructor(t,e){this.mg=t,this.sam=e,this.precomputedNukes=new Map,this.missileSpeed=this.mg.config().defaultSamMissileSpeed()}updateUnreachableNukes(t){const e=new Set(t.map((t=>t.unit.id())));for(const t of this.precomputedNukes.keys())e.has(t)||this.precomputedNukes.delete(t)}isInRange(t){const e=this.sam.tile(),i=this.mg.config().samRange(this.sam.level()),s=i*i;return this.mg.euclideanDistSquared(e,t)<=s}tickToReach(t,e){return Math.ceil(this.mg.manhattanDist(t,e)/this.missileSpeed)}computeInterceptionTile(t){const e=t.trajectory(),i=this.sam.tile(),s=t.trajectoryIndex(),r=e.length-s;for(let t=s;t<e.length;t++){const n=e[t];if(n.targetable&&this.isInRange(n.tile)){const e=t-s,a=this.tickToReach(i,n.tile),o=e-a;if(a<r&&o>=0)return{tick:o,tile:n.tile}}}}getSingleTarget(t){const e=2*this.mg.config().maxSamRange(),i=this.mg.nearbyUnits(this.sam.tile(),e,[N.AtomBomb,N.HydrogenBomb],(({unit:t})=>K(t)&&t.owner()!==this.sam.owner()&&!this.sam.owner().isFriendly(t.owner())));this.updateUnreachableNukes(i);const s=[];for(const e of i){const i=e.unit.id(),r=this.precomputedNukes.get(i);if(void 0!==r){if(null===r)continue;if(r.tick===t){s.push({tile:r.tile,unit:e.unit}),this.precomputedNukes.delete(i);continue}if(r.tick>t)continue;this.precomputedNukes.delete(i)}const n=this.computeInterceptionTile(e.unit);void 0!==n?n.tick<=1?s.push({unit:e.unit,tile:n.tile}):this.precomputedNukes.set(i,{tick:n.tick+t,tile:n.tile}):this.precomputedNukes.set(i,null)}return s.sort(((t,e)=>t.unit.type()===N.HydrogenBomb&&e.unit.type()!==N.HydrogenBomb?-1:t.unit.type()!==N.HydrogenBomb&&e.unit.type()===N.HydrogenBomb?1:0))[0]??null}}class ei{constructor(t,e,i=null){this.player=t,this.tile=e,this.sam=i,this.active=!0,this.MIRVWarheadSearchRadius=400,this.MIRVWarheadProtectionRadius=50,null!==i&&(this.tile=i.tile())}init(t,e){this.mg=t}isHit(t,e){return t===N.AtomBomb||(t===N.MIRVWarhead?e<this.mg.config().samWarheadHittingChance():e<this.mg.config().samHittingChance())}tick(t){if(null===this.mg||null===this.player)throw new Error("Not initialized");if(null===this.sam){if(null===this.tile)throw new Error("tile is null");const t=this.player.canBuild(N.SAMLauncher,this.tile);if(!1===t)return console.warn("cannot build SAM Launcher"),void(this.active=!1);this.sam=this.player.buildUnit(N.SAMLauncher,t,{})}if(this.targetingSystem??(this.targetingSystem=new ti(this.mg,this.sam)),this.sam.isInCooldown()){const t=this.sam.missileTimerQueue()[0];if(void 0===t)return;return void(this.mg.config().SAMCooldown()-(this.mg.ticks()-t)<=0&&this.sam.reloadMissile())}if(!this.sam.isActive())return void(this.active=!1);this.player!==this.sam.owner()&&(this.player=this.sam.owner()),this.pseudoRandom??(this.pseudoRandom=new it(this.sam.id()));const e=this.mg.nearbyUnits(this.sam.tile(),this.MIRVWarheadSearchRadius,N.MIRVWarhead,(({unit:t})=>{if(!K(t))return!1;if(t.owner()===this.player)return!1;if(this.player.isFriendly(t.owner()))return!1;const e=t.targetTile();return null!==this.sam&&void 0!==e&&this.mg.manhattanDist(e,this.sam.tile())<this.MIRVWarheadProtectionRadius}));let i=null;if(0===e.length&&(i=this.targetingSystem.getSingleTarget(t),null!==i&&console.log("Target acquired")),i&&!i.unit.targetedBySAM()||e.length>0){this.sam.launch();const t=e.length>0?N.MIRVWarhead:i?.unit.type();if(void 0===t)throw new Error("Unknown unit type");const s=this.pseudoRandom.next();if(this.isHit(t,s))if(e.length>0){const t=this.sam.owner();this.mg.displayMessage(`${e.length} MIRV warheads intercepted`,q.SAM_HIT,t.id()),e.forEach((({unit:t})=>{t.delete()})),this.mg.stats().bombIntercept(t,N.MIRVWarhead,e.length)}else{if(null===i)throw new Error("target is null");i.unit.setTargetedBySAM(!0),this.mg.addExecution(new Ze(this.sam.tile(),this.sam.owner(),this.sam,i.unit,i.tile))}else this.mg.displayMessage(`Missile failed to intercept ${t}`,q.SAM_MISS,this.sam.owner().id())}}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class ii{constructor(t){this.input=t,this.lastShellAttack=0,this.alreadySentShell=new Set}init(t,e){if(this.mg=t,this.pathfinder=We.Mini(t,1e4,!0,100),this.random=new it(t.ticks()),K(this.input))this.warship=this.input;else{const t=this.input.owner.canBuild(N.Warship,this.input.patrolTile);if(!1===t)return void console.warn(`Failed to spawn warship for ${this.input.owner.name()} at ${this.input.patrolTile}`);this.warship=this.input.owner.buildUnit(N.Warship,t,this.input)}}tick(t){this.warship.health()<=0?this.warship.delete():(this.warship.owner().unitCount(N.Port)>0&&this.warship.modifyHealth(1),this.warship.setTargetUnit(this.findTargetUnit()),this.warship.targetUnit()?.type()!==N.TradeShip?(this.patrol(),void 0===this.warship.targetUnit()||this.shootTarget()):this.huntDownTradeShip())}findTargetUnit(){const t=this.warship.owner().unitCount(N.Port)>0,e=this.mg.config().warshipPatrolRange()**2,i=this.mg.nearbyUnits(this.warship.tile(),this.mg.config().warshipTargettingRange(),[N.TransportShip,N.Warship,N.TradeShip]),s=[];for(const{unit:r,distSquared:n}of i)if(r.owner()!==this.warship.owner()&&r!==this.warship&&!r.owner().isFriendly(this.warship.owner(),!0)&&!this.alreadySentShell.has(r)){if(r.type()===N.TradeShip){if(!t||r.isSafeFromPirates()||r.targetUnit()?.owner()===this.warship.owner()||r.targetUnit()?.owner().isFriendly(this.warship.owner()))continue;if(this.mg.euclideanDistSquared(this.warship.patrolTile(),r.tile())>e)continue}s.push({unit:r,distSquared:n})}return s.sort(((t,e)=>{const{unit:i,distSquared:s}=t,{unit:r,distSquared:n}=e;return i.type()===N.TransportShip&&r.type()!==N.TransportShip?-1:i.type()!==N.TransportShip&&r.type()===N.TransportShip?1:i.type()===N.Warship&&r.type()!==N.Warship?-1:i.type()!==N.Warship&&r.type()===N.Warship?1:s-n}))[0]?.unit}shootTarget(){const t=this.mg.config().warshipShellAttackRate();if(this.mg.ticks()-this.lastShellAttack>t&&(this.warship.targetUnit()?.type()!==N.TransportShip&&(this.lastShellAttack=this.mg.ticks()),this.mg.addExecution(new Ve(this.warship.tile(),this.warship.owner(),this.warship,this.warship.targetUnit())),!this.warship.targetUnit().hasHealth()))return this.alreadySentShell.add(this.warship.targetUnit()),void this.warship.setTargetUnit(void 0)}huntDownTradeShip(){for(let t=0;t<2;t++){const t=this.pathfinder.nextTile(this.warship.tile(),this.warship.targetUnit().tile(),5);switch(t.type){case Me.Completed:return this.warship.owner().captureUnit(this.warship.targetUnit()),this.warship.setTargetUnit(void 0),void this.warship.move(this.warship.tile());case Me.NextTile:this.warship.move(t.node);break;case Me.Pending:this.warship.touch();break;case Me.PathNotFound:console.log("path not found to target")}}}patrol(){if(void 0===this.warship.targetTile()&&(this.warship.setTargetTile(this.randomTile()),void 0===this.warship.targetTile()))return;const t=this.pathfinder.nextTile(this.warship.tile(),this.warship.targetTile());switch(t.type){case Me.Completed:this.warship.setTargetTile(void 0),this.warship.move(t.node);break;case Me.NextTile:this.warship.move(t.node);break;case Me.Pending:return void this.warship.touch();case Me.PathNotFound:console.warn("path not found to target tile"),this.warship.setTargetTile(void 0)}}isActive(){return this.warship?.isActive()}activeDuringSpawnPhase(){return!1}randomTile(t=!1){let e=this.mg.config().warshipPatrolRange(),i=0,s=0;for(;s<3;){const r=this.mg.x(this.warship.patrolTile())+this.random.nextInt(-e/2,e/2),n=this.mg.y(this.warship.patrolTile())+this.random.nextInt(-e/2,e/2);if(!this.mg.isValidCoord(r,n))continue;const a=this.mg.ref(r,n);if(this.mg.isOcean(a)&&(t||!this.mg.isShoreline(a)))return a;i++,500===i&&(s++,i=0,e+=Math.floor(e/2))}if(console.warn(`Failed to find random tile for warship for ${this.warship.owner().name()}`),!t)return this.randomTile(!0)}}class si{constructor(t,e,i){this.player=t,this.constructionType=e,this.tile=i,this.construction=null,this.active=!0}init(t,e){return this.mg=t,this.mg.config().isUnitDisabled(this.constructionType)?(console.warn(`cannot build construction ${this.constructionType} because it is disabled`),void(this.active=!1)):this.mg.isValidRef(this.tile)?void 0:(console.warn(`cannot build construction invalid tile ${this.tile}`),void(this.active=!1))}tick(t){if(null===this.construction){const t=this.mg.unitInfo(this.constructionType);if(void 0===t.constructionDuration)return this.completeConstruction(),void(this.active=!1);const e=this.player.canBuild(this.constructionType,this.tile);return!1===e?(console.warn(`cannot build ${this.constructionType}`),void(this.active=!1)):(this.construction=this.player.buildUnit(N.Construction,e,{}),this.cost=this.mg.unitInfo(this.constructionType).cost(this.player),this.player.removeGold(this.cost),this.construction.setConstructionType(this.constructionType),void(this.ticksUntilComplete=t.constructionDuration))}if(this.construction.isActive()){if(this.player!==this.construction.owner()&&(this.player=this.construction.owner()),0===this.ticksUntilComplete)return this.player=this.construction.owner(),this.construction.delete(!1),this.player.addGold(this.cost),this.completeConstruction(),void(this.active=!1);this.ticksUntilComplete--}else this.active=!1}completeConstruction(){const t=this.player;switch(this.constructionType){case N.AtomBomb:case N.HydrogenBomb:this.mg.addExecution(new Ke(this.constructionType,t,this.tile));break;case N.MIRV:this.mg.addExecution(new Ye(t,this.tile));break;case N.Warship:this.mg.addExecution(new ii({owner:t,patrolTile:this.tile}));break;case N.Port:this.mg.addExecution(new Je(t,this.tile));break;case N.MissileSilo:this.mg.addExecution(new Xe(t,this.tile));break;case N.DefensePost:this.mg.addExecution(new Ge(t,this.tile));break;case N.SAMLauncher:this.mg.addExecution(new ei(t,this.tile));break;case N.City:this.mg.addExecution(new Pe(t,this.tile));break;case N.Factory:this.mg.addExecution(new ze(t,this.tile));break;default:console.warn(`unit type ${this.constructionType} cannot be constructed`)}}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class ri{constructor(t,e){this.player=t,this.unitId=e,this.active=!0,this.unit=null}activeDuringSpawnPhase(){return!1}init(t,e){if(!this.active)return;this.mg=t;const i=this.player.units().find((t=>t.id()===this.unitId));if(!i)return console.warn(`SECURITY: unit ${this.unitId} not found or not owned by player ${this.player.displayName()}`),void(this.active=!1);if(!i.isActive())return console.warn(`SECURITY: unit ${this.unitId} is not active`),void(this.active=!1);this.unit=i;const s=t.owner(i.tile());return s.isPlayer()&&s.id()===this.player.id()?t.isLand(i.tile())?t.inSpawnPhase()?(console.warn("SECURITY: cannot delete units during spawn phase"),void(this.active=!1)):this.player.canDeleteUnit()?(this.player.recordDeleteUnit(),void i.markForDeletion()):(console.warn("SECURITY: delete unit cooldown not expired"),void(this.active=!1)):(console.warn(`SECURITY: unit ${this.unitId} is not on land`),void(this.active=!1)):(console.warn(`SECURITY: unit ${this.unitId} is not on player's territory`),void(this.active=!1))}tick(t){this.active&&this.unit&&(this.unit.isActive()?this.unit.isOverdueDeletion()&&(this.unit.delete(!1),this.mg.displayMessage("events_display.unit_voluntarily_deleted",q.UNIT_DESTROYED,this.player.id()),this.active=!1):this.active=!1)}isActive(){return this.active}}class ni{constructor(t,e,i){this.sender=t,this.recipientID=e,this.active=!0,this.gold=d(i??0)}init(t,e){if(!t.hasPlayer(this.recipientID))return console.warn(`DonateExecution recipient ${this.recipientID} not found`),void(this.active=!1);this.recipient=t.player(this.recipientID),this.gold??(this.gold=this.sender.gold()/3n)}tick(t){if(null===this.gold)throw new Error("not initialized");this.sender.canDonateGold(this.recipient)&&this.sender.donateGold(this.recipient,this.gold)?this.recipient.updateRelation(this.sender,50):console.warn(`cannot send gold from ${this.sender.name()} to ${this.recipient.name()}`),this.active=!1}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class ai{constructor(t,e,i){this.sender=t,this.recipientID=e,this.troops=i,this.active=!0}init(t,e){if(!t.hasPlayer(this.recipientID))return console.warn(`DonateExecution recipient ${this.recipientID} not found`),void(this.active=!1);this.recipient=t.player(this.recipientID),this.troops??(this.troops=t.config().defaultDonationAmount(this.sender));const i=t.config().maxTroops(this.recipient)-this.recipient.troops();this.troops=Math.min(this.troops,i)}tick(t){if(null===this.troops)throw new Error("not initialized");this.sender.canDonateTroops(this.recipient)&&this.sender.donateTroops(this.recipient,this.troops)?this.recipient.updateRelation(this.sender,50):console.warn(`cannot send troops from ${this.sender} to ${this.recipient}`),this.active=!1}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class oi{constructor(t,e){this.player=t,this.action=e}init(t,e){if(!this.player.canEmbargoAll())return;const i=this.player;for(const e of t.players())e.id()!==i.id()&&e.type()!==F.Bot&&(i.isOnSameTeam(e)||("start"===this.action?i.hasEmbargoAgainst(e)||i.addEmbargo(e,!1):i.hasEmbargoAgainst(e)&&i.stopEmbargo(e)));this.player.recordEmbargoAll()}tick(t){}isActive(){return!1}activeDuringSpawnPhase(){return!1}}class hi{constructor(t,e,i){this.player=t,this.targetID=e,this.action=i,this.active=!0}init(t,e){if(!t.hasPlayer(this.targetID))return console.warn(`EmbargoExecution recipient ${this.targetID} not found`),void(this.active=!1);this.target=t.player(this.targetID)}tick(t){"start"===this.action?this.player.addEmbargo(this.target,!1):this.player.stopEmbargo(this.target),this.active=!1}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}function li(t,e,i){if(!t.isShore(i))return!1;const s=ui(t,e,i);return null!==s&&s}function ci(t,e){const i=t.playerBySmallID(t.ownerID(e));let s=null;return s=i.isPlayer()?ui(t,i,e):function(t,e,i){const s=Array.from(t.bfs(e,ue(((e,i)=>!t.hasOwner(i)),ce(e,i)))).filter((e=>t.isShore(e))).sort(((i,s)=>t.manhattanDist(e,i)-t.manhattanDist(e,s)));return 0===s.length?null:s[0]}(t,e,50),s}function ui(t,e,i){const s=Array.from(e.borderTiles()).filter((e=>t.isShore(e)));return 0===s.length?null:s.reduce(((e,s)=>{const r=t.manhattanDist(i,e);return t.manhattanDist(i,s)<r?s:e}))}class di{constructor(t,e,i,s,r){this.attacker=t,this.targetID=e,this.ref=i,this.startTroops=s,this.src=r,this.ticksPerMove=1,this.active=!0,this.originalOwner=this.attacker}activeDuringSpawnPhase(){return!1}init(t,e){if(null!==this.targetID&&!t.hasPlayer(this.targetID))return console.warn(`TransportShipExecution: target ${this.targetID} not found`),void(this.active=!1);if(!t.isValidRef(this.ref))return console.warn(`TransportShipExecution: ref ${this.ref} not valid`),void(this.active=!1);if(null!==this.src&&!t.isValidRef(this.src))return console.warn(`TransportShipExecution: src ${this.src} not valid`),void(this.active=!1);if(this.lastMove=e,this.mg=t,this.pathFinder=We.Mini(t,1e4,!0,100),this.attacker.unitCount(N.TransportShip)>=t.config().boatMaxNumber())return t.displayMessage(`No boats available, max ${t.config().boatMaxNumber()}`,q.ATTACK_FAILED,this.attacker.id()),void(this.active=!1);if(null===this.targetID||this.targetID===this.mg.terraNullius().id()?this.target=t.terraNullius():this.target=t.player(this.targetID),this.startTroops??(this.startTroops=this.mg.config().boatAttackAmount(this.attacker,this.target)),this.startTroops=Math.min(this.startTroops,this.attacker.troops()),this.dst=ci(this.mg,this.ref),null===this.dst)return console.warn(`${this.attacker} cannot send ship to ${this.target}, cannot find attack tile`),void(this.active=!1);const i=this.attacker.canBuild(N.TransportShip,this.dst);if(!1===i)return console.warn("can't build transport ship"),void(this.active=!1);null===this.src?this.src=i:this.mg.owner(this.src)===this.attacker&&this.mg.isShore(this.src)||(console.warn(`src is not a shore tile or not owned by: ${this.attacker.name()}`),this.src=i),this.boat=this.attacker.buildUnit(N.TransportShip,this.src,{troops:this.startTroops}),null!==this.dst?this.boat.setTargetTile(this.dst):this.boat.setTargetTile(void 0),this.targetID&&this.targetID!==t.terraNullius().id()&&t.displayIncomingUnit(this.boat.id(),`Naval invasion incoming from ${this.attacker.displayName()}`,q.NAVAL_INVASION_INBOUND,this.targetID),this.mg.stats().boatSendTroops(this.attacker,this.target,this.boat.troops())}tick(t){if(null===this.dst)return void(this.active=!1);if(!this.active)return;if(!this.boat.isActive())return void(this.active=!1);if(t-this.lastMove<this.ticksPerMove)return;if(this.lastMove=t,this.originalOwner.isDisconnected()&&this.boat.owner()!==this.originalOwner&&this.boat.owner().isOnSameTeam(this.originalOwner)&&(this.attacker=this.boat.owner(),this.originalOwner=this.boat.owner()),this.boat.retreating()){if(this.mg.owner(this.src)!==this.attacker){const t=this.attacker.bestTransportShipSpawn(this.dst);this.src=!1===t?null:t}if(null===this.src)return console.warn("TransportShipExecution: retreating but no src found for new attacker"),this.attacker.addTroops(this.boat.troops()),this.boat.delete(!1),void(this.active=!1);this.dst=this.src,this.boat.targetTile()!==this.dst&&this.boat.setTargetTile(this.dst)}const e=this.pathFinder.nextTile(this.boat.tile(),this.dst);switch(e.type){case Me.Completed:return this.mg.owner(this.dst)===this.attacker?(this.attacker.addTroops(this.boat.troops()),this.boat.delete(!1),this.active=!1,void this.mg.stats().boatArriveTroops(this.attacker,this.target,this.boat.troops())):(this.attacker.conquer(this.dst),this.target.isPlayer()&&this.attacker.isFriendly(this.target)?this.attacker.addTroops(this.boat.troops()):this.mg.addExecution(new Xt(this.boat.troops(),this.attacker,this.targetID,this.dst,!1)),this.boat.delete(!1),this.active=!1,void this.mg.stats().boatArriveTroops(this.attacker,this.target,this.boat.troops()));case Me.NextTile:this.boat.move(e.node);break;case Me.Pending:break;case Me.PathNotFound:return console.warn("path not found to dst"),this.attacker.addTroops(this.boat.troops()),this.boat.delete(!1),void(this.active=!1)}}owner(){return this.attacker}isActive(){return this.active}}class gi{constructor(t,e){this.nation=e,this.active=!0,this.behavior=null,this.player=null,this.lastEmojiSent=new Map,this.lastNukeSent=[],this.lastMIRVSent=[],this.embargoMalusApplied=new Set,this.mirvTargetsCache=null,this.random=new it(n(e.playerInfo.id)+n(t)),this.attackRate=this.random.nextInt(40,80),this.attackTick=this.random.nextInt(0,this.attackRate),this.triggerRatio=this.random.nextInt(50,60)/100,this.reserveRatio=this.random.nextInt(30,40)/100,this.expandRatio=this.random.nextInt(10,20)/100}init(t){this.mg=t,this.random.chance(10)}updateRelationsFromEmbargos(){const t=this.player;null!==t&&this.mg.players().filter((e=>e.id()!==t.id())).forEach((e=>{e.hasEmbargoAgainst(t)&&!this.embargoMalusApplied.has(e.id())?(t.updateRelation(e,-20),this.embargoMalusApplied.add(e.id())):!e.hasEmbargoAgainst(t)&&this.embargoMalusApplied.has(e.id())&&(t.updateRelation(e,20),this.embargoMalusApplied.delete(e.id()))}))}handleEmbargoesToHostileNations(){const t=this.player;null!==t&&this.mg.players().filter((e=>e.id()!==t.id())).forEach((e=>{t.relation(e)<=U.Hostile&&!t.hasEmbargoAgainst(e)&&!t.isOnSameTeam(e)?t.addEmbargo(e,!1):t.relation(e)>=U.Neutral&&t.hasEmbargoAgainst(e)&&t.stopEmbargo(e)}))}tick(t){if(t%this.attackRate===this.attackTick){if(this.mg.inSpawnPhase()){const t=this.randomSpawnLand();return null===t?void console.warn(`cannot spawn ${this.nation.playerInfo.name}`):void this.mg.addExecution(new pe(this.nation.playerInfo,t))}if(null!==this.player||(this.player=this.mg.players().find((t=>t.id()===this.nation.playerInfo.id))??null,null!==this.player))if(this.player.isAlive()){if(null===this.behavior)return this.behavior=new ne(this.random,this.mg,this.player,this.triggerRatio,this.reserveRatio,this.expandRatio),void this.behavior.forceSendAttack(this.mg.terraNullius());this.updateRelationsFromEmbargos(),this.behavior.handleAllianceRequests(),this.behavior.handleAllianceExtensionRequests(),this.handleUnits(),this.handleEmbargoesToHostileNations(),this.considerMIRV(),this.maybeAttack()}else this.active=!1}}maybeAttack(){if(null===this.player||null===this.behavior)throw new Error("not initialized");const t=Array.from(this.player.borderTiles()).flatMap((t=>this.mg.neighbors(t))).filter((t=>this.mg.isLand(t)&&this.mg.ownerID(t)!==this.player?.smallID()));let e=[];if(0===t.length)this.random.chance(5)&&this.sendBoatRandomly();else{if(this.random.chance(10))return void this.sendBoatRandomly();const i=t.map((t=>this.mg.playerBySmallID(this.mg.ownerID(t))));if(i.some((t=>!t.isPlayer())))return void this.behavior.sendAttack(this.mg.terraNullius());if(e=i.filter((t=>t.isPlayer())).sort(((t,e)=>t.troops()-e.troops())),this.random.chance(20)){const t=this.random.randElement(e);this.player.canSendAllianceRequest(t)&&this.mg.addExecution(new Wt(this.player,t.id()))}}this.behavior.forgetOldEnemies(),this.behavior.assistAllies();const i=this.behavior.selectEnemy(e);i&&(this.maybeSendEmoji(i),this.maybeSendNuke(i),this.player.sharesBorderWith(i)?this.behavior.sendAttack(i):this.maybeSendBoatAttack(i))}maybeSendEmoji(t){if(null===this.player)throw new Error("not initialized");if(t.type()!==F.Human)return;const e=this.lastEmojiSent.get(t)??-300;this.mg.ticks()-e<=300||(this.lastEmojiSent.set(t,this.mg.ticks()),this.mg.addExecution(new Jt(this.player,t.id(),this.random.randElement(re))))}maybeSendNuke(t){if(null===this.player)throw new Error("not initialized");const e=this.player.units(N.MissileSilo);if(0===e.length||this.player.gold()<this.cost(N.AtomBomb)||t.type()===F.Bot||this.player.isOnSameTeam(t))return;const i=this.player.gold()>this.cost(N.HydrogenBomb)?N.HydrogenBomb:N.AtomBomb,s=i===N.HydrogenBomb?60:15,r=t.units(N.City,N.DefensePost,N.MissileSilo,N.Port,N.SAMLauncher),n=r.map((t=>t.tile())),a=this.randTerritoryTileArray(10).concat(n);let h=null,l=0;this.removeOldNukeEvents();t:for(const n of new Set(a)){if(null===n)continue;const a=o(this.mg,n,s).concat(o(this.mg,n,Math.floor(s/2)));for(const e of a)if(this.mg.owner(e)!==t)continue t;if(!this.player.canBuild(i,n))continue;const c=this.nukeTileScore(n,e,r);c>l&&(h=n,l=c)}null!==h&&this.sendNuke(h,i)}removeOldNukeEvents(){const t=this.mg.ticks();for(;this.lastNukeSent.length>0&&this.lastNukeSent[0][0]+500<t;)this.lastNukeSent.shift()}sendNuke(t,e){if(null===this.player)throw new Error("not initialized");const i=this.mg.ticks();this.lastNukeSent.push([i,t]),this.mg.addExecution(new Ke(e,this.player,t))}nukeTileScore(t,e,i){const s=le(t,25,!1);let r=i.filter((t=>s(this.mg,t.tile()))).map((t=>{switch(t.type()){case N.City:return 25e3;case N.DefensePost:return 5e3;case N.MissileSilo:return 5e4;case N.Port:return 1e4;default:return 0}})).reduce(((t,e)=>t+e),0);const n=le(t,50,!1);r-=5e4*i.filter((t=>t.type()===N.SAMLauncher&&n(this.mg,t.tile()))).length;const a=e.map((t=>t.tile())),o=ge(this.mg,a,[t]);if(null===o)throw new Error("Missing result");const{x:h}=o,l=this.mg.euclideanDistSquared(t,h);return r-=30*Math.sqrt(l),r-=this.lastNukeSent.filter((([t,e])=>s(this.mg,e))).map((t=>1e6)).reduce(((t,e)=>t+e),0),r}maybeSendBoatAttack(t){if(null===this.player)throw new Error("not initialized");if(this.player.isFriendly(t))return;const e=ge(this.mg,Array.from(this.player.borderTiles()).filter((t=>this.mg.isOceanShore(t))),Array.from(t.borderTiles()).filter((t=>this.mg.isOceanShore(t))));null!==e&&this.mg.addExecution(new di(this.player,t.id(),e.y,this.player.troops()/5,null))}handleUnits(){return this.maybeSpawnStructure(N.City,(t=>t))||this.maybeSpawnStructure(N.Port,(t=>t))||this.maybeSpawnWarship()||this.maybeSpawnStructure(N.Factory,(t=>t))||this.maybeSpawnStructure(N.DefensePost,(t=>(t+2)**2))||this.maybeSpawnStructure(N.SAMLauncher,(t=>t**2))||this.maybeSpawnStructure(N.MissileSilo,(t=>t**2))}maybeSpawnStructure(t,e){if(null===this.player)throw new Error("not initialized");const i=e(this.player.unitsOwned(t)+1),s=this.cost(t)*BigInt(i);if(this.player.gold()<s)return!1;const r=this.structureSpawnTile(t);return null!==r&&(!1!==this.player.canBuild(t,r)&&(this.mg.addExecution(new si(this.player,t,r)),!0))}structureSpawnTile(t){if(void 0===this.mg)throw new Error("Not initialized");if(null===this.player)throw new Error("Not initialized");const e=t===N.Port?this.randCoastalTileArray(25):this.randTerritoryTileArray(25);if(0===e.length)return null;const i=function(t,e,i){const s=e.borderTiles(),r=e.units(i),n=t.config().nukeMagnitudes(N.AtomBomb).outer,a=2*n;switch(i){case N.City:case N.Factory:case N.MissileSilo:return e=>{let i=0;i+=t.magnitude(e);const[,o]=de(t,s,e);i+=Math.min(o,n);const h=new Set(r.map((t=>t.tile())));h.delete(e);const l=ge(t,h,[e]);if(null!==l){const s=t.manhattanDist(l.x,e);i+=Math.min(s,a)}return i};case N.Port:return e=>{let i=0;const s=new Set(r.map((t=>t.tile())));s.delete(e);const[,n]=de(t,s,e);return i+=Math.min(n,a),i};case N.DefensePost:return i=>{let o=0;o+=t.magnitude(i);const[h,l]=de(t,s,i);if(null!==h){o+=Math.max(0,n-Math.abs(n-l));const i=new Set;for(const s of t.neighbors(h)){if(!t.isLand(s))continue;const r=t.ownerID(s);if(r===e.smallID())continue;const n=t.playerBySmallID(r);n.isPlayer()&&i.add(n)}for(const t of i)o+=n*(U.Friendly-e.relation(t))}const c=new Set(r.map((t=>t.tile())));c.delete(i);const u=ge(t,c,[i]);if(null!==u){const e=t.manhattanDist(u.x,i);o+=Math.min(e,a)}return o};case N.SAMLauncher:{const i=new Set;for(const t of e.units())switch(t.type()){case N.City:case N.Factory:case N.MissileSilo:case N.Port:i.add(t.tile())}const o=t.config().defaultSamRange(),h=o*o;return e=>{let o=0;o+=t.magnitude(e);const l=ge(t,s,[e]);if(null!==l){const i=t.manhattanDist(l.x,e);o+=Math.min(i,n)}const c=new Set(r.map((t=>t.tile())));c.delete(e);const u=ge(t,c,[e]);if(null!==u){const i=t.manhattanDist(u.x,e);o+=Math.min(i,a)}for(const s of i)t.euclideanDistSquared(e,s)>h||(o+=a);return o}}default:throw new Error(`Value function not implemented for ${i}`)}}(this.mg,this.player,t);let s=null,r=0;for(const n of e){const e=i(n);e<=r&&null!==s||this.player.canBuild(t,n)&&(s=n,r=e)}return s}randCoastalTileArray(t){const e=Array.from(this.player.borderTiles()).filter((t=>this.mg.isOceanShore(t)));return Array.from(this.arraySampler(e,t))}*arraySampler(t,e){if(t.length<=e)yield*t;else{const i=new Set(t);for(;e--;){const t=this.random.randFromSet(i);i.delete(t),yield t}}}maybeSpawnWarship(){if(null===this.player)throw new Error("not initialized");if(!this.random.chance(50))return!1;const t=this.player.units(N.Port),e=this.player.units(N.Warship);if(t.length>0&&0===e.length&&this.player.gold()>this.cost(N.Warship)){const e=this.random.randElement(t),i=this.warshipSpawnTile(e.tile());return null!==i&&(!1===this.player.canBuild(N.Warship,i)?(console.warn("cannot spawn destroyer"),!1):(this.mg.addExecution(new si(this.player,N.Warship,i)),!0))}return!1}randTerritoryTileArray(t){const e=a(this.mg,this.player.borderTiles()),i=[];for(let s=0;s<t;s++){const t=this.randTerritoryTile(this.player,e);null!==t&&i.push(t)}return i}randTerritoryTile(t,e=null){e??(e=a(this.mg,t.borderTiles()));for(let i=0;i<100;i++){const i=this.random.nextInt(e.min.x,e.max.x),s=this.random.nextInt(e.min.y,e.max.y);if(!this.mg.isOnMap(new G(i,s)))continue;const r=this.mg.ref(i,s);if(this.mg.owner(r)===t)return r}return null}warshipSpawnTile(t){const e=250;for(let i=0;i<50;i++){const i=this.random.nextInt(this.mg.x(t)-e,this.mg.x(t)+e),s=this.random.nextInt(this.mg.y(t)-e,this.mg.y(t)+e);if(!this.mg.isValidCoord(i,s))continue;const r=this.mg.ref(i,s);if(this.mg.isOcean(r))return r}return null}cost(t){if(null===this.player)throw new Error("not initialized");return this.mg.unitInfo(t).cost(this.player)}sendBoatRandomly(){if(null===this.player)throw new Error("not initialized");const t=Array.from(this.player.borderTiles()).filter((t=>this.mg.isOceanShore(t)));if(0===t.length)return;const e=this.random.randElement(t);let i=this.randomBoatTarget(e,150,!0);null===i&&(i=this.randomBoatTarget(e,150,!1),null===i)||this.mg.addExecution(new di(this.player,this.mg.owner(i).id(),i,this.player.troops()/5,null))}randomSpawnLand(){let t=0;for(;t<50;){t++;const e=this.nation.spawnCell,i=this.random.nextInt(e.x-25,e.x+25),s=this.random.nextInt(e.y-25,e.y+25);if(!this.mg.isValidCoord(i,s))continue;const r=this.mg.ref(i,s);if(this.mg.isLand(r)&&!this.mg.hasOwner(r)){if(this.mg.terrainType(r)===L.Mountain&&this.random.chance(2))continue;return r}}return null}randomBoatTarget(t,e,i=!1){if(null===this.player)throw new Error("not initialized");const s=this.mg.x(t),r=this.mg.y(t);for(let t=0;t<500;t++){const t=this.random.nextInt(s-e,s+e),n=this.random.nextInt(r-e,r+e);if(!this.mg.isValidCoord(t,n))continue;const a=this.mg.ref(t,n);if(!this.mg.isLand(a))continue;const o=this.mg.owner(a);if(o!==this.player&&!(o.isPlayer()&&o.troops()>2*this.player.troops()))if(i){if(!o.isPlayer()||o.type()===F.Bot)return a}else if(!o.isPlayer()||!o.isFriendly(this.player))return a}return null}considerMIRV(){if(null===this.player)throw new Error("not initialized");if(0===this.player.units(N.MissileSilo).length)return!1;if(this.player.gold()<this.cost(N.MIRV))return!1;if(this.removeOldMIRVEvents(),this.lastMIRVSent.length>0)return!1;if(this.random.chance(gi.MIRV_HESITATION_ODDS))return this.triggerMIRVCooldown(),!1;const t=this.selectCounterMirvTarget();if(t)return this.maybeSendMIRV(t),!0;const e=this.selectVictoryDenialTarget();if(e)return this.maybeSendMIRV(e),!0;const i=this.selectSteamrollStopTarget();return!!i&&(this.maybeSendMIRV(i),!0)}selectCounterMirvTarget(){if(null===this.player)throw new Error("not initialized");const t=this.getValidMirvTargetPlayers().filter((t=>this.isInboundMIRVFrom(t)));return 0===t.length?null:(t.sort(((t,e)=>e.numTilesOwned()-t.numTilesOwned())),t[0])}selectVictoryDenialTarget(){if(null===this.player)throw new Error("not initialized");const t=this.mg.numLandTiles();if(0===t)return null;let e=null;for(const i of this.getValidMirvTargetPlayers()){let s=0;const r=i.team();if(null!==r){const e=this.mg.players().filter((t=>t.team()===r&&t.isPlayer())),n=e.map((t=>t.numTilesOwned())).reduce(((t,e)=>t+e),0)/t;if(n>=gi.VICTORY_DENIAL_TEAM_THRESHOLD){let t=null,r=-1;for(const i of e){const e=i.numTilesOwned();e>r&&(r=e,t=i)}s=t===i?n:0}}else{const e=i.numTilesOwned()/t;e>=gi.VICTORY_DENIAL_INDIVIDUAL_THRESHOLD&&(s=e)}s>0&&(null===e||s>e.severity)&&(e={p:i,severity:s})}return e?e.p:null}selectSteamrollStopTarget(){if(null===this.player)throw new Error("not initialized");const t=this.getValidMirvTargetPlayers();if(0===t.length)return null;const e=this.mg.players().filter((t=>t.isPlayer())).map((t=>({p:t,cityCount:this.countCities(t)}))).sort(((t,e)=>e.cityCount-t.cityCount));if(e.length<2)return null;const i=e[0];if(i.cityCount<=gi.STEAMROLL_MIN_LEADER_CITIES)return null;const s=e[1].cityCount*gi.STEAMROLL_CITY_GAP_MULTIPLIER;return i.cityCount>=s&&t.some((t=>t===i.p))?i.p:null}getValidMirvTargetPlayers(){if(null===this.player)throw new Error("not initialized");if(this.mirvTargetsCache&&this.mg.ticks()-this.mirvTargetsCache.tick<20)return this.mirvTargetsCache.players;const t=this.mg.players().filter((t=>t!==this.player&&t.isPlayer()&&t.type()!==F.Bot&&!this.player.isOnSameTeam(t)));return this.mirvTargetsCache={tick:this.mg.ticks(),players:t},t}isInboundMIRVFrom(t){if(null===this.player)throw new Error("not initialized");const e=t.units(N.MIRV);for(const t of e){const e=t.targetTile();if(e&&(this.mg.hasOwner(e)&&this.mg.owner(e)===this.player))return!0}return!1}countCities(t){return t.unitCount(N.City)}calculateTerritoryCenter(t){return function(t,e){const i=e.borderTiles();if(0===i.size)return null;let s=1/0,r=-1/0,n=1/0,a=-1/0;for(const e of i){const i=t.x(e),o=t.y(e);i<s&&(s=i),i>r&&(r=i),o<n&&(n=o),o>a&&(a=o)}const o=Math.floor((s+r)/2),h=Math.floor((n+a)/2),l=t.ref(o,h);if(t.owner(l)===e)return l;let c=null,u=1/0;for(const e of i){const i=t.x(e)-o,s=t.y(e)-h,r=i*i+s*s;r<u&&(u=r,c=e)}return c}(this.mg,t)}maybeSendMIRV(t){if(null===this.player)throw new Error("not initialized");this.maybeSendEmoji(t);const e=this.calculateTerritoryCenter(t);e&&this.player.canBuild(N.MIRV,e)&&this.sendMIRV(e)}sendMIRV(t){if(null===this.player)throw new Error("not initialized");this.triggerMIRVCooldown(t),this.mg.addExecution(new Ye(this.player,t))}triggerMIRVCooldown(t){if(null===this.player)throw new Error("not initialized");this.removeOldMIRVEvents();const e=this.mg.ticks(),i=t??Array.from(this.player.tiles())[0]??this.mg.ref(0,0);this.lastMIRVSent.push([e,i])}removeOldMIRVEvents(){const t=gi.MIRV_COOLDOWN_TICKS,e=this.mg.ticks();for(;this.lastMIRVSent.length>0&&this.lastMIRVSent[0][0]+t<=e;)this.lastMIRVSent.shift()}isActive(){return this.active}activeDuringSpawnPhase(){return!0}}gi.MIRV_COOLDOWN_TICKS=20,gi.MIRV_HESITATION_ODDS=7,gi.VICTORY_DENIAL_TEAM_THRESHOLD=.8,gi.VICTORY_DENIAL_INDIVIDUAL_THRESHOLD=.65,gi.STEAMROLL_CITY_GAP_MULTIPLIER=1.3,gi.STEAMROLL_MIN_LEADER_CITIES=10;class pi{constructor(t,e){this.player=t,this.isDisconnected=e}init(t,e){this.player.markDisconnected(this.isDisconnected)}tick(t){}isActive(){return!1}activeDuringSpawnPhase(){return!1}}class mi{constructor(t,e,i){this.owner=t,this.unitId=e,this.position=i}init(t,e){if(!t.isValidRef(this.position))return void console.warn(`MoveWarshipExecution: position ${this.position} not valid`);const i=this.owner.units(N.Warship).find((t=>t.id()===this.unitId));i?i.isActive()?(i.setPatrolTile(this.position),i.setTargetTile(void 0)):console.warn("MoveWarshipExecution: warship is not active"):console.warn("MoveWarshipExecution: warship not found")}tick(t){}isActive(){return!1}activeDuringSpawnPhase(){return!1}}class fi{isActive(){return!1}activeDuringSpawnPhase(){return!1}init(t,e){}tick(t){}}class yi{constructor(t,e,i,s){this.sender=t,this.recipientID=e,this.quickChatKey=i,this.target=s,this.active=!0}init(t,e){if(this.mg=t,!t.hasPlayer(this.recipientID))return console.warn(`QuickChatExecution: recipient ${this.recipientID} not found`),void(this.active=!1);this.recipient=t.player(this.recipientID)}tick(t){const e=this.getMessageFromKey(this.quickChatKey);this.mg.displayChat(e[1],e[0],this.target,this.recipient.id(),!0,this.sender.id()),this.mg.displayChat(e[1],e[0],this.target,this.sender.id(),!1,this.recipient.id()),console.log(`[QuickChat] ${this.sender.name} â†’ ${this.recipient.displayName}: ${e}`),this.active=!1}owner(){return this.sender}isActive(){return this.active}activeDuringSpawnPhase(){return!1}getMessageFromKey(t){return t.split(".")}}class wi{constructor(t,e){this.player=t,this.attackID=e,this.active=!0,this.retreatOrdered=!1}init(t,e){this.mg=t,this.startTick=t.ticks()}tick(t){this.retreatOrdered||(this.player.orderRetreat(this.attackID),this.retreatOrdered=!0),this.mg.ticks()>=this.startTick+20&&(this.player.executeRetreat(this.attackID),this.active=!1)}owner(){return this.player}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class bi{constructor(t,e){this.requestor=t,this.targetID=e,this.active=!0}init(t,e){if(!t.hasPlayer(this.targetID))return console.warn(`TargetPlayerExecution: target ${this.targetID} not found`),void(this.active=!1);this.target=t.player(this.targetID)}tick(t){this.requestor.canTarget(this.target)&&(this.requestor.target(this.target),this.target.updateRelation(this.requestor,-40)),this.active=!1}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class Mi{constructor(t,e){this.player=t,this.unitId=e}init(t,e){this.structure=this.player.units().find((t=>t.id()===this.unitId)),void 0!==this.structure?this.player.canUpgradeUnit(this.structure)?this.player.upgradeUnit(this.structure):console.warn(`[UpgradeStructureExecution] unit type ${this.structure.type()} cannot be upgraded`):console.warn("structure is undefined")}tick(t){}isActive(){return!1}activeDuringSpawnPhase(){return!1}}class Ti{constructor(t,e,i){this.mg=t,this.gameID=e,this.clientID=i,this.random=new it(n(e)+1)}createExecs(t){return t.intents.map((t=>this.createExec(t)))}createExec(t){const e=this.mg.playerByClientID(t.clientID);if(!e)return console.warn(`player with clientID ${t.clientID} not found`),new fi;switch(t.type){case"attack":return new Xt(t.troops,e,t.targetID,null);case"cancel_attack":return new wi(e,t.attackID);case"cancel_boat":return new Qt(e,t.unitID);case"move_warship":return new mi(e,t.unitId,t.tile);case"spawn":return new pe(e.info(),t.tile);case"boat":return new di(e,t.targetID,t.dst,t.troops,t.src);case"allianceRequest":return new Wt(e,t.recipient);case"allianceRequestReply":return new Vt(t.requestor,e,t.accept);case"breakAlliance":return new Gt(e,t.recipient);case"targetPlayer":return new bi(e,t.target);case"emoji":return new Jt(e,t.recipient,t.emoji);case"donate_troops":return new ai(e,t.recipient,t.troops);case"donate_gold":return new ni(e,t.recipient,t.gold);case"embargo":return new hi(e,t.targetID,t.action);case"embargo_all":return new oi(e,t.action);case"build_unit":return new si(e,t.unit,t.tile);case"allianceExtension":return new Ht(e,t.recipient);case"upgrade_structure":return new Mi(e,t.unitId);case"delete_unit":return new ri(e,t.unitId);case"quick_chat":return new yi(e,t.recipient,t.quickChatKey,t.target);case"mark_disconnected":return new pi(e,t.isDisconnected);default:throw new Error(`intent type ${t} not found`)}}spawnBots(t){return new ye(this.mg,this.gameID).spawnBots(t)}fakeHumanExecutions(){const t=[];for(const e of this.mg.nations())t.push(new gi(this.gameID,e));return t}}class _i{constructor(){this.active=!0,this.mg=null}init(t,e){this.mg=t}tick(t){if(t%10==0){if(null===this.mg)throw new Error("Not initialized");this.mg.config().gameConfig().gameMode===P.FFA?this.checkWinnerFFA():this.checkWinnerTeam()}}checkWinnerFFA(){if(null===this.mg)throw new Error("Not initialized");const t=this.mg.players().sort(((t,e)=>e.numTilesOwned()-t.numTilesOwned()));if(0===t.length)return;const e=t[0],i=(this.mg.ticks()-this.mg.config().numSpawnPhaseTurns())/10,s=this.mg.numLandTiles()-this.mg.numTilesWithFallout();(e.numTilesOwned()/s*100>this.mg.config().percentageTilesOwnedToWin()||void 0!==this.mg.config().gameConfig().maxTimerValue&&i-60*this.mg.config().gameConfig().maxTimerValue>=0)&&(this.mg.setWinner(e,this.mg.stats().stats()),console.log(`${e.name()} has won the game`),this.active=!1)}checkWinnerTeam(){if(null===this.mg)throw new Error("Not initialized");const t=new Map;for(const e of this.mg.players()){const i=e.team();null!==i&&t.set(i,(t.get(i)??0)+e.numTilesOwned())}const e=Array.from(t.entries()).sort(((t,e)=>e[1]-t[1]));if(0===e.length)return;const i=e[0],s=(this.mg.ticks()-this.mg.config().numSpawnPhaseTurns())/10,r=this.mg.numLandTiles()-this.mg.numTilesWithFallout();if(i[1]/r*100>this.mg.config().percentageTilesOwnedToWin()||void 0!==this.mg.config().gameConfig().maxTimerValue&&s-60*this.mg.config().gameConfig().maxTimerValue>=0){if(i[0]===I)return;this.mg.setWinner(i[0],this.mg.stats().stats()),console.log(`${i[0]} has won the game`),this.active=!1}}isActive(){return this.active}activeDuringSpawnPhase(){return!1}}class vi{constructor(t,e,i,s,r){this.mg=t,this.requestor_=e,this.recipient_=i,this.createdAt_=s,this.id_=r,this.extensionRequestedRequestor_=!1,this.extensionRequestedRecipient_=!1,this.expiresAt_=s+t.config().allianceDuration()}other(t){return this.requestor_===t?this.recipient_:this.requestor_}requestor(){return this.requestor_}recipient(){return this.recipient_}createdAt(){return this.createdAt_}expire(){this.mg.expireAlliance(this)}addExtensionRequest(t){this.requestor_===t?this.extensionRequestedRequestor_=!0:this.recipient_===t&&(this.extensionRequestedRecipient_=!0)}bothAgreedToExtend(){return this.extensionRequestedRequestor_&&this.extensionRequestedRecipient_}onlyOneAgreedToExtend(){return this.extensionRequestedRequestor_!==this.extensionRequestedRecipient_}id(){return this.id_}extend(){this.extensionRequestedRequestor_=!1,this.extensionRequestedRecipient_=!1,this.expiresAt_=this.mg.ticks()+this.mg.config().allianceDuration()}expiresAt(){return this.expiresAt_}}class Ai{constructor(t,e,i,s){this.requestor_=t,this.recipient_=e,this.tickCreated=i,this.game=s,this.status_="pending"}status(){return this.status_}requestor(){return this.requestor_}recipient(){return this.recipient_}createdAt(){return this.tickCreated}accept(){this.status_="accepted",this.game.acceptAllianceRequest(this)}reject(){this.status_="rejected",this.game.rejectAllianceRequest(this)}toUpdate(){return{type:we.AllianceRequest,requestorID:this.requestor_.smallID(),recipientID:this.recipient_.smallID(),createdAt:this.tickCreated}}}var Si=i(16720);const ki=new Si.mV({...Si.zp.build(),...Si.I0,...(0,Si.rp)(),...(0,Si.R)(),...(0,Si.pX)(),...(0,Si.uA)()}),Ei=/^[a-zA-Z0-9_[\] ðŸˆðŸ€Ã¼Ãœ]+$/u,Ii=["NicePeopleOnly","BeKindPlz","LearningManners","StayClassy","BeNicer","NeedHugs","MakeFriends"];class Di{constructor(t,e,i,s,r,n,a){this._id=t,this._target=e,this._attacker=i,this._troops=s,this._sourceTile=r,this._border=n,this._mg=a,this._isActive=!0,this._borderSize=0,this._retreating=!1,this._retreated=!1}sourceTile(){return this._sourceTile}target(){return this._target}attacker(){return this._attacker}troops(){return this._troops}setTroops(t){this._troops=t}isActive(){return this._isActive}id(){return this._id}delete(){this._target.isPlayer()&&(this._target._incomingAttacks=this._target._incomingAttacks.filter((t=>t!==this))),this._attacker._outgoingAttacks=this._attacker._outgoingAttacks.filter((t=>t!==this)),this._isActive=!1}orderRetreat(){this._retreating=!0}executeRetreat(){this._retreated=!0}retreating(){return this._retreating}retreated(){return this._retreated}borderSize(){return this._borderSize}clearBorder(){this._borderSize=0,this._border.clear()}addBorderTile(t){this._border.has(t)||(this._borderSize+=1,this._border.add(t))}removeBorderTile(t){this._border.has(t)&&(this._borderSize-=1,this._border.delete(t))}averagePosition(){if(0===this._borderSize){if(null===this.sourceTile())return null;const t=this.sourceTile();return new G(this._mg.map().x(t),this._mg.map().y(t))}let t=0,e=0;for(const i of this._border)t+=this._mg.map().x(i),e+=this._mg.map().y(i);return t/=this._borderSize,e/=this._borderSize,new G(t,e)}}class ji{constructor(t,e,i,s,r,n={}){switch(this._type=t,this.mg=e,this._tile=i,this._id=s,this._owner=r,this._active=!0,this._retreating=!1,this._targetedBySAM=!1,this._reachedTarget=!1,this._lastOwner=null,this._missileTimerQueue=[],this._hasTrainStation=!1,this._level=1,this._targetable=!0,this._trajectoryIndex=0,this._deletionAt=null,this._lastTile=i,this._health=d(this.mg.unitInfo(t).maxHealth??1),this._targetTile="targetTile"in n?n.targetTile??void 0:void 0,this._trajectory="trajectory"in n?n.trajectory??[]:[],this._troops="troops"in n?n.troops??0:0,this._lastSetSafeFromPirates="lastSetSafeFromPirates"in n?n.lastSetSafeFromPirates??0:0,this._patrolTile="patrolTile"in n?n.patrolTile??void 0:void 0,this._targetUnit="targetUnit"in n?n.targetUnit??void 0:void 0,this._loaded="loaded"in n?n.loaded??void 0:void 0,this._trainType="trainType"in n?n.trainType:void 0,this._type){case N.Warship:case N.Port:case N.MissileSilo:case N.DefensePost:case N.SAMLauncher:case N.City:this.mg.stats().unitBuild(r,this._type)}}setTargetable(t){this._targetable!==t&&(this._targetable=t,this.mg.addUpdate(this.toUpdate()))}isTargetable(){return this._targetable}setPatrolTile(t){this._patrolTile=t}patrolTile(){return this._patrolTile}isUnit(){return!0}touch(){this.mg.addUpdate(this.toUpdate())}setTileTarget(t){this._targetTile=t}tileTarget(){return this._targetTile}id(){return this._id}toUpdate(){return{type:we.Unit,unitType:this._type,id:this._id,troops:this._troops,ownerID:this._owner.smallID(),lastOwnerID:this._lastOwner?.smallID(),isActive:this._active,reachedTarget:this._reachedTarget,retreating:this._retreating,pos:this._tile,markedForDeletion:this._deletionAt??!1,targetable:this._targetable,lastPos:this._lastTile,health:this.hasHealth()?Number(this._health):void 0,constructionType:this._constructionType,targetUnitId:this._targetUnit?.id()??void 0,targetTile:this.targetTile()??void 0,missileTimerQueue:this._missileTimerQueue,level:this.level(),hasTrainStation:this._hasTrainStation,trainType:this._trainType,loaded:this._loaded}}type(){return this._type}lastTile(){return this._lastTile}move(t){if(null===t)throw new Error("tile cannot be null");this._lastTile=this._tile,this._tile=t,this.mg.updateUnitTile(this),this.mg.addUpdate(this.toUpdate())}setTroops(t){this._troops=t}troops(){return this._troops}health(){return Number(this._health)}hasHealth(){return void 0!==this.info().maxHealth}tile(){return this._tile}owner(){return this._owner}info(){return this.mg.unitInfo(this._type)}setOwner(t){switch(this.clearPendingDeletion(),this._type){case N.Warship:case N.Port:case N.MissileSilo:case N.DefensePost:case N.SAMLauncher:case N.City:this.mg.stats().unitCapture(t,this._type),this.mg.stats().unitLose(this._owner,this._type)}this._lastOwner=this._owner,this._lastOwner._units=this._lastOwner._units.filter((t=>t!==this)),this._owner=t,this._owner._units.push(this),this.mg.addUpdate(this.toUpdate()),this.mg.displayMessage(`Your ${this.type()} was captured by ${t.displayName()}`,q.UNIT_CAPTURED_BY_ENEMY,this._lastOwner.id()),this.mg.displayMessage(`Captured ${this.type()} from ${this._lastOwner.displayName()}`,q.CAPTURED_ENEMY_UNIT,t.id())}modifyHealth(t,e){var i;this._health=g((i=this._health+d(t))>0n?i:0n,d(this.info().maxHealth??1)),0n===this._health&&this.delete(!0,e)}clearPendingDeletion(){this._deletionAt=null}isMarkedForDeletion(){return null!==this._deletionAt}markForDeletion(){this.isActive()&&(this._deletionAt=this.mg.ticks()+this.mg.config().deletionMarkDuration(),this.mg.addUpdate(this.toUpdate()))}isOverdueDeletion(){return!!this.isActive()&&null!==this._deletionAt&&this.mg.ticks()-this._deletionAt>0}delete(t,e){if(!this.isActive())throw new Error(`cannot delete ${this} not active`);if(this._owner._units=this._owner._units.filter((t=>t!==this)),this._active=!1,this.mg.addUpdate(this.toUpdate()),this.mg.removeUnit(this),!1!==t&&this._type!==N.MIRVWarhead&&this.mg.displayMessage(`Your ${this._type} was destroyed`,q.UNIT_DESTROYED,this.owner().id()),void 0!==e)switch(this._type){case N.TransportShip:this.mg.stats().boatDestroyTroops(e,this._owner,this._troops);break;case N.TradeShip:this.mg.stats().boatDestroyTrade(e,this._owner);break;case N.City:case N.DefensePost:case N.MissileSilo:case N.Port:case N.SAMLauncher:case N.Warship:case N.Factory:this.mg.stats().unitDestroy(e,this._type),this.mg.stats().unitLose(this.owner(),this._type)}}isActive(){return this._active}retreating(){return this._retreating}orderBoatRetreat(){if(this.type()!==N.TransportShip)throw new Error(`Cannot retreat ${this.type()}`);this._retreating=!0}constructionType(){if(this.type()!==N.Construction)throw new Error(`Cannot get construction type on ${this.type()}`);return this._constructionType??null}setConstructionType(t){if(this.type()!==N.Construction)throw new Error(`Cannot set construction type on ${this.type()}`);this._constructionType=t,this.mg.addUpdate(this.toUpdate())}hash(){return this.tile()+n(this.type())*this._id}toString(){return`Unit:${this._type},owner:${this.owner().name()}`}launch(){this._missileTimerQueue.push(this.mg.ticks()),this.mg.addUpdate(this.toUpdate())}ticksLeftInCooldown(){return this._missileTimerQueue[0]}isInCooldown(){return this._missileTimerQueue.length===this._level}missileTimerQueue(){return this._missileTimerQueue}reloadMissile(){this._missileTimerQueue.shift(),this.mg.addUpdate(this.toUpdate())}setTargetTile(t){this._targetTile=t}targetTile(){return this._targetTile}setTrajectoryIndex(t){const e=this._trajectory.length-1;this._trajectoryIndex=t<0?0:t>e?e:t}trajectoryIndex(){return this._trajectoryIndex}trajectory(){return this._trajectory}setTargetUnit(t){this._targetUnit=t}targetUnit(){return this._targetUnit}setTargetedBySAM(t){this._targetedBySAM=t}targetedBySAM(){return this._targetedBySAM}setReachedTarget(){this._reachedTarget=!0}reachedTarget(){return this._reachedTarget}setSafeFromPirates(){this._lastSetSafeFromPirates=this.mg.ticks()}isSafeFromPirates(){return this.mg.ticks()-this._lastSetSafeFromPirates<this.mg.config().safeFromPiratesCooldownMax()}level(){return this._level}setTrainStation(t){this._hasTrainStation=t,this.mg.addUpdate(this.toUpdate())}hasTrainStation(){return this._hasTrainStation}increaseLevel(){this._level++,[N.MissileSilo,N.SAMLauncher].includes(this.type())&&this._missileTimerQueue.push(this.mg.ticks()),this.mg.addUpdate(this.toUpdate())}decreaseLevel(t){this._level--,[N.MissileSilo,N.SAMLauncher].includes(this.type())&&this._missileTimerQueue.pop(),this._level<=0?this.delete(!0,t):this.mg.addUpdate(this.toUpdate())}trainType(){return this._trainType}isLoaded(){return this._loaded}setLoaded(t){this._loaded!==t&&(this._loaded=t,this.mg.addUpdate(this.toUpdate()))}}class Ci{constructor(t,e){this.recipient=t,this.tick=e}}class xi{constructor(t,e,i,s,r){var a;this.mg=t,this._smallID=e,this.playerInfo=i,this._team=r,this._lastTileChange=0,this.markedTraitorTick=-1,this._betrayalCount=0,this.embargoes=new Map,this._borderTiles=new Set,this._units=[],this._tiles=new Set,this.pastOutgoingAllianceRequests=[],this._expiredAlliances=[],this.targets_=[],this.outgoingEmojis_=[],this.sentDonations=[],this.relations=new Map,this.lastDeleteUnitTick=-1,this.lastEmbargoAllTick=-1,this._incomingAttacks=[],this._outgoingAttacks=[],this._outgoingLandAttacks=[],this._hasSpawned=!1,this._isDisconnected=!1,this.numUnitsConstructed={},this._name=(a=i.name,Array.from(a).filter((t=>Ei.test(t))).join("").slice(0,27).padEnd(3,"x")),this._troops=d(s),this._gold=0n,this._displayName=this._name,this._pseudo_random=new it(n(this.playerInfo.id))}toUpdate(){const t=this.outgoingAllianceRequests().map((t=>t.recipient().id()));return{type:we.Player,clientID:this.clientID(),name:this.name(),displayName:this.displayName(),id:this.id(),team:this.team()??void 0,smallID:this.smallID(),playerType:this.type(),isAlive:this.isAlive(),isDisconnected:this.isDisconnected(),tilesOwned:this.numTilesOwned(),gold:this._gold,troops:this.troops(),allies:this.alliances().map((t=>t.other(this).smallID())),embargoes:new Set([...this.embargoes.keys()].map((t=>t.toString()))),isTraitor:this.isTraitor(),traitorRemainingTicks:this.getTraitorRemainingTicks(),targets:this.targets().map((t=>t.smallID())),outgoingEmojis:this.outgoingEmojis(),outgoingAttacks:this._outgoingAttacks.map((t=>({attackerID:t.attacker().smallID(),targetID:t.target().smallID(),troops:t.troops(),id:t.id(),retreating:t.retreating()}))),incomingAttacks:this._incomingAttacks.map((t=>({attackerID:t.attacker().smallID(),targetID:t.target().smallID(),troops:t.troops(),id:t.id(),retreating:t.retreating()}))),outgoingAllianceRequests:t,alliances:this.alliances().map((t=>({id:t.id(),other:t.other(this).id(),createdAt:t.createdAt(),expiresAt:t.expiresAt()}))),hasSpawned:this.hasSpawned(),betrayals:this._betrayalCount,lastDeleteUnitTick:this.lastDeleteUnitTick}}smallID(){return this._smallID}name(){return this._name}displayName(){return this._displayName}clientID(){return this.playerInfo.clientID}id(){return this.playerInfo.id}type(){return this.playerInfo.playerType}clan(){return this.playerInfo.clan}units(...t){if(0===t.length)return this._units;const e=new Set(t);return this._units.filter((t=>e.has(t.type())))}recordUnitConstructed(t){void 0!==this.numUnitsConstructed[t]?this.numUnitsConstructed[t]++:this.numUnitsConstructed[t]=1}unitsConstructed(t){const e=this.numUnitsConstructed[t]??0;let i=0;for(const e of this._units)e.type()===N.Construction&&e.constructionType()===t&&i++;return i+e}unitCount(t){let e=0;for(const i of this._units)i.type()===t&&(e+=i.level());return e}unitsOwned(t){let e=0;for(const i of this._units)i.type()!==t?i.type()===N.Construction&&i.constructionType()===t&&e++:e+=i.level();return e}sharesBorderWith(t){for(const e of this._borderTiles)for(const i of this.mg.map().neighbors(e))if(this.mg.map().ownerID(i)===t.smallID())return!0;return!1}numTilesOwned(){return this._tiles.size}tiles(){return new Set(this._tiles.values())}borderTiles(){return this._borderTiles}neighbors(){const t=new Set;for(const e of this.borderTiles())for(const i of this.mg.map().neighbors(e))if(this.mg.map().isLand(i)){const e=this.mg.map().ownerID(i);e!==this.smallID()&&t.add(this.mg.playerBySmallID(e))}return Array.from(t)}isPlayer(){return!0}setTroops(t){this._troops=d(t)}conquer(t){this.mg.conquer(this,t)}orderRetreat(t){const e=this._outgoingAttacks.filter((e=>e.id()===t));e&&e[0]?e[0].orderRetreat():console.warn(`Didn't find outgoing attack with id ${t}`)}executeRetreat(t){const e=this._outgoingAttacks.filter((e=>e.id()===t));e&&e[0]&&e[0].executeRetreat()}relinquish(t){if(this.mg.owner(t)!==this)throw new Error("Cannot relinquish tile not owned by this player");this.mg.relinquish(t)}info(){return this.playerInfo}isAlive(){return this._tiles.size>0}hasSpawned(){return this._hasSpawned}setHasSpawned(t){this._hasSpawned=t}incomingAllianceRequests(){return this.mg.allianceRequests.filter((t=>t.recipient()===this))}outgoingAllianceRequests(){return this.mg.allianceRequests.filter((t=>t.requestor()===this))}alliances(){return this.mg.alliances_.filter((t=>t.requestor()===this||t.recipient()===this))}expiredAlliances(){return[...this._expiredAlliances]}allies(){return this.alliances().map((t=>t.other(this)))}isAlliedWith(t){return t!==this&&null!==this.allianceWith(t)}allianceWith(t){return t===this?null:this.alliances().find((e=>e.recipient()===t||e.requestor()===t))??null}canSendAllianceRequest(t){if(t===this)return!1;if(this.isDisconnected()||t.isDisconnected())return!1;if(this.isFriendly(t)||!this.isAlive())return!1;if(this.outgoingAllianceRequests().some((e=>e.recipient()===t)))return!1;const e=this.pastOutgoingAllianceRequests.filter((e=>e.recipient()===t)).sort(((t,e)=>e.createdAt()-t.createdAt()));return 0===e.length||this.mg.ticks()-e[0].createdAt()>=this.mg.config().allianceRequestCooldown()}breakAlliance(t){this.mg.breakAlliance(this,t)}isTraitor(){return this.getTraitorRemainingTicks()>0}getTraitorRemainingTicks(){if(this.markedTraitorTick<0)return 0;const t=this.mg.ticks()-this.markedTraitorTick,e=this.mg.config().traitorDuration()-t;return e>0?e:0}markTraitor(){this.markedTraitorTick=this.mg.ticks(),this._betrayalCount++,this.mg.stats().betray(this)}betrayals(){return this._betrayalCount}createAllianceRequest(t){if(this.isAlliedWith(t))throw new Error("cannot create alliance request, already allies");return this.mg.createAllianceRequest(this,t)}relation(t){if(t===this)throw new Error(`cannot get relation with self: ${this}`);const e=this.relations.get(t)??0;return this.relationFromValue(e)}relationFromValue(t){return t<-50?U.Hostile:t<0?U.Distrustful:t<50?U.Neutral:U.Friendly}allRelationsSorted(){return Array.from(this.relations,(([t,e])=>({player:t,relation:e}))).sort(((t,e)=>t.relation-e.relation)).map((t=>({player:t.player,relation:this.relationFromValue(t.relation)})))}updateRelation(t,e){if(t===this)throw new Error(`cannot update relation with self: ${this}`);const i=s((this.relations.get(t)??0)+e,-100,100);this.relations.set(t,i)}decayRelations(){this.relations.forEach(((t,e)=>{t+=-1*Math.sign(t)*.05,Math.abs(t)<.1&&(t=0),this.relations.set(e,t)}))}canTarget(t){if(this===t)return!1;if(this.isFriendly(t))return!1;for(const t of this.targets_)if(this.mg.ticks()-t.tick<this.mg.config().targetCooldown())return!1;return!0}target(t){this.targets_.push({tick:this.mg.ticks(),target:t}),this.mg.target(this,t)}targets(){return this.targets_.filter((t=>this.mg.ticks()-t.tick<this.mg.config().targetDuration())).map((t=>t.target))}transitiveTargets(){const t=this.alliances().map((t=>t.other(this))).flatMap((t=>t.targets()));return t.push(...this.targets()),[...new Set(t)]}sendEmoji(t,e){if(t===this)throw Error(`Cannot send emoji to oneself: ${this}`);const i={message:e,senderID:this.smallID(),recipientID:t===f?t:t.smallID(),createdAt:this.mg.ticks()};this.outgoingEmojis_.push(i),this.mg.sendEmojiUpdate(i)}outgoingEmojis(){return this.outgoingEmojis_.filter((t=>this.mg.ticks()-t.createdAt<this.mg.config().emojiMessageDuration())).sort(((t,e)=>e.createdAt-t.createdAt))}canSendEmoji(t){if(t===this)return!1;const e=t===f?f:t.smallID(),i=this.outgoingEmojis_.filter((t=>t.recipientID===e));for(const t of i)if(this.mg.ticks()-t.createdAt<this.mg.config().emojiMessageCooldown())return!1;return!0}canDonateGold(t){if(!this.isAlive()||!t.isAlive()||!this.isFriendly(t))return!1;if(t.type()===F.Human&&!1===this.mg.config().donateGold())return!1;for(const e of this.sentDonations)if(e.recipient===t&&this.mg.ticks()-e.tick<this.mg.config().donateCooldown())return!1;return!0}canDonateTroops(t){if(!this.isAlive()||!t.isAlive()||!this.isFriendly(t))return!1;if(t.type()===F.Human&&!1===this.mg.config().donateTroops())return!1;for(const e of this.sentDonations)if(e.recipient===t&&this.mg.ticks()-e.tick<this.mg.config().donateCooldown())return!1;return!0}donateTroops(t,e){if(e<=0)return!1;const i=this.removeTroops(e);return 0!==i&&(t.addTroops(i),this.sentDonations.push(new Ci(t,this.mg.ticks())),this.mg.displayMessage(`Sent ${zt(e)} troops to ${t.name()}`,q.SENT_TROOPS_TO_PLAYER,this.id()),this.mg.displayMessage(`Received ${zt(e)} troops from ${this.name()}`,q.RECEIVED_TROOPS_FROM_PLAYER,t.id()),!0)}donateGold(t,e){if(e<=0n)return!1;const i=this.removeGold(e);return 0n!==i&&(t.addGold(i),this.sentDonations.push(new Ci(t,this.mg.ticks())),this.mg.displayMessage(`Sent ${Kt(e)} gold to ${t.name()}`,q.SENT_GOLD_TO_PLAYER,this.id()),this.mg.displayMessage(`Received ${Kt(e)} gold from ${this.name()}`,q.RECEIVED_GOLD_FROM_PLAYER,t.id(),e),!0)}canDeleteUnit(){return this.mg.ticks()-this.lastDeleteUnitTick>=this.mg.config().deleteUnitCooldown()}recordDeleteUnit(){this.lastDeleteUnitTick=this.mg.ticks()}canEmbargoAll(){if(this.mg.ticks()-this.lastEmbargoAllTick<this.mg.config().embargoAllCooldown())return!1;for(const t of this.mg.players())if(t.id()!==this.id()&&t.type()!==F.Bot&&!this.isOnSameTeam(t))return!0;return!1}recordEmbargoAll(){this.lastEmbargoAllTick=this.mg.ticks()}hasEmbargoAgainst(t){return this.embargoes.has(t.id())}canTrade(t){return!(t.hasEmbargoAgainst(this)||this.hasEmbargoAgainst(t))&&t.id()!==this.id()}getEmbargoes(){return[...this.embargoes.values()]}addEmbargo(t,e){const i=this.embargoes.get(t.id());(void 0===i||i.isTemporary)&&(this.mg.addUpdate({type:we.EmbargoEvent,event:"start",playerID:this.smallID(),embargoedID:t.smallID()}),this.embargoes.set(t.id(),{createdAt:this.mg.ticks(),isTemporary:e,target:t}))}stopEmbargo(t){this.embargoes.delete(t.id()),this.mg.addUpdate({type:we.EmbargoEvent,event:"stop",playerID:this.smallID(),embargoedID:t.smallID()})}endTemporaryEmbargo(t){const e=this.embargoes.get(t.id());(void 0===e||e.isTemporary)&&this.stopEmbargo(t)}tradingPartners(){return this.mg.players().filter((t=>t!==this&&this.canTrade(t)))}team(){return this._team}isOnSameTeam(t){return t!==this&&null!==this.team()&&null!==t.team()&&this.team()!==I&&t.team()!==I&&this._team===t.team()}isFriendly(t,e=!1){return!(t.isDisconnected()&&!e)&&(this.isOnSameTeam(t)||this.isAlliedWith(t))}gold(){return this._gold}addGold(t,e){this._gold+=t,e&&this.mg.addUpdate({type:we.BonusEvent,player:this.id(),tile:e,gold:Number(t),troops:0})}removeGold(t){if(t<=0n)return 0n;const e=g(this._gold,t);return this._gold-=e,e}troops(){return Number(this._troops)}addTroops(t){t<0?this.removeTroops(-1*t):this._troops+=d(t)}removeTroops(t){if(t<=0)return 0;const e=g(this._troops,d(t));return this._troops-=e,Number(e)}captureUnit(t){if(t.owner()===this)throw new Error(`Cannot capture unit, ${this} already owns ${t}`);t.setOwner(this)}buildUnit(t,e,i){if(this.mg.config().isUnitDisabled(t))throw new Error(`Attempted to build disabled unit ${t} at tile ${e} by player ${this.name()}`);const s=this.mg.unitInfo(t).cost(this),r=new ji(t,this.mg,e,this.mg.nextUnitID(),this,i);return this._units.push(r),this.recordUnitConstructed(t),this.removeGold(s),this.removeTroops("troops"in i?i.troops??0:0),this.mg.addUpdate(r.toUpdate()),this.mg.addUnit(r),r}findUnitToUpgrade(t,e){const i=this.mg.config().structureMinDist(),s=this.mg.nearbyUnits(e,i,t).sort(((t,e)=>t.distSquared-e.distSquared));if(0===s.length)return!1;const r=s[0].unit;return!!this.canUpgradeUnit(r)&&r}canUpgradeUnit(t){return!(t.isMarkedForDeletion()||!this.mg.config().unitInfo(t.type()).upgradable||this.mg.config().isUnitDisabled(t.type())||this._gold<this.mg.config().unitInfo(t.type()).cost(this)||t.owner()!==this)}upgradeUnit(t){const e=this.mg.unitInfo(t.type()).cost(this);this.removeGold(e),t.increaseLevel(),this.recordUnitConstructed(t.type())}buildableUnits(t){const e=null!==t?this.validStructureSpawnTiles(t):[];return Object.values(N).map((i=>{let s=!1;if(!this.mg.inSpawnPhase()){const e=null!==t&&this.findUnitToUpgrade(i,t);!1!==e&&(s=e.id())}return{type:i,canBuild:!this.mg.inSpawnPhase()&&null!==t&&this.canBuild(i,t,e),canUpgrade:s,cost:this.mg.config().unitInfo(i).cost(this)}}))}canBuild(t,e,i=null){if(this.mg.config().isUnitDisabled(t))return!1;const s=this.mg.unitInfo(t).cost(this);if(!this.isAlive()||this.gold()<s)return!1;switch(t){case N.MIRV:return!!this.mg.hasOwner(e)&&this.nukeSpawn(e);case N.AtomBomb:case N.HydrogenBomb:return this.nukeSpawn(e);case N.MIRVWarhead:return e;case N.Port:return this.portSpawn(e,i);case N.Warship:return this.warshipSpawn(e);case N.Shell:case N.SAMMissile:return e;case N.TransportShip:return function(t,e,i){if(e.unitCount(N.TransportShip)>=t.config().boatMaxNumber())return!1;const s=ci(t,i);if(null===s)return!1;const r=t.owner(i);if(r===e)return!1;if(r.isPlayer()&&e.isFriendly(r))return!1;if(t.isOceanShore(s)){let n=!1;for(const i of e.borderTiles())if(t.isOceanShore(i)){n=!0;break}let a=!1;if(t.hasOwner(i)){for(const e of r.borderTiles())if(t.isOceanShore(e)){a=!0;break}}else a=!0;return!(!n||!a)&&li(t,e,s)}const n=t.bfs(s,ue(ce(s,300),((e,i)=>t.isLake(i)||t.isShore(i)))),a=Array.from(n).sort(((e,i)=>t.manhattanDist(s,e)-t.manhattanDist(s,i)));for(const i of a)if(t.owner(i)===e)return li(t,e,i);return!1}(this.mg,this,e);case N.TradeShip:return this.tradeShipSpawn(e);case N.Train:return this.landBasedUnitSpawn(e);case N.MissileSilo:case N.DefensePost:case N.SAMLauncher:case N.City:case N.Factory:case N.Construction:return this.landBasedStructureSpawn(e,i);default:u(t)}}nukeSpawn(t){const e=this.mg.owner(t);if(e.isPlayer()&&this.isOnSameTeam(e))return!1;const i=this.units(N.MissileSilo).filter((t=>!t.isInCooldown())).sort(r(this.mg,t));return 0!==i.length&&i[0].tile()}portSpawn(t,e){const i=Array.from(this.mg.bfs(t,ce(t,this.mg.config().radiusPortSpawn()))).filter((t=>this.mg.owner(t)===this&&this.mg.isOceanShore(t))).sort(((e,i)=>this.mg.manhattanDist(e,t)-this.mg.manhattanDist(i,t))),s=new Set(e??this.validStructureSpawnTiles(t));for(const t of i)if(s.has(t))return t;return!1}warshipSpawn(t){if(!this.mg.isOcean(t))return!1;const e=this.units(N.Port).sort(((e,i)=>this.mg.manhattanDist(e.tile(),t)-this.mg.manhattanDist(i.tile(),t)));return 0!==e.length&&e[0].tile()}landBasedUnitSpawn(t){return!!this.mg.isLand(t)&&t}landBasedStructureSpawn(t,e=null){const i=e??this.validStructureSpawnTiles(t);return 0!==i.length&&i[0]}validStructureSpawnTiles(t){if(this.mg.owner(t)!==this)return[];const e=Object.values(N).filter((t=>this.mg.config().unitInfo(t).territoryBound)),i=this.mg.nearbyUnits(t,30,e),s=this.mg.bfs(t,((e,i)=>this.mg.euclideanDistSquared(t,i)<225&&e.ownerID(i)===this.smallID())),r=new Set(s),n=this.mg.config().structureMinDist()**2;for(const t of s)for(const{unit:e}of i)if(this.mg.euclideanDistSquared(e.tile(),t)<n){r.delete(t);break}const a=Array.from(r);return a.sort(((e,i)=>this.mg.euclideanDistSquared(e,t)-this.mg.euclideanDistSquared(i,t))),a}tradeShipSpawn(t){const e=this.units(N.Port).filter((e=>e.tile()===t));return 0!==e.length&&e[0].tile()}lastTileChange(){return this._lastTileChange}isDisconnected(){return this._isDisconnected}markDisconnected(t){this._isDisconnected=t}hash(){return n(this.id())*(this.troops()+this.numTilesOwned())+this._units.reduce(((t,e)=>t+e.hash()),0)}toString(){return`Player:{name:${this.info().name},clientID:${this.info().clientID},isAlive:${this.isAlive()},troops:${this._troops},numTileOwned:${this.numTilesOwned()}}]`}playerProfile(){return{relations:Object.fromEntries(this.allRelationsSorted().map((({player:t,relation:e})=>[t.smallID(),e]))),alliances:this.alliances().map((t=>t.other(this).smallID()))}}createAttack(t,e,i,s){const r=new Di(this._pseudo_random.nextID(),t,this,e,i,s,this.mg);return this._outgoingAttacks.push(r),t.isPlayer()&&t._incomingAttacks.push(r),r}outgoingAttacks(){return this._outgoingAttacks}incomingAttacks(){return this._incomingAttacks}canAttack(t){if(this.mg.hasOwner(t)&&this.mg.config().numSpawnPhaseTurns()+this.mg.config().spawnImmunityDuration()>this.mg.ticks())return!1;if(this.mg.owner(t)===this)return!1;const e=this.mg.owner(t);if(e.isPlayer()&&this.isFriendly(e))return!1;if(!this.mg.isLand(t))return!1;if(this.mg.hasOwner(t))return this.sharesBorderWith(e);for(const e of this.mg.bfs(t,ue(((t,e)=>!t.hasOwner(e)&&t.isLand(e)),ce(t,200))))for(const t of this.mg.neighbors(e))if(this.mg.owner(t)===this)return!0;return!1}bestTransportShipSpawn(t){return function(t,e,i){const s=ci(t,i);if(null===s)return!1;const r=function(t,e,i){let s=1/0,r=1/0,n=1/0,a=-1/0,o=-1/0,h=null;const l={minX:null,minY:null,maxX:null,maxY:null},c=Array.from(e.borderTiles()).filter((e=>t.isShore(e)));for(const e of c){const c=t.manhattanDist(e,i),u=t.cell(e);c<s&&(s=c,h=e),u.x<r?(r=u.x,l.minX=e):u.y<n?(n=u.y,l.minY=e):u.x>a?(a=u.x,l.maxX=e):u.y>o&&(o=u.y,l.maxY=e)}const u=Math.max(10,Math.ceil(c.length/50)),d=c.filter(((t,e)=>e%u===0));return[h,l.minX,l.minY,l.maxX,l.maxY,...d].filter(Boolean)}(t,e,s);if(0===r.length)return!1;const n=new Fe(t,t.miniMap(),r,s,1e6,1),a=n.compute();if(a!==Me.Completed)return console.warn(`bestShoreDeploymentSource: path not found: ${a}`),!1;const o=n.reconstructPath();if(0===o.length)return!1;const h=o[0],l=t.neighbors(h).filter((i=>t.isShore(i)&&t.owner(i)===e));return 0!==l.length&&l[0]}(this.mg,this,t)}}class Pi{constructor(t){this.railRoad=t,this.active=!0,this.headIndex=0,this.tailIndex=0,this.increment=3,this.railTiles=[],this.tailIndex=t.tiles.length}isActive(){return this.active}init(t,e){this.mg=t;const i=this.railRoad.tiles;this.railTiles.push({tile:i[0],railType:i.length>0?this.computeExtremityDirection(i[0],i[1]):be.VERTICAL});for(let t=1;t<i.length-1;t++){const e=this.computeDirection(i[t-1],i[t],i[t+1]);this.railTiles.push({tile:i[t],railType:e})}this.railTiles.push({tile:i[i.length-1],railType:i.length>0?this.computeExtremityDirection(i[i.length-1],i[i.length-2]):be.VERTICAL})}computeExtremityDirection(t,e){const i=this.mg.x(t),s=this.mg.y(t),r=this.mg.x(e)-i,n=this.mg.y(e)-s;return 0===r&&0===n||0===r?be.VERTICAL:0===n?be.HORIZONTAL:be.VERTICAL}computeDirection(t,e,i){if(null===this.mg)throw new Error("Not initialized");const s=this.mg.x(t),r=this.mg.y(t),n=this.mg.x(e),a=this.mg.y(e),o=n-s,h=a-r,l=this.mg.x(i)-n,c=this.mg.y(i)-a;if(o===l&&h===c){if(0!==o)return be.HORIZONTAL;if(0!==h)return be.VERTICAL}if(0===o&&0!==l||0!==o&&0===l){if(0===o&&1===l&&-1===h)return be.BOTTOM_RIGHT;if(0===o&&-1===l&&-1===h)return be.BOTTOM_LEFT;if(0===o&&1===l&&1===h)return be.TOP_RIGHT;if(0===o&&-1===l&&1===h)return be.TOP_LEFT;if(1===o&&0===l&&-1===c)return be.TOP_LEFT;if(-1===o&&0===l&&-1===c)return be.TOP_RIGHT;if(1===o&&0===l&&1===c)return be.BOTTOM_LEFT;if(-1===o&&0===l&&1===c)return be.BOTTOM_RIGHT}return console.warn(`Invalid rail segment: ${o}:${h}, ${l}:${c}`),be.VERTICAL}tick(t){if(null===this.mg)throw new Error("Not initialized");if(!this.activeSourceOrDestination())return void(this.active=!1);if(this.headIndex>this.tailIndex)return void this.constructionComplete();let e;this.tailIndex-this.headIndex<=2*this.increment?(e=this.railTiles.slice(this.headIndex,this.tailIndex),this.constructionComplete()):(e=this.railTiles.slice(this.headIndex,this.headIndex+this.increment),e=e.concat(this.railTiles.slice(this.tailIndex-this.increment,this.tailIndex)),this.headIndex+=this.increment,this.tailIndex-=this.increment),e&&this.mg.addUpdate({type:we.RailroadEvent,isActive:!0,railTiles:e})}activeDuringSpawnPhase(){return!1}activeSourceOrDestination(){return this.railRoad.from.isActive()&&this.railRoad.to.isActive()}constructionComplete(){this.redrawBuildings(),this.active=!1}redrawBuildings(){this.railRoad.from.unit.isActive()&&this.railRoad.from.unit.touch(),this.railRoad.to.unit.isActive()&&this.railRoad.to.unit.touch()}}class Ri{constructor(){this.stations=new Set}addStation(t){this.stations.add(t)}removeStation(t){this.stations.delete(t)}findStation(t){for(const e of this.stations)if(e.unit===t)return e;return null}getAll(){return this.stations}}class Ni{constructor(t){this.game=t}findTilePath(t,e){const i=new Fe(this.game.map(),this.game.miniMap(),t,e,5e3,20,!1,3);return i.compute()===Me.Completed?i.reconstructPath():[]}findStationsPath(t,e){const i=new Ue(t,e,5e3,20,new Se(this.game));return i.compute()===Me.Completed?i.reconstructPath():[]}}class Oi{constructor(t,e,i){this.game=t,this.stationManager=e,this.pathService=i,this.maxConnectionDistance=4}connectStation(t){this.stationManager.addStation(t),this.connectToNearbyStations(t)}removeStation(t){const e=this.stationManager.findStation(t);if(!e)return;const i=e.neighbors();this.disconnectFromNetwork(e),this.stationManager.removeStation(e);const s=e.getCluster();if(s){if(1===i.length)s.removeStation(e);else if(i.length>1)for(const t of i){const e=this.computeCluster(t);(new ke).addStations(e)}e.unit.setTrainStation(!1)}}findStationsPath(t,e){return this.pathService.findStationsPath(t,e)}connectToNearbyStations(t){const e=this.game.nearbyUnits(t.tile(),this.game.config().trainStationMaxRange(),[N.City,N.Factory,N.Port]),i=new Set;e.sort(((t,e)=>t.distSquared-e.distSquared));for(const s of e){if(s.unit===t.unit)continue;const e=this.stationManager.findStation(s.unit);if(!e)continue;const r=this.distanceFrom(e,t,this.maxConnectionDistance),n=e.getCluster();null!==n&&((r>this.maxConnectionDistance||-1===r)&&s.distSquared>this.game.config().trainStationMinRange()**2&&this.connect(t,e)&&(n.addStation(t),i.add(n)))}i.size>1?this.mergeClusters(i):0===i.size&&(new ke).addStation(t)}disconnectFromNetwork(t){for(const e of t.getRailroads())e.delete(this.game);t.clearRailroads();const e=t.getCluster();null!==e&&1===e.size()&&this.deleteCluster(e)}deleteCluster(t){for(const e of t.stations)e.setCluster(null);t.clear()}connect(t,e){const i=this.pathService.findTilePath(t.tile(),e.tile());if(i.length>0&&i.length<this.game.config().railroadMaxSize()){const s=new Ie(t,e,i);return this.game.addExecution(new Pi(s)),t.addRailroad(s),e.addRailroad(s),!0}return!1}distanceFrom(t,e,i){if(t===e)return 0;const s=new Set,r=[{station:t,distance:0}];for(;r.length>0;){const{station:t,distance:n}=r.shift();if(!(s.has(t)||(s.add(t),n>=i)))for(const i of t.neighbors()){if(i===e)return n+1;s.has(i)||r.push({station:i,distance:n+1})}}return-1}computeCluster(t){const e=new Set,i=[t];for(;i.length>0;){const t=i.shift();if(!e.has(t)){e.add(t);for(const s of t.neighbors())e.has(s)||i.push(s)}}return e}mergeClusters(t){const e=new ke;for(const i of t)e.merge(i)}}const Bi=Q.k5(["abomb","hbomb","mirv","mirvw"]),Ui={[N.AtomBomb]:"abomb",[N.HydrogenBomb]:"hbomb",[N.MIRV]:"mirv",[N.MIRVWarhead]:"mirvw"},Li=Q.k5(["trade","trans"]),Fi=Q.k5(["city","defp","port","wshp","silo","saml","fact"]),qi={[N.City]:"city",[N.DefensePost]:"defp",[N.MissileSilo]:"silo",[N.Port]:"port",[N.SAMLauncher]:"saml",[N.Warship]:"wshp",[N.Factory]:"fact"},$i=Q.vk((t=>"string"==typeof t&&/^-?\d+$/.test(t)?BigInt(t):t),Q.o()),Hi=$i.array().min(1);function Wi(t){switch(typeof t){case"bigint":return t;case"number":return BigInt(Math.floor(t))}}Q.Ik({attacks:Hi.optional(),betrayals:$i.optional(),killedAt:$i.optional(),conquests:$i.optional(),boats:Q.jg(Li,Hi).optional(),bombs:Q.jg(Bi,Hi).optional(),gold:Hi.optional(),units:Q.jg(Fi,Hi).optional()}).optional();class Vi{constructor(){this.data={}}getPlayerStats(t){const e=t.clientID();if(null!==e)return this.data[e]}stats(){return this.data}_makePlayerStats(t){const e=t.clientID();if(null===e)return;if(e in this.data)return this.data[e];const i={};return this.data[e]=i,i}_addAttack(t,e,i){const s=this._makePlayerStats(t);if(void 0!==s){for(s.attacks??(s.attacks=[0n]);s.attacks.length<=e;)s.attacks.push(0n);s.attacks[e]+=Wi(i)}}_addBetrayal(t,e){const i=this._makePlayerStats(t);void 0!==i&&(i.betrayals??(i.betrayals=0n),i.betrayals+=Wi(e))}_addBoat(t,e,i,s){var r;const n=this._makePlayerStats(t);if(void 0!==n){for(n.boats??(n.boats={[e]:[0n]}),(r=n.boats)[e]??(r[e]=[0n]);n.boats[e].length<=i;)n.boats[e].push(0n);n.boats[e][i]+=Wi(s)}}_addBomb(t,e,i,s){var r;const n=Ui[e],a=this._makePlayerStats(t);if(void 0!==a){for(a.bombs??(a.bombs={[n]:[0n]}),(r=a.bombs)[n]??(r[n]=[0n]);a.bombs[n].length<=i;)a.bombs[n].push(0n);a.bombs[n][i]+=Wi(s)}}_addGold(t,e,i){const s=this._makePlayerStats(t);if(void 0!==s){for(s.gold??(s.gold=[0n]);s.gold.length<=e;)s.gold.push(0n);s.gold[e]+=Wi(i)}}_addOtherUnit(t,e,i,s){var r;const n=qi[e],a=this._makePlayerStats(t);if(void 0!==a){for(a.units??(a.units={[n]:[0n]}),(r=a.units)[n]??(r[n]=[0n]);a.units[n].length<=i;)a.units[n].push(0n);a.units[n][i]+=Wi(s)}}_addConquest(t){const e=this._makePlayerStats(t);void 0!==e&&(void 0===e.conquests?e.conquests=Wi(1):e.conquests+=Wi(1))}_addPlayerKilled(t,e){const i=this._makePlayerStats(t);void 0!==i&&(i.killedAt=Wi(e))}attack(t,e,i){this._addAttack(t,0,i),e.isPlayer()&&this._addAttack(e,1,i)}attackCancel(t,e,i){this._addAttack(t,2,i),this._addAttack(t,0,-i),e.isPlayer()&&this._addAttack(e,1,-i)}betray(t){this._addBetrayal(t,1)}boatSendTrade(t,e){this._addBoat(t,"trade",0,1)}boatArriveTrade(t,e,i){this._addBoat(t,"trade",1,1),this._addGold(t,2,i),this._addGold(e,2,i)}boatCapturedTrade(t,e,i){this._addBoat(t,"trade",2,1),this._addGold(t,3,i)}boatDestroyTrade(t,e){this._addBoat(t,"trade",3,1)}boatSendTroops(t,e,i){this._addBoat(t,"trans",0,1)}boatArriveTroops(t,e,i){this._addBoat(t,"trans",1,1)}boatDestroyTroops(t,e,i){this._addBoat(t,"trans",3,1)}bombLaunch(t,e,i){this._addBomb(t,i,0,1)}bombLand(t,e,i){this._addBomb(t,i,1,1)}bombIntercept(t,e,i){this._addBomb(t,e,2,i)}goldWork(t,e){this._addGold(t,0,e)}goldWar(t,e,i){this._addGold(t,1,i),this._addConquest(t)}unitBuild(t,e){this._addOtherUnit(t,e,0,1)}unitCapture(t,e){this._addOtherUnit(t,e,2,1)}unitUpgrade(t,e){this._addOtherUnit(t,e,4,1)}unitDestroy(t,e){this._addOtherUnit(t,e,1,1)}unitLose(t,e){this._addOtherUnit(t,e,3,1)}playerKilled(t,e){this._addPlayerKilled(t,e)}}class Gi{constructor(){}smallID(){return 0}clientID(){return"TERRA_NULLIUS_CLIENT_ID"}id(){return null}isPlayer(){return!1}}class zi{constructor(t){this.gm=t,this.cellSize=100,this.grid=Array(Math.ceil(t.height()/this.cellSize)).fill(null).map((()=>Array(Math.ceil(t.width()/this.cellSize)).fill(null).map((()=>new Map))))}getGridCoords(t,e){return[Math.floor(t/this.cellSize),Math.floor(e/this.cellSize)]}addUnit(t){const e=t.tile(),[i,s]=this.getGridCoords(this.gm.x(e),this.gm.y(e));if(this.isValidCell(i,s)){const e=this.grid[s][i].get(t.type());void 0!==e?e.add(t):this.grid[s][i].set(t.type(),new Set([t]))}}removeUnit(t){const e=t.tile();this.removeUnitByTile(t,e)}removeUnitByTile(t,e){const[i,s]=this.getGridCoords(this.gm.x(e),this.gm.y(e));if(this.isValidCell(i,s)){const e=this.grid[s][i].get(t.type());void 0!==e&&e.delete(t)}}updateUnitCell(t){const e=t.tile(),i=t.lastTile(),[s,r]=this.getGridCoords(this.gm.x(i),this.gm.y(i)),[n,a]=this.getGridCoords(this.gm.x(e),this.gm.y(e));s===n&&r===a||(this.removeUnitByTile(t,i),this.addUnit(t))}isValidCell(t,e){return t>=0&&t<this.grid[0].length&&e>=0&&e<this.grid.length}getCellsInRange(t,e){const i=this.gm.x(t),s=this.gm.y(t),r=this.cellSize,[n,a]=this.getGridCoords(i,s);return{startGridX:Math.max(0,n-Math.ceil((e-i%r)/r)),endGridX:Math.min(this.grid[0].length-1,n+Math.ceil((e-(r-i%r))/r)),startGridY:Math.max(0,a-Math.ceil((e-s%r)/r)),endGridY:Math.min(this.grid.length-1,a+Math.ceil((e-(r-s%r))/r))}}squaredDistanceFromTile(t,e){const i=this.gm.x(e),s=this.gm.y(e),r=this.gm.x(t.tile())-i,n=this.gm.y(t.tile())-s;return r*r+n*n}nearbyUnits(t,e,i,s){const r=[],{startGridX:n,endGridX:a,startGridY:o,endGridY:h}=this.getCellsInRange(t,e),l=e*e,c=Array.isArray(i)?new Set(i):new Set([i]);for(let e=o;e<=h;e++)for(let i=n;i<=a;i++)for(const n of c){const a=this.grid[e][i].get(n);if(void 0!==a)for(const e of a){if(!e.isActive())continue;const i=this.squaredDistanceFromTile(e,t);if(i>l)continue;const n={unit:e,distSquared:i};(void 0===s||s(n))&&r.push(n)}}return r}unitIsInRange(t,e,i,s){return!!t.isActive()&&((void 0===s||t.owner().id()===s)&&this.squaredDistanceFromTile(t,e)<=i)}hasUnitNearby(t,e,i,s){const{startGridX:r,endGridX:n,startGridY:a,endGridY:o}=this.getCellsInRange(t,e),h=e*e;for(let e=a;e<=o;e++)for(let a=r;a<=n;a++){const r=this.grid[e][a].get(i);if(void 0!==r)for(const e of r)if(this.unitIsInRange(e,t,h,s))return!0}return!1}}class Ki{constructor(t,e,i,s,r,n){this._humans=t,this._nations=e,this._map=i,this.miniGameMap=s,this._config=r,this._stats=n,this._ticks=0,this.unInitExecs=[],this._players=new Map,this._playersBySmallID=[],this.execs=[],this.allianceRequests=[],this.alliances_=[],this.nextPlayerID=1,this._nextUnitID=1,this.updates=Yi(),this.botTeam=I,this._railNetwork=function(t){const e=new Ri,i=new Ni(t);return new Oi(t,e,i)}(this),this.nextAllianceID=0,this._terraNullius=new Gi,this._width=i.width(),this._height=i.height(),this.unitGrid=new zi(this._map),r.gameConfig().gameMode===P.Team&&this.populateTeams(),this.addPlayers()}populateTeams(){let t=this._config.playerTeams();if(t!==T){if("number"!=typeof t){const e=this._humans.length+this._nations.length;switch(t){case w:t=Math.ceil(e/2);break;case b:t=Math.ceil(e/3);break;case M:t=Math.ceil(e/4);break;default:throw new Error(`Unknown TeamCountConfig ${t}`)}}if(t<2)throw new Error(`Too few teams: ${t}`);if(t<8)this.playerTeams=["Red",_],t>=3&&this.playerTeams.push(S),t>=4&&this.playerTeams.push(E),t>=5&&this.playerTeams.push(A),t>=6&&this.playerTeams.push(k),t>=7&&this.playerTeams.push(v);else{this.playerTeams=[];for(let e=1;e<=t;e++)this.playerTeams.push(`Team ${e}`)}}else this.playerTeams=[D,j]}addPlayers(){if(this.config().gameConfig().gameMode===P.FFA)return this._humans.forEach((t=>this.addPlayer(t))),void this._nations.forEach((t=>this.addPlayer(t.playerInfo)));if(this._config.playerTeams()===T)return this._humans.forEach((t=>this.addPlayer(t,D))),void this._nations.forEach((t=>this.addPlayer(t.playerInfo,j)));const t=function(t,e){const i=new Map,s=new Map,r=new Map,a=[];for(const e of t)e.clan?(r.has(e.clan)||r.set(e.clan,[]),r.get(e.clan).push(e)):a.push(e);const o=Math.ceil(t.length/e.length),h=Array.from(r.entries()).sort(((t,e)=>e[1].length-t[1].length));for(const[t,r]of h){let t=null,n=0;for(const i of e){const e=s.get(i)??0;null!==t&&n<=e||(n=e,t=i)}if(null!==t){for(const e of r)n<o?(n++,i.set(e,t)):i.set(e,"kicked");s.set(t,n)}}let l=a.filter((t=>t.playerType===F.FakeHuman));l.length>0&&(l=new it(n(l[0].id)).shuffleArray(l));const c=a.filter((t=>t.playerType!==F.FakeHuman));for(const t of c.concat(l)){let r=null,n=0;for(const t of e){const e=s.get(t)??0;null!==r&&n<=e||(n=e,r=t)}null!==r&&(s.set(r,n+1),i.set(t,r))}return i}([...this._humans,...this._nations.map((t=>t.playerInfo))],this.playerTeams);for(const[e,i]of t.entries())"kicked"!==i?this.addPlayer(e,i):console.warn(`Player ${e.name} was kicked from team`)}isOnEdgeOfMap(t){return this._map.isOnEdgeOfMap(t)}owner(t){return this.playerBySmallID(this.ownerID(t))}alliances(){return this.alliances_}playerBySmallID(t){return 0===t?this.terraNullius():this._playersBySmallID[t-1]}map(){return this._map}miniMap(){return this.miniGameMap}addUpdate(t){this.updates[t.type].push(t)}nextUnitID(){const t=this._nextUnitID;return this._nextUnitID++,t}setFallout(t,e){if(e&&this.hasOwner(t))throw Error(`cannot set fallout, tile ${t} has owner`);this._map.hasFallout(t)||(this._map.setFallout(t,e),this.addUpdate({type:we.Tile,update:this.toTileUpdate(t)}))}units(...t){return Array.from(this._players.values()).flatMap((e=>e.units(...t)))}unitCount(t){let e=0;for(const i of this._players.values())e+=i.unitCount(t);return e}unitInfo(t){return this.config().unitInfo(t)}nations(){return this._nations}createAllianceRequest(t,e){if(t.isAlliedWith(e))return console.log("cannot request alliance, already allied"),null;if(void 0!==e.incomingAllianceRequests().find((e=>e.requestor()===t)))return console.log(`duplicate alliance request from ${t.name()}`),null;const i=t.incomingAllianceRequests().find((t=>t.requestor()===e));if(void 0!==i)return console.log("got corresponding alliance requests, accepting"),i.accept(),null;const s=new Ai(t,e,this._ticks,this);return this.allianceRequests.push(s),this.addUpdate(s.toUpdate()),s}acceptAllianceRequest(t){this.allianceRequests=this.allianceRequests.filter((e=>e!==t));const e=t.requestor(),i=t.recipient();if(e.allianceWith(i))throw new Error(`cannot accept alliance request, already allied with ${i.name()}`);const s=new vi(this,e,i,this._ticks,this.nextAllianceID++);this.alliances_.push(s),t.requestor().pastOutgoingAllianceRequests.push(t),e.hasEmbargoAgainst(i)&&e.endTemporaryEmbargo(i),i.hasEmbargoAgainst(e)&&i.endTemporaryEmbargo(e),this.addUpdate({type:we.AllianceRequestReply,request:t.toUpdate(),accepted:!0})}rejectAllianceRequest(t){this.allianceRequests=this.allianceRequests.filter((e=>e!==t)),t.requestor().pastOutgoingAllianceRequests.push(t),this.addUpdate({type:we.AllianceRequestReply,request:t.toUpdate(),accepted:!1})}hasPlayer(t){return this._players.has(t)}config(){return this._config}inSpawnPhase(){return this._ticks<=this.config().numSpawnPhaseTurns()}ticks(){return this._ticks}executeNextTick(){this.updates=Yi(),this.execs.forEach((t=>{this.inSpawnPhase()&&!t.activeDuringSpawnPhase()||!t.isActive()||t.tick(this._ticks)}));const t=[],e=[];this.unInitExecs.forEach((i=>{!this.inSpawnPhase()||i.activeDuringSpawnPhase()?(i.init(this,this._ticks),t.push(i)):e.push(i)})),this.removeInactiveExecutions(),this.execs.push(...t),this.unInitExecs=e;for(const t of this._players.values())this.addUpdate(t.toUpdate());return this.ticks()%10==0&&this.addUpdate({type:we.Hash,tick:this.ticks(),hash:this.hash()}),this._ticks++,this.updates}hash(){let t=1;return this._players.forEach((e=>{t+=e.hash()})),t}terraNullius(){return this._terraNullius}removeInactiveExecutions(){const t=[];for(const e of this.execs)this.inSpawnPhase()?e.activeDuringSpawnPhase()?e.isActive()&&t.push(e):t.push(e):e.isActive()&&t.push(e);this.execs=t}players(){return Array.from(this._players.values()).filter((t=>t.isAlive()))}allPlayers(){return Array.from(this._players.values())}executions(){return[...this.execs,...this.unInitExecs]}addExecution(...t){this.unInitExecs.push(...t)}removeExecution(t){this.execs=this.execs.filter((e=>e!==t)),this.unInitExecs=this.unInitExecs.filter((e=>e!==t))}playerView(t){return this.player(t)}addPlayer(t,e=null){const i=new xi(this,this.nextPlayerID,t,this.config().startManpower(t),e??this.maybeAssignTeam(t));return this._playersBySmallID.push(i),this.nextPlayerID++,this._players.set(t.id,i),i}maybeAssignTeam(t){if(this._config.gameConfig().gameMode!==P.Team)return null;if(t.playerType===F.Bot)return this.botTeam;const e=n(t.id);return this.playerTeams[e%this.playerTeams.length]}player(t){const e=this._players.get(t);if(void 0===e)throw new Error(`Player with id ${t} not found`);return e}playerByClientID(t){for(const[,e]of this._players)if(e.clientID()===t)return e;return null}isOnMap(t){return t.x>=0&&t.x<this._width&&t.y>=0&&t.y<this._height}neighborsWithDiag(t){const e=this.x(t),i=this.y(t),s=[];for(let t=-1;t<=1;t++)for(let r=-1;r<=1;r++){if(0===t&&0===r)continue;const n=e+t,a=i+r;n>=0&&n<this._width&&a>=0&&a<this._height&&s.push(this._map.ref(n,a))}return s}conquer(t,e){if(!this.isLand(e))throw Error("cannot conquer water");const i=this.owner(e);i.isPlayer()&&(i._lastTileChange=this._ticks,i._tiles.delete(e),i._borderTiles.delete(e)),this._map.setOwnerID(e,t.smallID()),t._tiles.add(e),t._lastTileChange=this._ticks,this.updateBorders(e),this._map.setFallout(e,!1),this.addUpdate({type:we.Tile,update:this.toTileUpdate(e)})}relinquish(t){if(!this.hasOwner(t))throw new Error("Cannot relinquish tile because it is unowned");if(this.isWater(t))throw new Error("Cannot relinquish water");const e=this.owner(t);e._lastTileChange=this._ticks,e._tiles.delete(t),e._borderTiles.delete(t),this._map.setOwnerID(t,0),this.updateBorders(t),this.addUpdate({type:we.Tile,update:this.toTileUpdate(t)})}updateBorders(t){const e=[];e.push(t),this.neighbors(t).forEach((t=>e.push(t)));for(const t of e)this.hasOwner(t)&&(this.calcIsBorder(t)?this.owner(t)._borderTiles.add(t):this.owner(t)._borderTiles.delete(t))}calcIsBorder(t){if(!this.hasOwner(t))return!1;for(const e of this.neighbors(t))if(this.owner(t)!==this.owner(e))return!0;return!1}target(t,e){this.addUpdate({type:we.TargetPlayer,playerID:t.smallID(),targetID:e.smallID()})}breakAlliance(t,e){let i;if(i=e.requestor()===t?e.recipient():e.requestor(),!t.isAlliedWith(i))throw new Error(`${t} not allied with ${i}, cannot break alliance`);i.isTraitor()||i.isDisconnected()||t.markTraitor();const s=new Set(t.alliances()),r=i.alliances().filter((t=>s.has(t)));if(1!==r.length)throw new Error(`must have exactly one alliance, have ${r.length}`);this.alliances_=this.alliances_.filter((t=>t!==r[0])),this.addUpdate({type:we.BrokeAlliance,traitorID:t.smallID(),betrayedID:i.smallID()})}expireAlliance(t){const e=new Set(t.recipient().alliances()),i=t.requestor().alliances().filter((t=>e.has(t)));if(1!==i.length)throw new Error(`cannot expire alliance: must have exactly one alliance, have ${i.length}`);this.alliances_=this.alliances_.filter((t=>t!==i[0])),this.addUpdate({type:we.AllianceExpired,player1ID:t.requestor().smallID(),player2ID:t.recipient().smallID()})}sendEmojiUpdate(t){this.addUpdate({type:we.Emoji,emoji:t})}setWinner(t,e){this.addUpdate({type:we.Win,winner:this.makeWinner(t),allPlayersStats:e})}makeWinner(t){if("string"==typeof t)return["team",t,...this.players().filter((e=>e.team()===t&&null!==e.clientID())).map((t=>t.clientID()))];{const e=t.clientID();if(null===e)return;return["player",e]}}teams(){return this._config.gameConfig().gameMode!==P.Team?[]:[this.botTeam,...this.playerTeams]}displayMessage(t,e,i,s,r){let n=null;null!==i&&(n=this.player(i).smallID()),this.addUpdate({type:we.DisplayEvent,messageType:e,message:t,playerID:n,goldAmount:s,params:r})}displayChat(t,e,i,s,r,n){let a=null;null!==s&&(a=this.player(s).smallID()),this.addUpdate({type:we.DisplayChatEvent,key:t,category:e,target:i,playerID:a,isFrom:r,recipient:n})}displayIncomingUnit(t,e,i,s){const r=this.player(s).smallID();this.addUpdate({type:we.UnitIncoming,unitID:t,message:e,messageType:i,playerID:r})}addUnit(t){this.unitGrid.addUnit(t)}removeUnit(t){this.unitGrid.removeUnit(t),t.hasTrainStation()&&this._railNetwork.removeStation(t)}updateUnitTile(t){this.unitGrid.updateUnitCell(t)}hasUnitNearby(t,e,i,s){return this.unitGrid.hasUnitNearby(t,e,i,s)}nearbyUnits(t,e,i,s){return this.unitGrid.nearbyUnits(t,e,i,s)}ref(t,e){return this._map.ref(t,e)}isValidRef(t){return this._map.isValidRef(t)}x(t){return this._map.x(t)}y(t){return this._map.y(t)}cell(t){return this._map.cell(t)}width(){return this._map.width()}height(){return this._map.height()}numLandTiles(){return this._map.numLandTiles()}isValidCoord(t,e){return this._map.isValidCoord(t,e)}isLand(t){return this._map.isLand(t)}isOceanShore(t){return this._map.isOceanShore(t)}isOcean(t){return this._map.isOcean(t)}isShoreline(t){return this._map.isShoreline(t)}magnitude(t){return this._map.magnitude(t)}ownerID(t){return this._map.ownerID(t)}hasOwner(t){return this._map.hasOwner(t)}setOwnerID(t,e){return this._map.setOwnerID(t,e)}hasFallout(t){return this._map.hasFallout(t)}isBorder(t){return this._map.isBorder(t)}neighbors(t){return this._map.neighbors(t)}isWater(t){return this._map.isWater(t)}isLake(t){return this._map.isLake(t)}isShore(t){return this._map.isShore(t)}cost(t){return this._map.cost(t)}terrainType(t){return this._map.terrainType(t)}forEachTile(t){return this._map.forEachTile(t)}manhattanDist(t,e){return this._map.manhattanDist(t,e)}euclideanDistSquared(t,e){return this._map.euclideanDistSquared(t,e)}bfs(t,e){return this._map.bfs(t,e)}toTileUpdate(t){return this._map.toTileUpdate(t)}updateTile(t){return this._map.updateTile(t)}numTilesWithFallout(){return this._map.numTilesWithFallout()}stats(){return this._stats}railNetwork(){return this._railNetwork}conquerPlayer(t,e){if(e.isDisconnected()&&t.isOnSameTeam(e)){const i=e.units().filter((t=>t.type()===N.Warship||t.type()===N.TransportShip));for(const e of i)t.captureUnit(e)}const i=e.gold();this.displayMessage(`Conquered ${e.displayName()} received ${Kt(i)} gold`,q.CONQUERED_PLAYER,t.id(),i),t.addGold(i),e.removeGold(i),this.addUpdate({type:we.ConquestEvent,conquerorId:t.id(),conqueredId:e.id(),gold:i}),this.stats().goldWar(t,e,i)}}const Yi=()=>{const t={};return Object.values(we).filter((t=>!isNaN(Number(t)))).forEach((e=>{t[e]=[]})),t},Xi=new Map;async function Qi(t,e){if(e.length!==t.width*t.height)throw new Error(`Invalid data: buffer size ${e.length} incorrect for ${t.width}x${t.height} terrain plus 4 bytes for dimensions.`);return new he(t.width,t.height,e,t.num_land_tiles)}async function Ji(t,e,i,s){const r=await $t(t.config,null),a=await async function(t,e,i){const s=Xi.get(t);if(void 0!==s)return s;const r=i.getMapData(t),n=await r.manifest(),a=e===R.Normal?await Qi(n.map,await r.mapBin()):await Qi(n.map4x,await r.map4xBin()),o=e===R.Normal?await Qi(e===R.Normal?n.map4x:n.map16x,await r.map4xBin()):await Qi(n.map16x,await r.map16xBin());e===R.Compact&&n.nations.forEach((t=>{t.coordinates=[Math.floor(t.coordinates[0]/2),Math.floor(t.coordinates[1]/2)]}));const h={nations:n.nations,gameMap:a,miniGameMap:o};return Xi.set(t,h),h}(t.config.gameMap,t.config.gameMapSize,i),o=new it(n(t.gameID)),h=function(t,e,i,s,r){const n=new Vi;return new Ki(t,e,i,s,r,n)}(t.players.map((t=>{return new z(t.clientID===e?c(t.username):function(t){return ki.hasMatch(t)}(i=c(t.username))?Ii[n(i)%Ii.length]:i,F.Human,t.clientID,o.nextID());var i})),t.config.disableNPCs?[]:a.nations.map((t=>new V(new G(t.coordinates[0],t.coordinates[1]),t.strength,new z(t.name,F.FakeHuman,null,o.nextID())))),a.gameMap,a.miniGameMap,r),l=new Zi(h,new Ti(h,t.gameID,e),s);return l.init(),l}class Zi{constructor(t,e,i){this.game=t,this.execManager=e,this.callBack=i,this.turns=[],this.currTurn=0,this.isExecuting=!1,this.playerViewData={}}init(){this.game.config().bots()>0&&this.game.addExecution(...this.execManager.spawnBots(this.game.config().numBots())),this.game.config().spawnNPCs()&&this.game.addExecution(...this.execManager.fakeHumanExecutions()),this.game.addExecution(new _i)}addTurn(t){this.turns.push(t)}executeNextTick(){if(this.isExecuting)return;if(this.currTurn>=this.turns.length)return;let t;this.isExecuting=!0,this.game.addExecution(...this.execManager.createExecs(this.turns[this.currTurn])),this.currTurn++;let e=0;try{const i=performance.now();t=this.game.executeNextTick(),e=performance.now()-i}catch(t){return void(t instanceof Error?(console.error("Game tick error:",t.message),this.callBack({errMsg:t.message,stack:t.stack})):console.error("Game tick error:",t))}this.game.inSpawnPhase()&&this.game.ticks()%2==0&&this.game.players().filter((t=>t.type()===F.Human||t.type()===F.FakeHuman)).forEach((t=>this.playerViewData[t.id()]=Y(this.game,t))),(this.game.ticks()<3||this.game.ticks()%30==0)&&this.game.players().forEach((t=>{this.playerViewData[t.id()]=Y(this.game,t)}));const i=t[we.Tile].map((t=>t.update));t[we.Tile]=[],this.callBack({tick:this.game.ticks(),packedTileUpdates:new BigUint64Array(i),updates:t,playerNameViewData:this.playerViewData,tickExecutionDuration:e}),this.isExecuting=!1}playerActions(t,e,i){const s=this.game.player(t),r=void 0!==e&&void 0!==i?this.game.ref(e,i):null,n={canAttack:null!==r&&s.canAttack(r),buildableUnits:s.buildableUnits(r),canSendEmojiAllPlayers:s.canSendEmoji(f),canEmbargoAll:s.canEmbargoAll()};if(null!==r&&this.game.hasOwner(r)){const t=this.game.owner(r);n.interaction={sharedBorder:s.sharesBorderWith(t),canSendEmoji:s.canSendEmoji(t),canTarget:s.canTarget(t),canSendAllianceRequest:s.canSendAllianceRequest(t),canBreakAlliance:s.isAlliedWith(t),canDonateGold:s.canDonateGold(t),canDonateTroops:s.canDonateTroops(t),canEmbargo:!s.hasEmbargoAgainst(t)};const e=s.allianceWith(t);e&&(n.interaction.allianceExpiresAt=e.expiresAt())}return n}playerProfile(t){const e=this.game.playerBySmallID(t);if(!e.isPlayer())throw new Error(`player with id ${t} not found`);return e.playerProfile()}playerBorderTiles(t){const e=this.game.player(t);if(!e.isPlayer())throw new Error(`player with id ${t} not found`);return{borderTiles:e.borderTiles()}}attackAveragePosition(t,e){const i=this.game.playerBySmallID(t);if(!i.isPlayer())throw new Error(`player with id ${t} not found`);const s=t=>t.id()===e,r=i.outgoingAttacks().find(s)??i.incomingAttacks().find(s);return void 0===r?null:r.averagePosition()}bestTransportShipSpawn(t,e){const i=this.game.player(t);if(!i.isPlayer())throw new Error(`player with id ${t} not found`);return i.bestTransportShipSpawn(e)}}const ts=self;let es=null;const is=new class{constructor(t,e){this.prefix=t,this.cacheBuster=e,this.maps=new Map}getMapData(t){const e=this.maps.get(t);if(e)return e;const i=Object.keys(C).find((e=>C[e]===t)),s=i?.toLowerCase();if(!s)throw new Error(`Unknown map: ${t}`);const r={mapBin:()=>this.loadBinaryFromUrl(this.url(s,"map.bin")),map4xBin:()=>this.loadBinaryFromUrl(this.url(s,"map4x.bin")),map16xBin:()=>this.loadBinaryFromUrl(this.url(s,"map16x.bin")),manifest:()=>this.loadJsonFromUrl(this.url(s,"manifest.json")),webpPath:async()=>this.url(s,"thumbnail.webp")};return this.maps.set(t,r),r}url(t,e){let i=`${this.prefix}/${t}/${e}`;return this.cacheBuster&&(i+=`${i.includes("?")?"&":"?"}v=${this.cacheBuster}`),i}async loadBinaryFromUrl(t){const e=await fetch(t);if(!e.ok)throw new Error(`Failed to load ${t}: ${e.statusText}`);const i=await e.arrayBuffer();return new Uint8Array(i)}async loadJsonFromUrl(t){const e=await fetch(t);if(!e.ok)throw new Error(`Failed to load ${t}: ${e.statusText}`);return e.json()}}("/maps","EXPERIMENTAL BUILD\r\nFOR INTERNAL USE ONLY\r\n");function ss(t){"updates"in t&&rs({type:"game_update",gameUpdate:t})}function rs(t){ts.postMessage(t)}ts.addEventListener("message",(async t=>{const e=t.data;switch(e.type){case"heartbeat":(await es)?.executeNextTick();break;case"init":try{es=Ji(e.gameStartInfo,e.clientID,is,ss).then((t=>(rs({type:"initialized",id:e.id}),t)))}catch(t){throw console.error("Failed to initialize game runner:",t),t}break;case"turn":if(!es)throw new Error("Game runner not initialized");try{const t=await es;await t.addTurn(e.turn)}catch(t){throw console.error("Failed to process turn:",t),t}break;case"player_actions":if(!es)throw new Error("Game runner not initialized");try{const t=(await es).playerActions(e.playerID,e.x,e.y);rs({type:"player_actions_result",id:e.id,result:t})}catch(t){throw console.error("Failed to check borders:",t),t}break;case"player_profile":if(!es)throw new Error("Game runner not initialized");try{const t=(await es).playerProfile(e.playerID);rs({type:"player_profile_result",id:e.id,result:t})}catch(t){throw console.error("Failed to check borders:",t),t}break;case"player_border_tiles":if(!es)throw new Error("Game runner not initialized");try{const t=(await es).playerBorderTiles(e.playerID);rs({type:"player_border_tiles_result",id:e.id,result:t})}catch(t){throw console.error("Failed to get border tiles:",t),t}break;case"attack_average_position":if(!es)throw new Error("Game runner not initialized");try{const t=(await es).attackAveragePosition(e.playerID,e.attackID);rs({type:"attack_average_position_result",id:e.id,x:t?t.x:null,y:t?t.y:null})}catch(t){throw console.error("Failed to get attack average position:",t),t}break;case"transport_ship_spawn":if(!es)throw new Error("Game runner not initialized");try{const t=(await es).bestTransportShipSpawn(e.playerID,e.targetTile);rs({type:"transport_ship_spawn_result",id:e.id,result:t})}catch(t){console.error("Failed to spawn transport ship:",t)}break;default:console.warn("Unknown message :",e)}})),ts.addEventListener("error",(t=>{console.error("Worker error:",t)})),ts.addEventListener("unhandledrejection",(t=>{console.error("Unhandled promise rejection in worker:",t)}))}},s={};function r(t){var e=s[t];if(void 0!==e)return e.exports;var n=s[t]={id:t,loaded:!1,exports:{}};return i[t].call(n.exports,n,n.exports,r),n.loaded=!0,n.exports}r.m=i,r.x=()=>{var t=r.O(void 0,[96],(()=>r(80552)));return r.O(t)},r.amdD=function(){throw new Error("define cannot be used indirect")},r.amdO={},t=[],r.O=(e,i,s,n)=>{if(!i){var a=1/0;for(c=0;c<t.length;c++){for(var[i,s,n]=t[c],o=!0,h=0;h<i.length;h++)(!1&n||a>=n)&&Object.keys(r.O).every((t=>r.O[t](i[h])))?i.splice(h--,1):(o=!1,n<a&&(a=n));if(o){t.splice(c--,1);var l=s();void 0!==l&&(e=l)}}return e}n=n||0;for(var c=t.length;c>0&&t[c-1][2]>n;c--)t[c]=t[c-1];t[c]=[i,s,n]},r.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return r.d(e,{a:e}),e},r.d=(t,e)=>{for(var i in e)r.o(e,i)&&!r.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},r.f={},r.e=t=>Promise.all(Object.keys(r.f).reduce(((e,i)=>(r.f[i](t,e),e)),[])),r.u=t=>"js/vendors.3d26e67ee769e91382ce.js",r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.nmd=t=>(t.paths=[],t.children||(t.children=[]),t),r.j=809,r.p="/",(()=>{var t={809:1};r.f.i=(e,i)=>{t[e]||importScripts(r.p+r.u(e))};var e=self.webpackChunkopenfront_client=self.webpackChunkopenfront_client||[],i=e.push.bind(e);e.push=e=>{var[s,n,a]=e;for(var o in n)r.o(n,o)&&(r.m[o]=n[o]);for(a&&a(r);s.length;)t[s.pop()]=1;i(e)}})(),r.nc=void 0,e=r.x,r.x=()=>r.e(96).then(e),r.x()})();